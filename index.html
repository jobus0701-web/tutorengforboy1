<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文學習遊戲樂園-1</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 定義可愛的卡通字體，使用 Inter 搭配圓角和粗體營造童趣感 */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* 游標閃爍動畫 */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* 按鈕基礎樣式 */
        .key-btn {
            height: 50px; /* Base height */
            transition: all 0.1s;
            text-transform: none; /* 預設為小寫/正常 */
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        /* 特別針對按鈕元素中的文字強制使用小寫 (除非特別重寫) */
        button.key-btn {
            text-transform: lowercase;
        }
        /* 計算機按鍵維持原樣 */
        .calc-key {
            text-transform: none !important;
        }


        /* Game 2: 記憶卡片 */
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important;
            border-color: #3CB371 !important;
            color: #1E40AF !important;
            cursor: default;
        }
        /* Game 2 顏色覆蓋 */
        .card-type-phonics {
            background-color: #FFEC99; /* Accent Yellow */
            border-color: #FFD700;
        }
        .card-type-word {
            background-color: #BDE0FE; /* Secondary Blue */
            border-color: #89CFF0;
        }


        /* Game 4: Bingo */
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
            text-transform: lowercase; /* 賓果卡片預設為小寫 */
        }
        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        
        /* Game 5: 問句重組大師 */
        .word-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            height: 45px;
            padding: 0 10px;
            margin: 5px;
            background-color: #FFC7C7; 
            border: 3px solid #FF8FAB;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 3px 0 0 #D1A3A3;
            text-transform: none; /* 詞塊將由 JS 處理大小寫 */
        }
        
        /* 修正 Game 5 答案區塊，確保詞塊間隔 (關鍵修正) */
        .g5-answer-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* 增加詞塊間的間隔 */
        }
        .answer-slot {
            min-width: 80px;
            height: 50px;
            padding: 5px;
            border: 3px dashed #BDE0FE;
            border-radius: 10px;
            background-color: #F0F8FF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #4A5568;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .answer-slot.incorrect {
            animation: shake 0.3s 2;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* Game 6, 7, 8: 配對與拖曳底座 */
        .image-target {
            min-height: 120px;
            background-color: #fff;
            border: 3px solid #FF8FAB;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .drag-source {
            cursor: grab;
            user-select: none;
            box-shadow: 0 3px 0 0 #D1A3A3;
            transition: transform 0.1s;
        }
        .drag-source:active {
            cursor: grabbing;
            box-shadow: 0 1px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        .drag-area {
            border: 3px dashed #BDE0FE;
            border-radius: 12px;
            min-height: 150px;
            padding: 10px;
        }
        
        /* Game 8 專用樣式 */
        .digraph-display-box {
            min-width: 150px;
            min-height: 100px;
            background-color: #f0f0f0;
            border: 5px solid #FF8FAB;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .digraph-letter-part {
            font-size: 4rem;
            font-weight: 900;
            color: #1E40AF; /* 深藍色 */
        }
        .digraph-blank {
            width: 80px;
            height: 80px;
            background-color: #FFEC99;
            border: 4px dashed #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #D1A3A3;
        }
        /* Game 7 Calculator Styles */
        .calc-display {
            background-color: #2c3e50; /* 深藍灰色 */
            color: #ffffff;
            text-align: right;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            font-size: 3rem;
            font-weight: 700;
            font-family: monospace;
            overflow-x: auto;
            white-space: nowrap;
        }
        .calc-key {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.1s;
        }
        .calc-key-number {
            background-color: #ecf0f1; /* 淺灰色 */
            color: #2c3e50;
        }
        .calc-key-operator {
            background-color: #f39c12; /* 橘色 */
            color: white;
        }
        .calc-key-clear {
            background-color: #e74c3c; /* 紅色 */
            color: white;
        }
        .calc-key-equal {
            background-color: #2ecc71; /* 綠色 */
            color: white;
        }
        /* Game 6 物品名稱和 Game 7 提示欄強制小寫 */
        .item-name-display {
            text-transform: lowercase;
        }

    </style>

    <script>
        // 設定 Tailwind 配置, 使用柔和可愛的馬卡龍配色
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      
                        'secondary-blue': '#BDE0FE',    
                        'accent-yellow': '#FFEC99',     
                        'background-light': '#F8F8F8',  
                        'keyboard-bg': '#FFF5D6',       
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    
                        'key-active': '0 2px 0 0 #D1A3A3', 
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- 訊息提示框 -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- 頂部標題與導航 -->
    <header class="w-full max-w-6xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- 可愛小豬圖示 (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.1716 9 9 9Z" fill="#FF8FAB"/><path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/><circle cx="11" cy="13" r="1" fill="#FF8FAB"/><circle cx="13" cy="13" r="1" fill="#FF8FAB"/></svg>
            英文學習遊戲樂園-1
        </h1>
    </header>

    <!-- 導航列 -->
    <nav class="w-full max-w-6xl mb-6">
        <div class="grid grid-cols-4 gap-2 md:gap-4 justify-center" id="game-nav">
            
            <button data-game="game2" class="tab-btn">🎶 配對</button>
            <button data-game="game3" class="tab-btn">🖍️ Hangman</button>
            <button data-game="game4" class="tab-btn">🎤 賓果</button>
            <button data-game="game5" class="tab-btn">💬 問句</button>
            
            <button data-game="game6" class="tab-btn">🤸 日常</button>
            <button data-game="game7" class="tab-btn">💰 花費計算機</button>
            <button data-game="game8" class="tab-btn">💥 發音機</button>
            <button data-game="admin" class="tab-btn">⚙️ 後台</button>
        </div>
    </nav>

    <!-- 主內容區 -->
    <main id="game-content" class="w-full max-w-6xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[600px]">
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">正在載入應用程式...</p>
        </div>
    </main>
    
    <script>
        // --- 全域設定與工具 ---
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split('');
        const LOCAL_STORAGE_KEY = 'GAMES_CUSTOM_DATA_V2';
        const G4_BINGO_SIZE = 4;

        let currentGame = 'game2'; // 更改預設遊戲為 game2
        let localData = {}; // 存放所有遊戲的自訂數據
        let isGeneratingImage = false; // AI 圖片生成狀態旗標
        
        // Hangman Emoji 提示庫
        const G3_EMOJI_HINTS = {
            'PUPPET': '🎎', 'SKATEBOARD': '🛹', 'HISTORY': '🏛️', 'HARD': '💪', 'EASY': '😌', 
            'DOLLAR': '💵', 'HAND': '🖐️', 'FOOT': '🦶', 'SCIENCE': '🔬', 'MATHS': '➕'
        };

        // 新增：常用動詞和日常活動的 Emoji 映射表
        const ACTION_EMOJI_MAP = {
            // 基礎動詞 (新增)
            'RUN': '🏃', 'TALK': '🗣️', 'REST': '🛌', 'EAT': '🍔', 'LISTEN': '🎧', 
            'PAINT': '🎨', 'JUMP': '🤸', 'WALK': '🚶', 'JOG': '🏃', 'SKIP': '縄',

            // 片語關鍵字
            'WASH': '🚿', 'FACE': '🙂', 'TEETH': '🦷', 'BRUSH': '🖌️', 'HAIR': '💇', 
            'DO': '✅', 'HOMEWORK': '📚', 'PLAY': '🎮', 'PHONE': '📱', 'IS': '👉', 
            
            // 人稱代詞
            'I': '🙋', 'YOU': '👤', 'HE': '👦', 'SHE': '👧', 'IT': '🐶', 'WE': '👥', 'THEY': '👫' 
        };
        
        // Present Continuous 主詞-Be動詞組合
        const G7_SUBJECT_FORMS = [
            'I AM', 'YOU ARE', 'HE IS', 'SHE IS', 'IT IS', 'WE ARE', 'THEY ARE'
        ];


        // 預設單字庫 (Phonics 2, STEP 3 詞彙)
        const DEFAULT_WORDS = {
            // Game 2: 🎶 Phonics 發音配對
            g2_words: [
                { id: crypto.randomUUID(), phonics: 'A-E', word: 'CAKE', hint: '生日蛋糕' },
                { id: crypto.randomUUID(), phonics: 'IE', word: 'PIE', hint: '美味的派' },
                { id: crypto.randomUUID(), phonics: 'OO', word: 'FOOD', hint: '好吃的食物' },
                { id: crypto.randomUUID(), phonics: 'EW', word: 'NEW', hint: '新的' },
                { id: crypto.randomUUID(), phonics: 'OA', word: 'BOAT', hint: '一艘船' },
                { id: crypto.randomUUID(), phonics: 'EE', word: 'BEE', hint: '小蜜蜂' },
            ],
            // Game 3: 🖍️ Hangman 猜單字
            g3_words: ['PUPPET', 'SKATEBOARD', 'HISTORY', 'HARD', 'EASY', 'DOLLAR', 'HAND', 'FOOT'],
            // Game 4: 🎤 雙人賓果
            g4_bingo_words: ['SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY', 'HUNDRED', 'THOUSAND', 'DOLLAR', 'HOSPITAL', 'PARK', 'BANK', 'COAT', 'JEANS', 'GLOVES', 'HAT', 'SCARF', 'TIE'],
            // Game 5: 💬 問句重組大師
            g5_sentences: [
                "What does he do after school?",
                "When does she have English?",
                "How much is the skateboard?",
                "How many legs does it have?",
                "Is the yellow one longer?",
                "I'm going to the airport."
            ],
            // Game 6: 🤸 日常活動圖像配對 (Word: Image_Concept) - 使用隨機 Emoji 和 Placeholder URL
            g6_routines: [
                { id: crypto.randomUUID(), word: 'WASH HIS FACE', emoji: '🚿🙂', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=WASH%20FACE' },
                { id: crypto.randomUUID(), word: 'DO HER HOMEWORK', emoji: '👧📚', url: 'https://placehold.co/150x120/ff8a65/000000?text=DO%20HOMEWORK' },
                { id: crypto.randomUUID(), word: 'BRUSH HIS TEETH', emoji: '👦🦷', url: 'https://placehold.co/150x120/9ccc65/000000?text=BRUSH%20TEETH' },
                { id: crypto.randomUUID(), word: 'PLAY ON HIS PHONE', emoji: '🎮📱', url: 'https://placehold.co/150x120/ab47bc/ffffff?text=PLAY%20PHONE' },
            ],
            // Game 7: 🏃 動詞連連看 (Verb: Full Sentence, e.g. I AM JUMPING) - 數據已無用，但保留結構
            g7_verbs: [
                { id: crypto.randomUUID(), fullSentence: 'I AM JUMPING', emoji: '🙋🤸', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=JUMPING' },
                { id: crypto.randomUUID(), fullSentence: 'HE IS PAINTING', emoji: '👦🎨', url: 'https://placehold.co/150x120/ef5350/ffffff?text=PAINTING' },
                { id: crypto.randomUUID(), fullSentence: 'THEY ARE TALKING', emoji: '👫🗣️', url: 'https://placehold.co/150x120/4db6ac/000000?text=TALKING' },
                { id: crypto.randomUUID(), fullSentence: 'WE ARE EATING', emoji: '👥🍔', url: 'https://placehold.co/150x120/f9a825/000000?text=EATING' },
            ],
            // Game 8: 💥 神奇發音機 (Digraph: Word_Template)
            g8_digraphs: [
                { id: crypto.randomUUID(), digraph: 'SH', word: '_OP', full: 'SHOP' },
                { id: crypto.randomUUID(), digraph: 'CH', word: '_AT', full: 'CHAT' },
                { id: crypto.randomUUID(), digraph: 'TH', word: '_INK', full: 'THINK' },
                { id: crypto.randomUUID(), digraph: 'WH', word: '_ALE', full: 'WHALE' },
                { id: crypto.randomUUID(), digraph: 'PH', word: 'ELE_ANT', full: 'ELEPHANT' },
            ],
        };

        // --- 核心工具函數：Emoji 生成邏輯 ---

        function generateEmojiFromWord(wordPhrase) {
            // 這是使用純 JavaScript 模擬的「智慧」Emoji 提取和組合
            const tokens = wordPhrase.split(/\s+/).map(t => t.replace(/[^A-Z]/g, ''));
            let generatedEmoji = '';

            tokens.forEach(token => {
                let found = false;
                // 優先匹配完整的詞彙
                if (ACTION_EMOJI_MAP[token]) {
                    generatedEmoji += ACTION_EMOJI_MAP[token];
                    found = true;
                }
                
                // 嘗試匹配核心動詞 (移除 ING)
                if (!found && token.endsWith('ING')) {
                    const baseVerb = token.slice(0, -3);
                    if (ACTION_EMOJI_MAP[baseVerb]) {
                        generatedEmoji += ACTION_EMOJI_MAP[baseVerb];
                        found = true;
                    }
                }

                // 嘗試匹配詞彙中的關鍵字 (如 FACE, HAIR)
                for (const key in ACTION_EMOJI_MAP) {
                    if (token.includes(key) && key.length > 2 && !generatedEmoji.includes(ACTION_EMOJI_MAP[key])) {
                        generatedEmoji += ACTION_EMOJI_MAP[key];
                        found = true;
                    }
                }
            });

            // 如果沒找到任何 Emoji，則使用一個隨機Emoji作為備用
            if (generatedEmoji.length === 0) {
                const randomEmojis = ['🌟', '💡', '✅', '🌈'];
                generatedEmoji = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            }
            
            return generatedEmoji.trim();
        }
        
        // --- 句式大小寫格式化工具 (修正後版本) ---
        function formatDisplayWord(word, isSentenceStart = false) {
            if (typeof word !== 'string') return word;
            if (word.length === 0) return word;

            // 1. 檢查是否需要保持原樣大寫 (Caps Lock 強調)
            const hasUpperCase = /[A-Z]/.test(word);
            
            if (hasUpperCase) {
                // 如果原始單詞包含大寫（無論是不是全大寫），則保持原始輸入
                return word;
            }
            
            // 2. 特殊單字檢查 (I 永遠大寫)
            if (word.toUpperCase() === 'I') {
                return 'I';
            }
            
            // 3. 句首檢查 (僅當它不是句首的標點符號時)
            if (isSentenceStart && word.match(/^[a-z]/i)) {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }

            // 4. 預設轉換為全小寫
            return word.toLowerCase();
        }
        
        // --- 提取動詞進行式 (新的輔助函數) ---
        function extractVerbParticiple(fullSentence) {
            const parts = fullSentence.split(' ').map(p => p.trim());
            if (parts.length > 0 && parts[parts.length - 1].endsWith('ING')) {
                return parts[parts.length - 1]; // 返回句子的最後一個詞，假設是動詞 ing 形式
            }
            return null;
        }

        // --- 數字轉英文單字功能 (Game 7 核心) ---
        const ONES = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
        const TEENS = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
        const TENS = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
        
        function numberToWords(num) {
            if (num < 0 || num > 999999) return "NUMBER OUT OF RANGE";
            if (num === 0) return "ZERO";

            function convertLessThanThousand(n) {
                let s = '';
                if (n >= 100) {
                    s += ONES[Math.floor(n / 100)] + ' HUNDRED';
                    n %= 100;
                    if (n > 0) s += ' '; // 簡化，用空格連接
                }
                if (n >= 10 && n <= 19) {
                    s += TEENS[n - 10];
                } else if (n >= 20) {
                    s += TENS[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) s += '-';
                }
                if (n > 0 && n < 10) {
                    s += ONES[n];
                }
                return s.trim().replace(/\s+/g, ' '); // 移除多餘空格
            }

            // 由於目標是百位數 (最大 999)，我們只用這個函數即可
            return convertLessThanThousand(num).replace('AND', ''); // 移除 'AND'
        }
        
        // 隨機物品和價格列表 (基於 STEP 3 教材)
        const SHOP_ITEMS = [
            { name: "SKATEBOARD", emoji: "🛹", maxPrice: 200 }, // 單品金額不超過 200
            { name: "PUPPET", emoji: "🧸", maxPrice: 200 },
            { name: "ACTION FIGURE", emoji: "🦸", maxPrice: 200 },
            { name: "MODEL PLANE", emoji: "✈️", maxPrice: 200 },
            { name: "BARBIE DOLL", emoji: "👸", maxPrice: 200 },
            { name: "BACKPACK", emoji: "🎒", maxPrice: 200 },
        ];


        // --- 遊戲狀態管理 ---
        let state = {
            // G2
            g2_matchCards: [], g2_flippedCards: [], g2_matchCount: 0, g2_gameStatus: 'ready',
            // G3
            g3_currentGuessWord: '', g3_guessedLetters: new Set(), g3_wrongGuesses: 0, g3_gameStatus: 'ready', g3_MAX_WRONG: 6, g3_emojiHint: '', 
            // G4
            g4_players: [], g4_calledWords: new Set(), g4_lastCalledWord: '', g4_gameStatus: 'ready', g4_isCalling: false,
            // G5
            g5_currentSentence: '', g5_answerWords: [], g5_scrambleBlocks: [], g5_currentSort: [], g5_gameStatus: 'ready',
            // G6
            g6_targets: [], g6_sources: [], g6_matches: 0,
            // G7 (Cost Calculator)
            g7_items: [],
            g7_totalCost: 0,
            g7_displayValue: '', // 用於題目答案輸入
            g7_calculator: { // 模擬計算機的內部狀態
                currentValue: '0',
                memory: 0,
                operator: null,
                resetDisplay: true,
                calcDisplay: '0'
            },
            g7_gameStatus: 'ready',
            // G8
            g8_currentWord: null, g8_gameStatus: 'ready', g8_score: 0,
        };

        // --- TTS & Utility ---

        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                console.warn("SpeechSynthesis not supported.");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => { console.error("SpeechSynthesis error:", e); resolve(); };
                window.speechSynthesis.speak(utterance);
            });
        }

        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        // --- LocalStorage 存儲功能 (統一管理所有遊戲數據) ---

        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loaded = stored ? JSON.parse(stored) : {};
                
                // 1. 初始化 localData 為 DEFAULT_WORDS 的深拷貝（確保 ID 獨立）
                localData = JSON.parse(JSON.stringify(DEFAULT_WORDS));
                
                for (const key in loaded) {
                    if (Array.isArray(loaded[key])) {
                        localData[key] = loaded[key].map(item => {
                            // 2. 確保載入的物件有 ID，如果沒有，賦予一個新的 ID
                            if (typeof item === 'object' && item !== null && !item.id) {
                                return { ...item, id: crypto.randomUUID() };
                            }
                            return item;
                        }).filter(item => item !== null && item !== undefined); 
                    }
                }
            } catch (e) {
                console.error("Error loading words from local storage:", e);
                // 如果出錯，至少使用預設值
                localData = DEFAULT_WORDS;
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("無法保存單字到您的瀏覽器。", true);
            }
        }

        // --- 核心應用程式控制 ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.querySelector(`.tab-btn[data-game="${gameName}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); // 每次渲染前載入

            switch (currentGame) {
                
                case 'game2': initGame2(); break;
                case 'game3': initGame3(); break;
                case 'game4': initGame4(); break;
                case 'game5': initGame5(); break;
                case 'game6': initGame6(); break;
                case 'game7': initGame7(); break; // 修改為呼叫 initGame7
                case 'game8': initGame8(); break;
                case 'admin': renderWordAdmin(); break;
                default: document.getElementById('game-content').innerHTML = `<p class="text-xl text-gray-500 text-center p-10">請選擇一個遊戲</p>`;
            }
        }

        window.onload = function() {
            // 替換導航按鈕樣式
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('bg-white', 'hover:bg-secondary-blue', 'py-2', 'px-3', 'md:px-4', 'rounded-full', 'text-xs', 'md:text-sm', 'font-bold', 'text-gray-700', 'transition', 'duration-300', 'shadow-md');
                
                // 修正: 將點擊事件從 onclick 移至 addEventListener
                const gameName = btn.getAttribute('data-game');
                if (gameName) {
                    btn.addEventListener('click', () => changeGame(gameName));
                }
            });

            setTabActive(currentGame);
            renderApp();
        }

        // --- Game 2: 🎶 Phonics 發音配對 (Vowel Sound Match) ---
        // 移除 G2_COLORS，改用 CSS 類別 card-type-phonics / card-type-word

        function initGame2() {
            const source = localData.g2_words;
            if (source.length === 0) { MessageBox.show("請在後台新增 Phonics 配對單字！", true); return; }

            // 1. 限制卡片對數為 4 組 (8 張卡片)
            const limitedSource = shuffleArray(source).slice(0, 4);

            state.g2_matchCount = 0;
            state.g2_flippedCards = [];
            state.g2_gameStatus = 'playing';

            let cardValues = [];
            limitedSource.forEach((item, index) => {
                const groupId = `match-${item.phonics}-${index}`;

                // Phonics 卡片 (黃/橘色調)
                cardValues.push({ id: crypto.randomUUID(), type: 'PHONICS', value: item.phonics, groupId, matched: false, flipped: false, hint: item.hint });
                // Word 卡片 (藍/粉色調)
                cardValues.push({ id: crypto.randomUUID(), type: 'WORD', value: item.word, groupId, matched: false, flipped: false, hint: item.hint });
            });

            state.g2_matchCards = shuffleArray(cardValues);
            renderGame2();
        }

        async function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card || card.matched || card.flipped || state.g2_flippedCards.length === 2) return;

            card.flipped = true;
            state.g2_flippedCards.push(card);
            
            // 點擊卡片時，不執行 callTTS(card.type === 'PHONICS' ? card.phonics : card.value);

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                if (card1.groupId === card2.groupId) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    state.g2_flippedCards = [];
                    renderGame2();
                    if (state.g2_matchCount === state.g2_matchCards.length / 2) {
                        setTimeout(() => MessageBox.show("太棒了！所有發音配對成功！🎉", false), 500);
                        state.g2_gameStatus = 'won';
                    }
                } else {
                    setTimeout(() => {
                        state.g2_matchCards.forEach(c => {
                            if (c.id === card1.id || c.id === card2.id) c.flipped = false;
                        });
                        state.g2_flippedCards = [];
                        renderGame2();
                    }, 1000);
                }
            }
            renderGame2();
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-lg md:text-2xl font-extrabold text-gray-800`;
                let openCardColorClass = card.type === 'PHONICS' ? 'card-type-phonics' : 'card-type-word';
                let hiddenCardContent = card.type === 'PHONICS' ? 'phonics' : 'word'; // 保持小寫


                if (card.matched) {
                    cardClasses += ` matched-success`;
                    content = `${formatDisplayWord(card.phonics)} / ${formatDisplayWord(card.value)}`; // 輸出格式化
                } else if (card.flipped) {
                    cardClasses += ` ${openCardColorClass} border-gray-500`;
                    content = card.type === 'PHONICS' ? `[${formatDisplayWord(card.value)}]` : formatDisplayWord(card.value); // 輸出格式化
                } else {
                    cardClasses += ` bg-primary-pink border-pink-400`; // 牌面朝下時使用主題粉色
                    content = hiddenCardContent; // 顯示卡片類型
                    innerTextClass = `text-base md:text-xl font-bold text-gray-800`; // 縮小文字以適應 PHONICS/WORD 標籤
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" data-card-id="${card.id}">
                        <div class="${cardClasses}">
                            <div class="text-center">
                                <span class="${innerTextClass}">
                                    ${content}
                                </span>
                                ${card.flipped && card.type === 'WORD' ? `<p class="text-xs text-gray-600 mt-1">(${card.hint})</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 重新綁定點擊事件
            setTimeout(() => {
                document.querySelectorAll('#match-game-grid [data-card-id]').forEach(elem => {
                    elem.addEventListener('click', () => handleCardClickG2(elem.dataset.cardId));
                });
            }, 0);

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">🎶 phonics 發音配對 (vowel sound match)</h2>
                    <p class="text-center text-sm mb-4">目標: 點擊卡片，配對相同的長母音組合和對應的單字。已完成 ${state.g2_matchCount}/${state.g2_matchCards.length / 2} 組。</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-2xl mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_matchCount === state.g2_matchCards.length / 2 ? '再玩一次' : '重新開始'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- Game 2 End ---

        // --- Game 3: 🖍️ Hangman 猜單字 (Hangman) ---
        function getHangmanSVG(wrongGuesses, status) {
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            const fillStyle = `fill="none" stroke="${color}" stroke-width="6"`;
            const base = 180; // 調整地基高度

            // 1. Base (地基)
            parts.push(`<line x1="50" y1="${base}" x2="150" y2="${base}" ${fillStyle}/>`); 
            // 2. Upright (立柱)
            parts.push(`<line x1="100" y1="${base}" x2="100" y2="20" ${fillStyle}/>`); 
            // 3. Crossbar (橫樑)
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" ${fillStyle}/>`); 
            // 4. Rope/Gallows (繩子/吊繩)
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 

            // 5. Brace (支撐斜線) - 讓桿子看起來更穩固
            parts.push(`<line x1="100" y1="60" x2="160" y2="20" ${fillStyle} stroke-width="4"/>`); 

            // Character Drawing (6 parts for the body)
            
            // 1. Head
            if (wrongGuesses >= 1) {
                parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            }

            // 2. Body
            if (wrongGuesses >= 2) {
                parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            }

            // 3. Left Arm
            if (wrongGuesses >= 3) {
                parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            }

            // 4. Right Arm
            if (wrongGuesses >= 4) {
                parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            }

            // 5. Left Leg
            if (wrongGuesses >= 5) {
                parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            }

            // 6. Right Leg (Game Over)
            if (wrongGuesses >= 6) {
                parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            }
            
            return `<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">${parts.join('')}</svg>`;
        }

        function getEmojiHint(word) {
            // 嘗試精確匹配，否則返回一個問號
            return G3_EMOJI_HINTS[word] || '❓';
        }

        function initGame3() {
            const source = localData.g3_words;
            if (source.length === 0) { MessageBox.show("請在後台新增 hangman 單字！", true); return; }

            const randomWord = source[Math.floor(Math.random() * source.length)];
            state.g3_currentGuessWord = randomWord.toUpperCase(); 
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            state.g3_emojiHint = getEmojiHint(state.g3_currentGuessWord);
            renderGame3(); 
        }

        function guessLetterG3(letter) {
            const upperCaseLetter = letter.toUpperCase();
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(upperCaseLetter)) return;
            
            state.g3_guessedLetters.add(upperCaseLetter);
            if (!state.g3_currentGuessWord.includes(upperCaseLetter)) state.g3_wrongGuesses++;
            checkWinConditionG3();
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                MessageBox.show(`恭喜您！單字是 ${state.g3_currentGuessWord.toLowerCase()}！🎉`, false);
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`很可惜。正確單字是 ${state.g3_currentGuessWord.toLowerCase()}。😭`, true);
            }
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;
            
            // 應用格式化：單字保持後台儲存的大小寫（但因為是 Hangman，通常會是全大寫）
            const formattedWord = state.g3_currentGuessWord;

            const displayWord = formattedWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost';
                if (state.g3_guessedLetters.has(char) || isGameOver) {
                    return formatDisplayWord(char); 
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                const upperCaseLetter = letter.toUpperCase();
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(upperCaseLetter)) {
                    btnClass = state.g3_currentGuessWord.includes(upperCaseLetter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }
                if (state.g3_gameStatus !== 'playing') { btnClass = 'bg-gray-300 cursor-not-allowed'; onClick = ''; }

                return `<button onclick="${onClick}" class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-2xl font-extrabold rounded-xl transition duration-150 text-gray-800">${letter}</button>`;
            }).join('');

            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">🖍️ hangman 猜單字 (word guess)</h2>
                </section>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">💔 錯誤次數: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">${hangmanDrawing}</div>
                        <p class="text-4xl mt-2 text-center">提示: ${state.g3_emojiHint}</p>
                    </div>
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">猜測單字:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">${displayWord}</div>
                        <div class="grid grid-cols-7 gap-1 md:gap-2">${alphabetBtns}</div>
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? '重設遊戲' : '開始新遊戲'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- Game 3 End ---

        // --- Game 4: 🎤 雙人賓果 (Bingo) ---
        function generateBingoCardG4() {
            const source = localData.g4_bingo_words;
            if (source.length < G4_BINGO_SIZE * G4_BINGO_SIZE) {
                MessageBox.show(`賓果單字庫不足 ${G4_BINGO_SIZE * G4_BINGO_SIZE} 個！`, true);
                return Array(G4_BINGO_SIZE * G4_BINGO_SIZE).fill('ERROR');
            }
            return shuffleArray(source).slice(0, G4_BINGO_SIZE * G4_BINGO_SIZE);
        }

        function checkWinG4(player) {
            let lines = 0;
            const size = G4_BINGO_SIZE;
            const card = player.card;
            const marked = player.marked;

            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    if (marked.has(card[i * size + j])) rowCount++;
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }
            let diag1Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + i])) diag1Count++; }
            if (diag1Count === size) lines++;

            let diag2Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++; }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            return lines >= 2;
        }

        function initGame4() {
            state.g4_players = [
                { id: 1, name: '玩家 1', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
                { id: 2, name: '玩家 2', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
            ];
            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_gameStatus = 'ready';
            state.g4_isCalling = false;
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') { initGame4(); return; }
            if (state.g4_isCalling) return;
            
            const availableWords = shuffleArray(localData.g4_bingo_words.filter(w => !state.g4_calledWords.has(w)));
            if (availableWords.length === 0) { MessageBox.show("單字庫已抽完！", true); return; }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord;
            state.g4_calledWords.add(nextWord);
            
            state.g4_isCalling = true;
            state.g4_gameStatus = 'calling';
            renderGame4(); 
            
            await callTTS(nextWord); // 恢復 Game 4 聲音
            
            state.g4_isCalling = false; 

            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`賓果！玩家 ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' 和 ')} 獲勝！`, false);
            } else {
                renderGame4();
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index];

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) player.marked.delete(word);
                else player.marked.add(word);

                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished';
                    MessageBox.show(`賓果！玩家 ${playerId} 獲勝！`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`單字 ${word.toLowerCase()} 尚未被唸出！`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `<div class="bingo-cell ${isMarked ? 'marked' : 'hover:bg-yellow-300'}" data-player-id="${player.id}" data-index="${index}">${formatDisplayWord(word)}</div>`;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">${player.name} ${player.winner ? '🎉 winner 🎉' : ''} (線數: ${player.score})</h3>
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${G4_BINGO_SIZE}, 1fr); grid-template-rows: repeat(${G4_BINGO_SIZE}, 1fr); max-w-full md:max-w-[300px];" id="bingo-grid-${player.id}">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };
            
            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">${state.g4_gameStatus === 'ready' ? '準備開始' : state.g4_gameStatus === 'calling' ? '遊戲中' : '遊戲結束'}</h3>
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <p class="text-4xl font-black text-red-700 transition duration-300 item-name-display">
                            ${state.g4_lastCalledWord ? `單字: ${formatDisplayWord(state.g4_lastCalledWord)}` : state.g4_gameStatus === 'ready' ? '點擊開始按鈕' : '等待下一輪...'}
                        </p>
                    </div>
                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? '🔊 開始遊戲 / 抽取單字' : state.g4_gameStatus === 'calling' ? (state.g4_isCalling ? '🎙️ 播報中...' : '🔊 抽取下一個單字') : '🔄 重新開始'}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">已抽出 ${state.g4_calledWords.size} 個單字 / 剩餘 ${localData.g4_bingo_words.length - state.g4_calledWords.size} 個</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">🎤 雙人英文賓果 (two-player bingo)</h2>
                    <p class="text-center text-sm text-blue-900 mb-6">目標: 聽取單字，並在您的 4x4 賓果卡上標記。最先完成兩條線獲勝！</p>
                    ${controlArea}
                    <div class="flex flex-col md:flex-row gap-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                </section>
            `;
             // 重新綁定事件監聽器
            setTimeout(() => {
                document.querySelectorAll('.bingo-cell').forEach(cell => {
                    const playerId = parseInt(cell.dataset.playerId);
                    const index = parseInt(cell.dataset.index);
                    cell.addEventListener('click', () => handleCardClickG4(playerId, index));
                });
            }, 0);
        }
        // --- Game 4 End ---

        // --- Game 5: 💬 問句重組大師 (Sentence Scramble Master) ---
        function getSentenceTokens(sentence) {
            // 這個正則表達式會將單字、縮寫 (e.g., 's) 和標點符號分離為獨立詞塊
            return sentence.match(/\b\w+'?\w*\b|[.,?!]/g) || [];
        }

        function capitalizeSentence(word) {
            if (word === 'I') return 'I';
            // 將 I, He, She, They, We, You, It 的首字母大寫
            const personalPronouns = ["I", "HE", "SHE", "YOU", "WE", "THEY", "IT"];
            
            if (personalPronouns.includes(word)) {
                 if (word === 'I') return 'I'; // 確保 I 保持大寫
                 return word.charAt(0) + word.slice(1).toLowerCase();
            }

            // 句首單字：首字母大寫，其餘小寫
            if (word.length > 0) {
                 return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }
            return word.toLowerCase();
        }

        function shuffleWordsG5(sentence) {
            const words = getSentenceTokens(sentence);
            
            // 複製一份用於打亂，並加入 ID
            const scrambleArray = words.map(word => ({ id: crypto.randomUUID(), value: word, isUsed: false })); // 不強制大寫
            
            // 僅打亂單字和標點符號的順序
            for (let i = scrambleArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [scrambleArray[i], scrambleArray[j]] = [scrambleArray[j], scrambleArray[i]];
            }
            return scrambleArray;
        }

        function initGame5() {
            const source = localData.g5_sentences;
            if (source.length === 0) { MessageBox.show("請在後台新增問句！", true); return; }

            state.g5_currentSentence = source[Math.floor(Math.random() * source.length)];
            
            // 1. 產生亂序詞塊
            state.g5_scrambleBlocks = shuffleWordsG5(state.g5_currentSentence);
            
            // 2. 初始化答案槽位 (數量等於詞塊總數)
            state.g5_currentSort = Array(state.g5_scrambleBlocks.length).fill(null); 
            state.g5_gameStatus = 'playing';

            renderGame5();
        }
        
        async function speakSentenceG5(sentence) { await callTTS(sentence); }

        function handleWordClickG5(id) {
            const wordBlock = state.g5_scrambleBlocks.find(l => l.id === id);
            if (!wordBlock || wordBlock.isUsed || state.g5_gameStatus !== 'playing') return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = { value: wordBlock.value, id: wordBlock.id };
                wordBlock.isUsed = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const item = state.g5_currentSort[index];
            if (!item || state.g5_gameStatus !== 'playing') return;

            // 找到被使用的詞塊，將其標記為未使用
            const originalBlock = state.g5_scrambleBlocks.find(l => l.id === item.id);
            if (originalBlock) originalBlock.isUsed = false;
            
            // 將後續的詞塊往前移，填補空位
            for (let i = index; i < state.g5_currentSort.length - 1; i++) {
                state.g5_currentSort[i] = state.g5_currentSort[i + 1];
            }
            state.g5_currentSort[state.g5_currentSort.length - 1] = null;

            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            // --- 偵錯修正: 使用詞塊序列比對 ---
            
            // 1. 取得目標（正規）的詞塊序列 (Tokens)
            const targetTokens = getSentenceTokens(state.g5_currentSentence).map(t => t.toUpperCase());
            
            // 2. 取得用戶排列的詞塊序列
            const currentTokens = state.g5_currentSort.map(item => item.value.toUpperCase());
            
            // 3. 比較序列的長度和內容
            let isCorrect = targetTokens.length === currentTokens.length;
            if (isCorrect) {
                for (let i = 0; i < targetTokens.length; i++) {
                    // 確保逐一比較每個詞塊（包括標點符號）
                    if (targetTokens[i] !== currentTokens[i]) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            if (isCorrect) {
                state.g5_gameStatus = 'won';
                MessageBox.show("太棒了！句子順序完全正確！🎉", false);
                speakSentenceG5(state.g5_currentSentence); 
            } else {
                const slots = document.querySelectorAll('.answer-slot');
                slots.forEach(slot => {
                    slot.classList.add('incorrect');
                    setTimeout(() => slot.classList.remove('incorrect'), 500);
                });
                MessageBox.show("順序不正確，請再試試看！", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((item, index) => {
                const isFilled = item !== null;
                let displayWord = '（點擊詞塊填入）';
                
                if (isFilled) {
                     // 應用大小寫規則
                    displayWord = formatDisplayWord(item.value, index === 0);
                }
                
                return `
                    <div class="answer-slot ${isFilled ? 'filled bg-green-200 border-green-400' : ''}"
                         data-index="${index}">
                        ${displayWord}
                    </div>
                `;
            }).join('');

            const letterBlocksHtml = state.g5_scrambleBlocks.map(wordBlock => `
                <button data-id="${wordBlock.id}"
                        class="word-block ${wordBlock.isUsed ? 'used' : 'hover:bg-yellow-300'}"
                        ${wordBlock.isUsed || state.g5_gameStatus !== 'playing' ? 'disabled' : ''}>
                    ${formatDisplayWord(wordBlock.value)}
                </button>
            `).join('');
            
            // 重新綁定事件監聽器
            setTimeout(() => {
                document.querySelectorAll('.word-block').forEach(btn => {
                    btn.addEventListener('click', () => handleWordClickG5(btn.dataset.id));
                });
                document.querySelectorAll('.answer-slot').forEach(slot => {
                    slot.addEventListener('click', () => handleResetTargetG5(parseInt(slot.dataset.index)));
                });
            }, 0);


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">💬 問句重組大師 (sentence scramble master)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">💡 點擊詞塊，重組句子的正確順序！</p>
                </section>
                
                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    <div class="text-center mb-6">
                        <button onclick="speakSentenceG5(state.g5_currentSentence)" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            🔊 朗讀原始句子 (聽力輔助)
                        </button>
                    </div>

                    <div class="text-center mb-6 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300 w-full">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">答案區 (點擊已填入詞塊可移除)</h3>
                        <div class="g5-answer-display">
                            ${targetBoxesHtml}
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">詞塊庫 (點擊填入)</h3>
                    <div class="flex flex-wrap justify-center p-2">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g5_gameStatus === 'won' ? '再玩一次' : '換個句子'}
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 5 End ---

        // --- Game 6: 🤸 日常活動圖像配對 (Daily Routine Image Match) ---
        function initGame6() {
            const source = localData.g6_routines;
            if (source.length === 0) { MessageBox.show("請在後台新增日常活動！", true); return; }

            // 隨機選取 4 個配對
            const pairs = shuffleArray(source).slice(0, 4);
            
            state.g6_targets = pairs.map(p => ({ ...p, matched: false })); // 圖片 (Target)
            state.g6_sources = shuffleArray(pairs.map(p => ({ id: crypto.randomUUID(), word: p.word, isMatched: false }))); // 單字卡 (Source)
            state.g6_matches = 0;
            
            // 啟用拖曳功能
            setupDragDropG6();

            renderGame6();
        }

        function setupDragDropG6() {
            let draggedItem = null;

            document.ondragstart = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    draggedItem = e.target.dataset.word;
                    e.dataTransfer.setData('text/plain', draggedItem);
                    e.target.classList.add('opacity-50');
                }
            };

            document.ondragend = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    e.target.classList.remove('opacity-50');
                    draggedItem = null;
                }
            };

            document.ondragover = (e) => {
                const target = e.target.closest('.image-target');
                if (target) e.preventDefault();
            };

            document.ondrop = (e) => {
                const target = e.target.closest('.image-target');
                if (target && draggedItem) {
                    e.preventDefault();
                    
                    const targetWord = target.dataset.word; // 圖片的正確單字
                    const sourceWord = draggedItem; // 拖曳來源的單字

                    if (sourceWord === targetWord) {
                        handleMatchG6(sourceWord, targetWord, target);
                    } else {
                        MessageBox.show('配對錯誤，請再試試！', true);
                    }
                }
            };
        }
        
        async function handleMatchG6(sourceWord, targetWord, targetElement) {
            state.g6_matches++;

            // 1. 標記圖片為已配對
            const targetIndex = state.g6_targets.findIndex(t => t.word === targetWord);
            if (targetIndex !== -1) state.g6_targets[targetIndex].matched = true;

            // 2. 移除來源卡片
            state.g6_sources = state.g6_sources.filter(s => s.word !== sourceWord);

            // 3. 更新 UI
            renderGame6();
            
            // 4. 給予回饋 (不發聲)
            targetElement.classList.add('border-green-600', 'bg-green-100');
            MessageBox.show('配對成功！🎉', false);

            if (state.g6_matches === state.g6_targets.length) {
                MessageBox.show('太棒了！所有日常活動都配對成功！', false);
            }
        }


        function renderGame6() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game6') return;

            const targetsHtml = state.g6_targets.map(t => {
                const isMatched = t.matched;
                return `
                    <div id="target-${t.word.replace(/\s/g, '_')}" 
                         data-word="${t.word}" 
                         class="image-target ${isMatched ? 'border-green-600 bg-green-100' : 'border-primary-pink'} p-2">
                        <p class="text-5xl mb-2">${t.emoji}</p>
                        ${isMatched ? `<p class="text-lg font-bold text-green-700 item-name-display">${formatDisplayWord(t.word)}</p>` : ''}
                    </div>
                `;
            }).join('');

            const sourcesHtml = state.g6_sources.map(s => `
                <button draggable="true" data-word="${s.word}" class="drag-source key-btn bg-accent-yellow hover:bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-xl text-sm md:text-base">${formatDisplayWord(s.word)}</button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">🤸 日常活動圖像配對 (daily routine image match)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">目標: 將下方的單字卡拖曳到上方對應的日常活動圖片上。</p>
                </section>
                
                <div class="p-4 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        ${targetsHtml}
                    </div>
                </div>

                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow w-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">拖曳單字庫 (${state.g6_sources.length} 剩餘)</h3>
                    <div class="flex flex-wrap justify-center gap-3 drag-area">
                        ${sourcesHtml.length > 0 ? sourcesHtml : '<p class="text-lg font-bold text-green-700">全部完成！</p>'}
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame6()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">重新開始</button>
                </div>
            `;

            if (state.g6_sources.length > 0) setupDragDropG6();
        }
        // --- Game 6 End ---

        // --- Game 7: 🏃 花費計算機 (Cost Calculator) ---
        
        // ------------------ 計算機核心邏輯 -------------------
        function performCalculation(num1, num2, operator) {
            // 確保操作數為浮點數，以處理除法和小數點
            num1 = parseFloat(num1);
            num2 = parseFloat(num2);

            if (isNaN(num1) || isNaN(num2)) return 0;

            switch (operator) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case 'x': return num1 * num2;
                case '/': 
                    if (num2 === 0) {
                        MessageBox.show("除數不能為零！", true);
                        return num1; // 保持原樣
                    }
                    return num1 / num2;
                default: return num2;
            }
        }

        function handleCalcKey(key) {
            let calc = state.g7_calculator;
            let current = calc.currentValue;

            if (key >= '0' && key <= '9') {
                if (calc.resetDisplay) {
                    current = key;
                    calc.resetDisplay = false;
                } else if (calc.currentValue.length < 10) { // 限制顯示長度
                    current = current === '0' ? key : current + key;
                }
                calc.currentValue = current;
                calc.calcDisplay = current;

            } else if (key === '.') {
                if (!calc.currentValue.includes('.') && !calc.resetDisplay) {
                    calc.currentValue += '.';
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'C') {
                calc.currentValue = '0';
                calc.memory = 0;
                calc.operator = null;
                calc.resetDisplay = true;
                calc.calcDisplay = '0';
            } else if (key === 'DEL') {
                 if (calc.currentValue.length > 1) {
                    calc.currentValue = calc.currentValue.slice(0, -1);
                } else {
                    calc.currentValue = '0';
                }
                calc.calcDisplay = calc.currentValue;
                calc.resetDisplay = false;

            } else if (['+', '-', 'x', '/'].includes(key)) {
                if (calc.operator !== null && !calc.resetDisplay) {
                    // 如果連續按下運算符，先計算前一個
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                } else if (calc.operator === null) {
                    calc.memory = parseFloat(calc.currentValue);
                }
                calc.operator = key;
                calc.resetDisplay = true;
                calc.currentValue = calc.memory.toString(); // 更新 currentV 以便下次使用
                calc.calcDisplay = calc.currentValue;
            } else if (key === '=') {
                if (calc.operator !== null) {
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                    calc.currentValue = calc.memory.toString();
                    calc.operator = null; // 重置運算符
                    calc.resetDisplay = true;
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'R') { // 唸出金額按鈕
                 const numToRead = parseInt(current);
                 if (!isNaN(numToRead) && numToRead > 0) {
                    const wordResult = numberToWords(numToRead) + " dollars";
                    MessageBox.show(`朗讀金額: ${wordResult}`, false);
                    // 不執行 callTTS
                 } else {
                     MessageBox.show("請先輸入金額！", true);
                 }
                 state.g7_calculator = calc;
                 renderGame7();
                 return;
            }
            
            // 更新狀態並渲染
            state.g7_calculator = calc;
            renderGame7();
        }
        
        // ------------------ 遊戲初始化與檢查 -------------------

        function initGame7() {
            // 1. 隨機選擇 2 到 3 個物品
            const numItems = Math.floor(Math.random() * 2) + 2; // 2 或 3
            const shuffledItems = shuffleArray(SHOP_ITEMS).slice(0, numItems);
            
            let total = 0;
            const items = shuffledItems.map(item => {
                // 價格在 $1 到 $200 之間 (符合新要求)
                const price = Math.floor(Math.random() * item.maxPrice) + 1; 
                total += price;
                return { ...item, price };
            });
            
            // 確保總金額不超過 999 (理論上最大為 3 * 200 = 600)
            
            state.g7_items = items;
            state.g7_totalCost = total;
            state.g7_displayValue = ''; // 用於題目答案輸入
            
            state.g7_calculator = { // 重置計算機
                currentValue: '0',
                memory: 0,
                operator: null,
                resetDisplay: true,
                calcDisplay: '0'
            };
            
            state.g7_gameStatus = 'entering'; 
            renderGame7();
        }


        function checkAnswerG7() {
            if (state.g7_gameStatus !== 'entering') return;
            
            // 題目答案輸入框的值
            const enteredValue = parseInt(state.g7_displayValue);
            const expectedValue = state.g7_totalCost;

            if (isNaN(enteredValue) || enteredValue < 1) {
                MessageBox.show("請輸入您計算出的總金額！", true);
                return;
            }
            
            // 檢查金額是否在百位數範圍內
            if (expectedValue > 999) {
                 MessageBox.show("警告：總金額超過 $999。請專注於金額的英文表達。", false);
            }
            
            // 提取英文單字答案
            const expectedWords = numberToWords(expectedValue) + " dollars";
            const enteredWords = numberToWords(enteredValue) + " dollars";
            
            // 比對數字
            if (enteredValue === expectedValue) {
                state.g7_gameStatus = 'won';
                MessageBox.show(`太棒了！總金額是 $${expectedValue}.00！🎉 (It's ${expectedWords})`, false);
            } else {
                state.g7_gameStatus = 'entering'; // 允許繼續嘗試
                MessageBox.show(`不對哦，您輸入的金額是 $${enteredValue}。正確金額是 ${numberToWords(expectedValue)} dollars。再試一次計算吧！`, true);
                document.getElementById('answer-input-g7').classList.add('border-red-500');
                setTimeout(() => document.getElementById('answer-input-g7').classList.remove('border-red-500'), 500);
            }
            renderGame7();
        }

        function renderGame7() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game7') return;

            const calc = state.g7_calculator;
            const currentInputValue = state.g7_displayValue;
            
            // 題目列表
            const itemsHtml = state.g7_items.map((item) => `
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-2">
                    <span class="text-xl">${item.emoji} <span class="item-name-display">${formatDisplayWord(item.name)}</span></span>
                    <span class="text-xl font-bold text-red-600">$${item.price}</span>
                </div>
            `).join('');

            // 格式化計算機顯示
            const formattedCalcDisplay = parseFloat(calc.calcDisplay).toLocaleString('en-US', {
                 maximumFractionDigits: 2
            });

            // 提示欄 (句首大寫)
            const costPrompt = state.g7_gameStatus === 'won' 
                ? formatDisplayWord(`it's ${numberToWords(state.g7_totalCost)} dollars`, true) 
                : formatDisplayWord("how much is it?", true);
            
            // 計算機按鈕
            const calcButtons = [
                'C', 'DEL', '/', 'x',
                '7', '8', '9', '-',
                '4', '5', '6', '+',
                '1', '2', '3', '=',
                '0', '.', 'R', '=' // R for Read (唸出輸入金額)
            ];

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">💰 花費計算機 (cost calculator)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">目標: 使用計算機計算總金額，然後將數字答案輸入到下方欄位。</p>
                </section>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 物品清單 -->
                    <div class="md:col-span-2 p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">🛒 shopping list</h3>
                        ${itemsHtml}
                        <div class="flex justify-end mt-4 pt-4 border-t-2 border-gray-300">
                            <span class="text-2xl font-extrabold text-blue-700">total: ??</span>
                        </div>
                    </div>

                    <!-- 計算機 -->
                    <div class="md:col-span-1 w-full max-w-xs mx-auto">
                        <div class="calc-display mb-4 text-4xl">
                            ${formattedCalcDisplay}
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${calcButtons.map(key => {
                                let keyClass = 'calc-key-number';
                                if (['C', 'DEL'].includes(key)) keyClass = 'calc-key-clear';
                                else if (['+', '-', 'x', '/', 'R', '='].includes(key)) {
                                    keyClass = key === '=' ? 'calc-key-equal' : 'calc-key-operator';
                                }

                                return `
                                    <button onclick="handleCalcKey('${key}')" 
                                            class="calc-key ${keyClass} rounded-xl shadow-cute ${key === '=' ? 'row-span-2' : ''}"
                                            style="${key === '=' ? 'grid-row-end: span 2;' : ''}">
                                        ${key === 'x' ? 'x' : key === '/' ? '÷' : key === 'R' ? '🔊' : key}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <!-- 答案和朗讀區 -->
                <div class="p-6 bg-white rounded-xl shadow-md border-4 border-primary-pink">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">❓ ${formatDisplayWord("how much is it?", true)}</h3>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="answer-input-g7" 
                               value="${currentInputValue}"
                               oninput="state.g7_displayValue = this.value.slice(0, 3);"
                               maxlength="3"
                               placeholder="輸入數字 (0-999)" 
                               class="text-3xl p-3 border-4 border-secondary-blue rounded-lg text-center w-32 font-bold focus:border-blue-500">
                        
                        <button onclick="checkAnswerG7()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl">
                            ✅ 檢查答案
                        </button>
                        
                        <p class="text-3xl font-extrabold text-pink-600 item-name-display">${costPrompt}</p>
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame7()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                        🔄 重新開始/換題目
                    </button>
                </div>
            `;
            
            // 每次渲染後確保輸入框與狀態同步
            const inputElement = document.getElementById('answer-input-g7');
            if (inputElement) {
                inputElement.value = currentInputValue;
                if (state.g7_gameStatus === 'won') inputElement.disabled = true;
                else inputElement.disabled = false;
            }
            
        }
        // --- Game 7 End ---

        // --- Game 8: 💥 神奇發音機 (Digraph Blaster) ---
        function initGame8() {
            const source = localData.g8_digraphs;
            if (source.length === 0) { MessageBox.show("請在後台新增 digraph 單字！", true); return; }

            state.g8_currentWord = shuffleArray(source)[0];
            state.g8_gameStatus = 'playing';
            state.g8_score = 0; // 重置分數
            
            // 每次出題時自動朗讀一次
            callTTS(state.g8_currentWord.full); // 恢復 Game 8 聲音

            renderGame8();
        }
        
        async function handleDigraphClickG8(digraph) {
            if (state.g8_gameStatus !== 'playing') return;

            if (digraph === state.g8_currentWord.digraph) {
                state.g8_score++;
                MessageBox.show('正確！發射成功！💥', false);
                
                // 延遲換題
                setTimeout(() => {
                    const available = localData.g8_digraphs.filter(w => w.full !== state.g8_currentWord.full);
                    if (available.length > 0) {
                        state.g8_currentWord = shuffleArray(available)[0];
                        callTTS(state.g8_currentWord.full); // 新題目朗讀
                    } else {
                        state.g8_currentWord = { digraph: 'ALL', word: 'DONE', full: 'ALL DONE' };
                        state.g8_gameStatus = 'won';
                    }
                    renderGame8();
                }, 1500);

            } else {
                state.g8_score = Math.max(0, state.g8_score - 1); // 扣分
                MessageBox.show('錯誤！發射失敗！再試試其他組合。', true);
                
                // 錯誤時，不朗讀，但保持當前題目
            }
            renderGame8();
        }

        function renderGame8() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game8') return;

            const wordBlock = state.g8_currentWord;
            const blanks = wordBlock.word.includes('_') ? wordBlock.word.split('_') : ['', ''];
            
            const allDigraphs = [...new Set(localData.g8_digraphs.map(d => d.digraph))];
            const digraphButtons = shuffleArray(allDigraphs).map(d => `
                <button onclick="handleDigraphClickG8('${d}')"
                        class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-3xl font-bold text-white rounded-xl transition duration-150">
                    ${formatDisplayWord(d)}
                </button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">💥 神奇發音機 (digraph blaster)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">目標: 點擊正確的輔音字母組合 (${allDigraphs.map(d => formatDisplayWord(d)).join(', ')}) 來完成單字！</p>
                </section>
                
                <div class="text-center text-2xl font-bold text-gray-700 mb-4">分數: ${state.g8_score}</div>

                ${state.g8_gameStatus !== 'won' ? `
                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    
                    <div class="flex flex-col items-center justify-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">點擊喇叭聽取單字發音:</h3>
                        
                        <div class="flex items-center justify-center space-x-4">
                            <div class="digraph-display-box flex items-center justify-center space-x-2 shadow-lg">
                                <span class="digraph-letter-part">${formatDisplayWord(blanks[0])}</span>
                                <div class="digraph-blank">?</div>
                                <span class="digraph-letter-part">${formatDisplayWord(blanks[1])}</span>
                            </div>
                            <button onclick="callTTS(state.g8_currentWord.full)" 
                                    class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-200"
                                    title="朗讀單字">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2V15H6L11 19V5ZM19.5 12C19.5 14.3283 18.0792 16.3262 16 17.2025V6.7975C18.0792 7.67384 19.5 9.67174 19.5 12ZM16 13C16.8284 13 17.5 12.3284 17.5 11.5C17.5 10.6716 16.8284 10 16 10V13Z"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 w-full max-w-lg">
                        ${digraphButtons}
                    </div>
                </div>
                ` : `<p class="text-4xl font-black text-green-700 p-10">恭喜！您已完成所有挑戰！總分 ${state.g8_score}！</p>`}
                
                <div class="text-center mt-6">
                    <button onclick="initGame8()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">重新開始</button>
                </div>
            `;
        }
        // --- Game 8 End ---

        // --- AI Image Generation Function (NOW SIMULATED EMOJI GENERATION) ---
        // 移除所有 Imagen API 呼叫，轉為 Emoji 提取邏輯
        async function generateEmojiAndAddWord(key, wordPhrase) {
            const addButton = document.getElementById('admin-add-button');
            const originalButtonText = addButton ? '✨ 自動生成 Emoji 並新增' : '新增';

            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> 提取 Emoji 中...';
            }
            
            // 模擬生成/提取
            await new Promise(resolve => setTimeout(resolve, 500)); 

            const newEmoji = generateEmojiFromWord(wordPhrase);
            const newId = crypto.randomUUID();
            let newEntry = null;

            if (key === 'g6_routines') {
                newEntry = { id: newId, word: wordPhrase, emoji: newEmoji, url: `https://placehold.co/150x120/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}` };
                localData[key].push(newEntry);
            } else if (key === 'g7_verbs') {
                newEntry = { id: newId, fullSentence: wordPhrase, emoji: newEmoji, url: `https://placehold.co/150x120/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}` };
                localData[key].push(newEntry);
            }

            if (newEntry) {
                saveWordsToLocal();
                MessageBox.show(`Emoji 提取並新增詞彙成功！Emoji: ${newEmoji}`, false);
                
                // 清空輸入欄位並重新渲染
                document.getElementById('admin-input-1').value = '';
                document.getElementById('admin-input-2').value = '';
                renderWordAdmin();
            } else {
                MessageBox.show("Emoji 提取失敗。", true);
            }
        }

        // --- Admin Panel ---
        const ADMIN_TABS = [
            { key: 'g2_words', name: '🎶 Phonics 配對', isObjectArray: true, hasMultiInput: true },
            { key: 'g3_words', name: '🖍️ Hangman', isObjectArray: false, hasMultiInput: false },
            { key: 'g4_bingo_words', name: '🎤 賓果單字', isObjectArray: false, hasMultiInput: false },
            { key: 'g5_sentences', name: '💬 問句重組', isObjectArray: false, hasMultiInput: false },
            { key: 'g6_routines', name: '🤸 日常活動', isObjectArray: true, hasMultiInput: false },
            // 移除 g7_verbs 的管理區塊
            { key: 'g8_digraphs', name: '💥 發音機', isObjectArray: true, hasMultiInput: true }, // Digraphs has multi input
        ];
        let currentAdminKey = ADMIN_TABS[0].key;

        function getCurrentAdminTab() {
            return ADMIN_TABS.find(t => t.key === currentAdminKey);
        }
        
        // 修正後的 handleBulkAdd 函數
        function handleBulkAdd(inputElement, isObjectArray) {
            const inputContent = inputElement.value.trim();
            if (!inputContent) return;

            const lines = inputContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let addedCount = 0;
            let currentList = localData[currentAdminKey];

            lines.forEach(line => {
                let newEntry = null;

                if (!isObjectArray) {
                    // 對於簡單字串陣列 (Hangman, Bingo, 問句重組)
                    const normalizedEntry = line; // 不再強制大寫
                    // 檢查重複
                    if (!currentList.includes(normalizedEntry)) {
                        newEntry = normalizedEntry;
                    }
                } else {
                    // 對於 Phonics 或 Digraphs 的簡單批量添加：假設輸入格式為：VALUE1,VALUE2,VALUE3
                    const values = line.split(',').map(v => v.trim()); // 不強制大寫，保持原始輸入
                    const newId = crypto.randomUUID();

                    if (currentAdminKey === 'g2_words' && values.length >= 2) {
                        newEntry = { id: newId, phonics: values[0], word: values[1], hint: values[2] || '' };
                    } else if (currentAdminKey === 'g8_digraphs' && values.length >= 3) {
                        newEntry = { id: newId, digraph: values[0], word: values[1], full: values[2] };
                    }
                    
                    // 由於批量添加複雜對象容易出錯，我們只支持單行添加，因此這部分代碼保持單次添加邏輯
                    // 如果需要複雜批量添加，建議使用專門的 CSV/JSON 導入功能，這裡不實現複雜解析。
                    
                }
                
                if (newEntry) {
                    currentList.push(newEntry);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveWordsToLocal(); 
                MessageBox.show(`成功新增 ${addedCount} 個詞彙！`, false);
                inputElement.value = ''; // 清空輸入
                renderWordAdmin();
            } else if (!isObjectArray) {
                 MessageBox.show("請檢查輸入內容是否為新詞彙或是否填寫正確。", true);
            }
        }


        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const currentList = localData[currentAdminKey] || [];
            const currentTab = getCurrentAdminTab();
            
            // 根據類型調整輸入欄位
            let inputField = '';
            let addButtonText = '➕ 新增';

            if (currentAdminKey === 'g2_words') {
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">💡 批量新增：請在第一個欄位輸入，使用逗號分隔 (Phonics,Word,Hint)。**注意：請用大寫輸入來強調單字。**</p>
                    <textarea id="admin-input-1" placeholder="Phonics 組合, 對應單字, 中文提示 (每行一個詞彙)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            } else if (currentAdminKey === 'g8_digraphs') {
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">💡 批量新增：請在第一個欄位輸入，使用逗號分隔 (Digraphs,Incomplete,Full Word)。**注意：請用大寫輸入來強調單字。**</p>
                    <textarea id="admin-input-1" placeholder="Digraphs, 不完整單字, 完整單字 (每行一個詞彙)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            } else if (currentAdminKey === 'g6_routines') {
                // 日常活動
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">💡 日常活動: 完整的動詞片語 (WASH MY FACE)。**注意：請用大寫輸入來強調單字。**</p>
                    <input type="text" id="admin-input-1" placeholder="英文片語/動作 (如: BRUSH TEETH)" maxlength="30" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                    <input type="text" id="admin-input-2" placeholder="圖片URL (留空則自動生成Emoji)" maxlength="100" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                `;
                addButtonText = isGeneratingImage ? addButtonText : '✨ 自動生成 Emoji 並新增';
            } else if (currentAdminKey === 'g7_verbs') {
                 // 動詞連連看 (現在是計算機，所以這個頁面不應該出現)
                 inputField = `<p class="text-lg text-gray-700 w-full text-center">遊戲已更改為 **花費計算機**，此頁面不再需要管理詞彙。</p>`;
                 addButtonText = 'N/A';
            } else {
                // 適用於 G3, G4, G5 的批量新增
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">💡 批量新增：每個單字/句子一行，按 Enter 鍵換行即可。**注意：請用大寫輸入來強調單字。**</p>
                    <textarea id="admin-input-1" placeholder="單字或完整句子 (每行一個詞彙)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            }

            const wordListHtml = currentList.map((item, index) => {
                let display;
                let deleteId;

                if (currentTab.isObjectArray) {
                    // Object Array: Use item.id for deletion
                    // 特殊處理 G6/G7 顯示 Emoji
                    if (currentAdminKey === 'g6_routines') {
                        const verb = item.word || item.verb;
                        const emoji = item.emoji || '';
                        display = `${emoji} / ${formatDisplayWord(verb)} / URL:${item.url.substring(0, 30)}...`;
                    } else if (currentAdminKey === 'g7_verbs') {
                         const sentence = item.fullSentence;
                        const verbParticiple = extractVerbParticiple(sentence);
                        const emoji = item.emoji || '';
                        // 刪除 G7 Admin 的顯示，因為它現在是計算機
                        return ''; 
                    } else {
                        // Phonics/Digraphs 根據原始儲存狀態顯示
                        display = JSON.stringify(item);
                        if (item.phonics) display = `Phonics: ${formatDisplayWord(item.phonics)}, Word: ${formatDisplayWord(item.word)}`;
                        if (item.digraph) display = `Digraph: ${formatDisplayWord(item.digraph)}, Full: ${formatDisplayWord(item.full)}`;
                    }
                    deleteId = item.id;
                } else {
                    // Simple String Array: Filter by Index
                    display = formatDisplayWord(item);
                    deleteId = index;
                }

                return `
                    <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                        <span class="text-sm md:text-lg font-bold text-gray-800">${index + 1}. ${display}</span>
                        <button onclick="deleteWordAdmin('${deleteId}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                            🗑️ 刪除
                        </button>
                    </li>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">⚙️ 單字/設定管理後台 (local storage admin panel)</h2>
                    <p class="text-center text-sm text-pink-100">💡 這裡的單字僅儲存在您當前的瀏覽器中。</p>
                </section>
                
                <div class="flex flex-wrap justify-center space-x-1 mb-4">
                    ${ADMIN_TABS.map(tab => `
                        <button onclick="setCurrentAdminKey('${tab.key}')" class="tab-btn py-2 px-3 ${currentAdminKey === tab.key ? 'bg-secondary-blue text-blue-900 shadow-lg' : 'bg-gray-100 text-gray-700'}">
                            ${tab.name}
                        </button>
                    `).join('')}
                </div>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <label for="admin-input-1" class="block text-lg font-semibold text-gray-800 mb-2">新增 ${currentTab.name} 詞彙</label>
                    <div class="flex space-x-2 flex-wrap">
                        ${inputField}
                        ${currentAdminKey !== 'g7_verbs' ? `<button id="admin-add-button" onclick="addWordAdmin()" 
                                class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150"
                                ${isGeneratingImage ? 'disabled' : ''}>
                            ${addButtonText}
                        </button>` : ''}
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${currentTab.name} 列表 (${currentList.length} 個)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">目前沒有詞彙。請新增！</p>'}
                    </ul>
                    <p class="text-xs text-gray-400 mt-4 text-center">您的設定已自動儲存。</p>
                </div>
            `;
        }
        
        function setCurrentAdminKey(key) {
            currentAdminKey = key;
            // 修正：如果切換到 G7 則直接渲染，跳過 Admin 渲染
            if (key === 'g7_verbs') {
                initGame7();
            } else {
                renderWordAdmin();
            }
        }

        function addWordAdmin() {
            if (isGeneratingImage) return;

            const currentTab = getCurrentAdminTab();

            // 對於非物件陣列（單純的單字或句子）：處理批量添加
            if (!currentTab.isObjectArray) {
                const inputElement = document.getElementById('admin-input-1');
                const inputContent = inputElement ? inputElement.value.trim() : '';
                
                if (!inputContent) {
                    MessageBox.show("請輸入詞彙內容！", true);
                    return;
                }
                
                handleBulkAdd(inputElement, false);
                return;
            }
            
            // 對於物件陣列：只支持單獨添加或批量對象（已簡化為只處理單獨添加以避免複雜性）
            const input1 = document.getElementById('admin-input-1')?.value.trim(); // 保持原始輸入大小寫
            const input2 = document.getElementById('admin-input-2')?.value.trim(); // URL/對應單字

            let newEntry = null;

            // --- 圖片遊戲的 Emoji 提取/Placeholder 邏輯 ---
            const isImageGame = currentAdminKey === 'g6_routines' || currentAdminKey === 'g7_verbs';
            
            if (isImageGame) {
                if (!input1) { MessageBox.show("請填寫英文片語/動作！", true); return; }
                
                // 1. 自動提取 Emoji (使用完整的句子)
                const newEmoji = generateEmojiFromWord(input1);
                
                // 2. 確定 URL (如果 input2 是空的，則生成一個隨機顏色的 Placeholder)
                let finalUrl = input2;
                if (!finalUrl) {
                    const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    finalUrl = `https://placehold.co/150x120/${randomColor}/ffffff?text=${input1.replace(/\s/g, '+')}`;
                }

                const newId = crypto.randomUUID();

                if (currentAdminKey === 'g6_routines') {
                    newEntry = { id: newId, word: input1, emoji: newEmoji, url: finalUrl };
                } else if (currentAdminKey === 'g7_verbs') {
                    // G7: 儲存整個句子，並用完整的句子來生成 Emoji
                    const verbParticiple = extractVerbParticiple(input1.toUpperCase()); // 必須用大寫檢查 ing
                    if (!verbParticiple) {
                         MessageBox.show("動詞連連看句子格式錯誤：請確保句子最後一個詞是動詞 ing 形式。", true); return;
                    }
                    newEntry = { id: newId, fullSentence: input1, emoji: newEmoji, url: finalUrl };
                }
                
            } else if (currentAdminKey === 'g2_words') {
                // Phonics 配對：單行輸入 (Phonics, Word, Hint)
                const line = input1;
                const hint = input2;
                if (!line) { MessageBox.show("請輸入 Phonics 詞彙內容！", true); return; }
                const values = line.split(',').map(v => v.trim()); // 不再強制大寫
                if (values.length >= 2) {
                    newEntry = { id: crypto.randomUUID(), phonics: values[0], word: values[1], hint: values[2] || '' };
                } else {
                     MessageBox.show("Phonics 配對格式錯誤：需要 Phonics 和 Word (例如: IE,PIE,美味的派)", true); return;
                }
            } else if (currentAdminKey === 'g8_digraphs') {
                // Digraphs：單行輸入 (Digraphs, Incomplete, Full Word)
                 const line = input1;
                if (!line) { MessageBox.show("請輸入 Digraphs 詞彙內容！", true); return; }
                const values = line.split(',').map(v => v.trim()); // 不再強制大寫
                if (values.length >= 3) {
                     newEntry = { id: crypto.randomUUID(), digraph: values[0], word: values[1], full: values[2] };
                } else {
                     MessageBox.show("Digraphs 格式錯誤：需要 Digraphs, Incomplete, Full Word (例如: SH,_OP,SHOP)", true); return;
                }
            }
            
            if (!newEntry) { 
                 // 如果是非圖片遊戲，但格式不對，前面已經報錯。這裡只是防止意外。
                 if (!isImageGame) return; 
                 MessageBox.show("請填寫所有必要的欄位！", true); return; 
            }

            // 檢查重複 (對於物件陣列)
            const list = localData[currentAdminKey];
            if (currentTab.isObjectArray && list.some(item => (item.word || item.fullSentence || item.full) === (newEntry.word || newEntry.fullSentence || newEntry.full))) {
                 MessageBox.show("詞彙已存在！", true); return;
            }


            localData[currentAdminKey].push(newEntry);
            saveWordsToLocal();
            MessageBox.show(`詞彙新增成功！`, false);
            // 清空輸入欄位
            document.getElementById('admin-input-1').value = '';
            if (document.getElementById('admin-input-2')) document.getElementById('admin-input-2').value = '';
            if (document.getElementById('admin-input-3')) document.getElementById('admin-input-3').value = '';
            renderWordAdmin();
        }

        function deleteWordAdmin(id) {
            if (isGeneratingImage) {
                MessageBox.show("圖片生成中，請稍候再試。", true);
                return;
            }
            
            const currentTab = getCurrentAdminTab();
            const list = localData[currentAdminKey];

            if (currentTab.isObjectArray) {
                // Object Array: Filter by ID
                localData[currentAdminKey] = list.filter(item => item.id !== id);
            } else {
                // Simple String Array: Filter by Index
                const indexToDelete = parseInt(id);
                if (!isNaN(indexToDelete) && indexToDelete >= 0 && indexToDelete < list.length) {
                    localData[currentAdminKey].splice(indexToDelete, 1);
                }
            }
            
            saveWordsToLocal(); // 修正: 呼叫正確的儲存函數
            MessageBox.show("詞彙刪除成功！", false);
            renderWordAdmin();
        }
        // --- Admin Panel End ---
    </script>
</body>
</html>
