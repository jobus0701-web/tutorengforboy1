<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’ğŸ†•</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* å®šç¾©å¯æ„›çš„å¡é€šå­—é«”ï¼Œä½¿ç”¨ Inter æ­é…åœ“è§’å’Œç²—é«”ç‡Ÿé€ ç«¥è¶£æ„Ÿ */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* æ¸¸æ¨™é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .key-btn {
            height: 50px; /* Base height */
            transition: all 0.1s;
            text-transform: none; /* é è¨­ç‚ºå°å¯«/æ­£å¸¸ */
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        /* ç‰¹åˆ¥é‡å°æŒ‰éˆ•å…ƒç´ ä¸­çš„æ–‡å­—å¼·åˆ¶ä½¿ç”¨å°å¯« (é™¤éç‰¹åˆ¥é‡å¯«) */
        button.key-btn {
            text-transform: lowercase;
        }
        /* è¨ˆç®—æ©ŸæŒ‰éµç¶­æŒåŸæ¨£ */
        .calc-key {
            text-transform: none !important;
        }


        /* Game 2: è¨˜æ†¶å¡ç‰‡ */
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important;
            border-color: #3CB371 !important;
            color: #1E40AF !important;
            cursor: default;
        }
        /* Game 2 é¡è‰²è¦†è“‹ */
        .card-type-phonics {
            background-color: #FFEC99; /* Accent Yellow */
            border-color: #FFD700;
        }
        .card-type-word {
            background-color: #BDE0FE; /* Secondary Blue */
            border-color: #89CFF0;
        }


        /* Game 4: Bingo */
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
            text-transform: lowercase; /* è³“æœå¡ç‰‡é è¨­ç‚ºå°å¯« */
        }
        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        
        /* Game 5: å•å¥é‡çµ„å¤§å¸« */
        .word-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            height: 45px;
            padding: 0 10px;
            margin: 5px;
            background-color: #FFC7C7; 
            border: 3px solid #FF8FAB;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 3px 0 0 #D1A3A3;
            text-transform: none; /* è©å¡Šå°‡ç”± JS è™•ç†å¤§å°å¯« */
        }
        
        /* ä¿®æ­£ Game 5 ç­”æ¡ˆå€å¡Šï¼Œç¢ºä¿è©å¡Šé–“éš” (é—œéµä¿®æ­£) */
        .g5-answer-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* å¢åŠ è©å¡Šé–“çš„é–“éš” */
        }
        .answer-slot {
            min-width: 80px;
            height: 50px;
            padding: 5px;
            border: 3px dashed #BDE0FE;
            border-radius: 10px;
            background-color: #F0F8FF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #4A5568;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .answer-slot.incorrect {
            animation: shake 0.3s 2;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* Game 6, 7, 8: é…å°èˆ‡æ‹–æ›³åº•åº§ */
        .image-target {
            min-height: 120px;
            background-color: #fff;
            border: 3px solid #FF8FAB;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .drag-source {
            cursor: grab;
            user-select: none;
            box-shadow: 0 3px 0 0 #D1A3A3;
            transition: transform 0.1s;
        }
        .drag-source:active {
            cursor: grabbing;
            box-shadow: 0 1px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        .drag-area {
            border: 3px dashed #BDE0FE;
            border-radius: 12px;
            min-height: 150px;
            padding: 10px;
        }
        
        /* Game 8 å°ˆç”¨æ¨£å¼ */
        .digraph-display-box {
            min-width: 150px;
            min-height: 100px;
            background-color: #f0f0f0;
            border: 5px solid #FF8FAB;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .digraph-letter-part {
            font-size: 4rem;
            font-weight: 900;
            color: #1E40AF; /* æ·±è—è‰² */
            display: inline-block;
        }
        .digraph-blank {
            width: 80px;
            height: 80px;
            background-color: #FFEC99;
            border: 4px dashed #FFD700;
            border-radius: 10px;
            display: inline-flex; /* ä¿®æ­£ç‚º inline-flex è®“å…¶èˆ‡æ–‡å­—åŒè¡Œ */
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #D1A3A3;
            margin: 0 5px; /* å¢åŠ é–“è· */
        }
        /* Game 7 Calculator Styles */
        .calc-display {
            background-color: #2c3e50; /* æ·±è—ç°è‰² */
            color: #ffffff;
            text-align: right;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            font-size: 3rem;
            font-weight: 700;
            font-family: monospace;
            overflow-x: auto;
            white-space: nowrap;
        }
        .calc-key {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.1s;
        }
        .calc-key-number {
            background-color: #ecf0f1; /* æ·ºç°è‰² */
            color: #2c3e50;
        }
        .calc-key-operator {
            background-color: #f39c12; /* æ©˜è‰² */
            color: white;
        }
        .calc-key-clear {
            background-color: #e74c3c; /* ç´…è‰² */
            color: white;
        }
        .calc-key-equal {
            background-color: #2ecc71; /* ç¶ è‰² */
            color: white;
        }
        /* Game 6 ç‰©å“åç¨±å’Œ Game 7 æç¤ºæ¬„å¼·åˆ¶å°å¯« */
        .item-name-display {
            text-transform: lowercase;
        }
        
        /* File Upload Styles */
        .file-upload-container {
            display: flex;
            align-items: center;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .file-upload-input {
            width: 100%;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }
        /* Admin Inline Edit styles */
        .admin-input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            margin-bottom: 4px;
        }

    </style>

    <script>
        // è¨­å®š Tailwind é…ç½®, ä½¿ç”¨æŸ”å’Œå¯æ„›çš„é¦¬å¡é¾é…è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      
                        'secondary-blue': '#BDE0FE',    
                        'accent-yellow': '#FFEC99',     
                        'background-light': '#F8F8F8',  
                        'keyboard-bg': '#FFF5D6',       
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    
                        'key-active': '0 2px 0 0 #D1A3A3', 
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <!-- ä¿®æ­£: æç¤ºæ¡†çµ±ä¸€æ§åˆ¶ï¼Œé¡¯ç¤º 0.5 ç§’å¾Œæ¶ˆå¤± (500ms) -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡å°èˆª -->
    <header class="w-full max-w-6xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- å¯æ„›å°è±¬åœ–ç¤º (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.1716 9 9 9Z" fill="#FF8FAB"/><path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/><circle cx="11" cy="13" r="1" fill="#FF8FAB"/><circle cx="13" cy="13" r="1" fill="#FF8FAB"/></svg>
            è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’ğŸ†•
        </h1>
    </header>

    <!-- å°èˆªåˆ— -->
    <nav class="w-full max-w-6xl mb-6">
        <div class="grid grid-cols-4 gap-2 md:gap-4 justify-center" id="game-nav">
            
            <button data-game="game2" class="tab-btn">ğŸ¶ é…å°</button>
            <button data-game="game3" class="tab-btn">ğŸ–ï¸ Hangman</button>
            <button data-game="game4" class="tab-btn">ğŸ¤ è³“æœ</button>
            <button data-game="game5" class="tab-btn">ğŸ’¬ å•å¥</button>
            
            <button data-game="game6" class="tab-btn">ğŸ¤¸ æ—¥å¸¸</button>
            <button data-game="game7" class="tab-btn">ğŸ’° èŠ±è²»è¨ˆç®—æ©Ÿ</button>
            <button data-game="game8" class="tab-btn">ğŸ’¥ ç™¼éŸ³æ©Ÿ</button>
            <button data-game="admin" class="tab-btn">âš™ï¸ å¾Œå°</button>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="game-content" class="w-full max-w-6xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[600px]">
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼...</p>
        </div>
    </main>
    
    <script>
        // --- å…¨åŸŸè¨­å®šèˆ‡å·¥å…· ---
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split('');
        const LOCAL_STORAGE_KEY = 'GAMES_CUSTOM_DATA_V2';
        const G4_BINGO_SIZE = 4;
        
        // æ–°å¢: Quiz ç›¸é—œè¨­å®š
        const MAX_QUESTIONS = 10; // G2, G5, G6, G7, G8 å›åˆæ•¸ä¸Šé™

        let currentGame = 'game2'; 
        let localData = {}; // å­˜æ”¾æ‰€æœ‰éŠæˆ²çš„è‡ªè¨‚æ•¸æ“š
        
        // Hangman Emoji æç¤ºåº« (ä¿æŒä¸è®Š)
        const G3_EMOJI_HINTS = {
            'PUPPET': 'ğŸ', 'SKATEBOARD': 'ğŸ›¹', 'HISTORY': 'ğŸ›ï¸', 'HARD': 'ğŸ’ª', 'EASY': 'ğŸ˜Œ', 
            'DOLLAR': 'ğŸ’µ', 'HAND': 'ğŸ–ï¸', 'FOOT': 'ğŸ¦¶', 'SCIENCE': 'ğŸ”¬', 'MATHS': 'â•',
            'EAR': 'ğŸ‘‚', 'EYE': 'ğŸ‘ï¸', 'HEAD': 'ğŸ‘¤', 'NOSE': 'ğŸ‘ƒ', 'MOUTH': 'ğŸ‘„', 'ARM': 'ğŸ’ª', 'LEG': 'ğŸ¦µ'
        };

        // å¸¸ç”¨å‹•è©å’Œæ—¥å¸¸æ´»å‹•çš„ Emoji æ˜ å°„è¡¨ (ä¿æŒä¸è®Š)
        const ACTION_EMOJI_MAP = {
            'RUN': 'ğŸƒ', 'TALK': 'ğŸ—£ï¸', 'REST': 'ğŸ›Œ', 'EAT': 'ğŸ”', 'LISTEN': 'ğŸ§', 
            'PAINT': 'ğŸ¨', 'JUMP': 'ğŸ¤¸', 'WALK': 'ğŸš¶', 'JOG': 'ğŸƒ', 'SKIP': 'ç¸„',
            'WASH': 'ğŸš¿', 'FACE': 'ğŸ™‚', 'TEETH': 'ğŸ¦·', 'BRUSH': 'ğŸ–Œï¸', 'HAIR': 'ğŸ’‡', 
            'DO': 'âœ…', 'HOMEWORK': 'ğŸ“š', 'PLAY': 'ğŸ®', 'PHONE': 'ğŸ“±', 'IS': 'ğŸ‘‰', 
            'I': 'ğŸ™‹', 'YOU': 'ğŸ‘¤', 'HE': 'ğŸ‘¦', 'SHE': 'ğŸ‘§', 'IT': 'ğŸ¶', 'WE': 'ğŸ‘¥', 'THEY': 'ğŸ‘«' 
        };
        
        // Present Continuous ä¸»è©-Beå‹•è©çµ„åˆ (ä¿æŒä¸è®Š)
        const G7_SUBJECT_FORMS = [
            'I AM', 'YOU ARE', 'HE IS', 'SHE IS', 'IT IS', 'WE ARE', 'THEY ARE'
        ];

        // é è¨­å–®å­—åº« (G8 çµæ§‹å·²æ›´æ–°ä»¥æ”¯æ´ MAGIC_E)
        const DEFAULT_WORDS = {
            g2_words: [
                { id: crypto.randomUUID(), phonics: 'A-E', word: 'CAKE', hint: 'ç”Ÿæ—¥è›‹ç³•' },
                { id: crypto.randomUUID(), phonics: 'IE', word: 'PIE', hint: 'ç¾å‘³çš„æ´¾' },
                { id: crypto.randomUUID(), phonics: 'OO', word: 'FOOD', hint: 'å¥½åƒçš„é£Ÿç‰©' },
                { id: crypto.randomUUID(), phonics: 'EW', word: 'NEW', hint: 'æ–°çš„' },
                { id: crypto.randomUUID(), phonics: 'OA', word: 'BOAT', hint: 'ä¸€è‰˜èˆ¹' },
                { id: crypto.randomUUID(), phonics: 'EE', word: 'BEE', hint: 'å°èœœèœ‚' },
            ],
            g3_words: ['PUPPET', 'SKATEBOARD', 'HISTORY', 'HARD', 'EASY', 'DOLLAR', 'HAND', 'FOOT', 'EAR', 'EYE'],
            g4_bingo_words: ['SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY', 'HUNDRED', 'THOUSAND', 'DOLLAR', 'HOSPITAL', 'PARK', 'BANK', 'COAT', 'JEANS', 'GLOVES', 'HAT', 'SCARF', 'TIE'],
            g5_sentences: [
                "What does he do after school?",
                "When does she have English?",
                "How much is the skateboard?",
                "How many legs does it have?",
                "Is the yellow one longer?",
                "I'm going to the airport."
            ],
            g6_routines: [
                { id: crypto.randomUUID(), word: 'WASH HIS FACE', emoji: 'ğŸš¿ğŸ™‚', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=WASH%20FACE' },
                { id: crypto.randomUUID(), word: 'DO HER HOMEWORK', emoji: 'ğŸ‘§ğŸ“š', url: 'https://placehold.co/150x120/ff8a65/000000?text=DO%20HOMEWORK' },
                { id: crypto.randomUUID(), word: 'BRUSH HIS TEETH', emoji: 'ğŸ‘¦ğŸ¦·', url: 'https://placehold.co/150x120/9ccc65/000000?text=BRUSH%20TEETH' },
                { id: crypto.randomUUID(), word: 'PLAY ON HIS PHONE', emoji: 'ğŸ®ğŸ“±', url: 'https://placehold.co/150x120/ab47bc/ffffff?text=PLAY%20PHONE' },
            ],
            // Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ - çµ±ä¸€ä½¿ç”¨ pattern å’Œ word_template
            g8_digraphs: [
                // Digraphs
                { id: crypto.randomUUID(), pattern: 'SH', word_template: '?OP', full: 'SHOP' },
                { id: crypto.randomUUID(), pattern: 'CH', word_template: '?AT', full: 'CHAT' },
                { id: crypto.randomUUID(), pattern: 'TH', word_template: '?INK', full: 'THINK' },
                { id: crypto.randomUUID(), pattern: 'WH', word_template: '?ALE', full: 'WHALE' },
                { id: crypto.randomUUID(), pattern: 'PH', word_template: 'ELE?ANT', full: 'ELEPHANT' },
                // Magic E (é•·æ¯éŸ³) - pattern åŒ…å« _, template åŒ…å«å¤šå€‹ ?
                { id: crypto.randomUUID(), pattern: 'A_E', word_template: 'C?KE', full: 'CAKE' },
                { id: crypto.randomUUID(), pattern: 'I_E', word_template: 'F?VE', full: 'FIVE' },
                { id: crypto.randomUUID(), pattern: 'O_E', word_template: 'N?S?', full: 'NOSE' },
                { id: crypto.randomUUID(), pattern: 'U_E', word_template: 'T?BE', full: 'TUBE' },
            ],
        };

        // éš¨æ©Ÿç‰©å“å’Œåƒ¹æ ¼åˆ—è¡¨ (ä¿æŒä¸è®Š)
        const SHOP_ITEMS = [
            { name: "SKATEBOARD", emoji: "ğŸ›¹", maxPrice: 200 }, 
            { name: "PUPPET", emoji: "ğŸ§¸", maxPrice: 200 },
            { name: "ACTION FIGURE", emoji: "ğŸ¦¸", maxPrice: 200 },
            { name: "MODEL PLANE", emoji: "âœˆï¸", maxPrice: 200 },
            { name: "BARBIE DOLL", emoji: "ğŸ‘¸", maxPrice: 200 },
            { name: "BACKPACK", emoji: "ğŸ’", maxPrice: 200 },
        ];


        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        let state = {
            // G2
            g2_matchCards: [], g2_flippedCards: [], g2_matchCount: 0, g2_gameStatus: 'ready',
            g2_score: 0, g2_currentQuestion: 0, 
            // G3
            g3_currentWord: '', g3_currentGuessWord: '', g3_guessedLetters: new Set(), g3_wrongGuesses: 0, g3_gameStatus: 'ready', g3_MAX_WRONG: 6, g3_emojiHint: '', 
            g3_score: 0, g3_currentQuestion: 0,
            // G4 (Quiz removed, keeping score for G4 in case user wants to track lines won)
            g4_players: [], g4_calledWords: new Set(), g4_lastCalledWord: '', g4_gameStatus: 'ready', g4_isCalling: false,
            g4_score: 0, g4_currentQuestion: 0,
            // G5
            g5_currentSentence: '', g5_answerWords: [], g5_scrambleBlocks: [], g5_currentSort: [], g5_gameStatus: 'ready',
            g5_score: 0, g5_currentQuestion: 0,
            // G6
            g6_targets: [], g6_sources: [], g6_matches: 0, g6_gameStatus: 'ready',
            g6_score: 0, g6_currentQuestion: 0,
            // G7 (Cost Calculator)
            g7_items: [],
            g7_totalCost: 0,
            g7_displayValue: '', 
            g7_calculator: { 
                currentValue: '0', memory: 0, operator: null, resetDisplay: true, calcDisplay: '0'
            },
            g7_gameStatus: 'ready',
            g7_score: 0, g7_currentQuestion: 0,
            // G8
            g8_currentWord: null, g8_gameStatus: 'ready',
            g8_score: 0, g8_currentQuestion: 0,
        };
        
        // --- Admin ç‹€æ…‹ç®¡ç† (æ–°å¢) ---
        let adminState = {
            editId: null, // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ ID
            selectedIds: new Set(), // æ‰¹é‡åˆªé™¤é¸ä¸­çš„ ID é›†åˆ
            currentAdminKey: 'g2_words',
            isAllSelected: false,
        };

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ï¼šEmoji/Word/Number Utilities (ä¿æŒä¸è®Š) ---
        function generateEmojiFromWord(wordPhrase) {
            // ... (Emoji æå–é‚è¼¯) ...
            const tokens = wordPhrase.split(/\s+/).map(t => t.replace(/[^A-Z]/g, ''));
            let generatedEmoji = '';

            tokens.forEach(token => {
                let found = false;
                if (ACTION_EMOJI_MAP[token]) {
                    generatedEmoji += ACTION_EMOJI_MAP[token];
                    found = true;
                }
                
                if (!found && token.endsWith('ING')) {
                    const baseVerb = token.slice(0, -3);
                    if (ACTION_EMOJI_MAP[baseVerb]) {
                        generatedEmoji += ACTION_EMOJI_MAP[baseVerb];
                        found = true;
                    }
                }

                for (const key in ACTION_EMOJI_MAP) {
                    if (token.includes(key) && key.length > 2 && !generatedEmoji.includes(ACTION_EMOJI_MAP[key])) {
                        generatedEmoji += ACTION_EMOJI_MAP[key];
                        found = true;
                    }
                }
            });

            if (generatedEmoji.length === 0) {
                const randomEmojis = ['ğŸŒŸ', 'ğŸ’¡', 'âœ…', 'ğŸŒˆ'];
                generatedEmoji = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            }
            
            return generatedEmoji.trim();
        }
        
        function formatDisplayWord(word, isSentenceStart = false) {
            if (typeof word !== 'string') return word;
            if (word.length === 0) return word;

            const hasUpperCase = /[A-Z]/.test(word);
            const hasLowerCase = /[a-z]/.test(word);
            
            if (word.toUpperCase() === 'I') {
                return 'I';
            }

            if (hasUpperCase || hasLowerCase) {
                return word; 
            }
            
            if (isSentenceStart && word.match(/^[a-z]/i)) {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }

            return word.toLowerCase();
        }
        
        function extractVerbParticiple(fullSentence) {
            const parts = fullSentence.split(' ').map(p => p.trim());
            if (parts.length > 0 && parts[parts.length - 1].endsWith('ING')) {
                return parts[parts.length - 1]; 
            }
            return null;
        }

        const ONES = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
        const TEENS = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
        const TENS = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
        
        function numberToWords(num) {
            if (num < 0 || num > 999999) return "NUMBER OUT OF RANGE";
            if (num === 0) return "ZERO";

            function convertLessThanThousand(n) {
                let s = '';
                if (n >= 100) {
                    s += ONES[Math.floor(n / 100)] + ' HUNDRED';
                    n %= 100;
                    if (n > 0) s += ' '; 
                }
                if (n >= 10 && n <= 19) {
                    s += TEENS[n - 10];
                } else if (n >= 20) {
                    s += TENS[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) s += '-';
                }
                if (n > 0 && n < 10) {
                    s += ONES[n];
                }
                return s.trim().replace(/\s+/g, ' '); 
            }

            return convertLessThanThousand(num).replace('AND', ''); 
        }
        
        // --- TTS & Utility (ä¿æŒä¸è®Š) ---
        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                console.warn("SpeechSynthesis not supported.");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => { console.error("SpeechSynthesis error:", e); resolve(); };
                window.speechSynthesis.speak(utterance);
            });
        }

        const MessageBox = {
            // ä¿®æ­£: æç¤ºæ¡†çµ±ä¸€æ§åˆ¶ï¼Œé¡¯ç¤º 0.5 ç§’å¾Œæ¶ˆå¤± (500ms)
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                // ä¿®æ­£ç‚º 500ms
                setTimeout(() => box.classList.add('hidden'), 500);
            }
        };

        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        // --- Quiz çµæ§‹æ–°å¢ ---
        function setupQuiz(gameKey) {
            state[`${gameKey}_score`] = 0;
            state[`${gameKey}_currentQuestion`] = 1;
            state[`${gameKey}_gameStatus`] = 'playing';
        }
        
        function checkQuizEnd(gameKey, isCorrect) {
            if (isCorrect) {
                state[`${gameKey}_score`]++;
            }
            
            state[`${gameKey}_currentQuestion`]++;

            if (state[`${gameKey}_currentQuestion`] > MAX_QUESTIONS) {
                state[`${gameKey}_gameStatus`] = 'finished';
                MessageBox.show(`æŒ‘æˆ°å®Œæˆï¼æ‚¨çš„ç¸½å¾—åˆ†æ˜¯ ${state[`${gameKey}_score`]} / ${MAX_QUESTIONS}ï¼ğŸ‰`, false);
                return true;
            }
            return false;
        }

        // --- LocalStorage å­˜å„²åŠŸèƒ½ (çµ±ä¸€ç®¡ç†æ‰€æœ‰éŠæˆ²æ•¸æ“š) ---
        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loaded = stored ? JSON.parse(stored) : {};
                
                localData = JSON.parse(JSON.stringify(DEFAULT_WORDS));
                
                for (const key in loaded) {
                    if (Array.isArray(loaded[key])) {
                        localData[key] = loaded[key].map(item => {
                            if (typeof item === 'object' && item !== null && !item.id) {
                                return { ...item, id: crypto.randomUUID() };
                            }
                            // ä¿®æ­£ï¼šç¢ºä¿ Hangman/Bingo (string array) ä»èƒ½è¢«æ­£ç¢ºè¼‰å…¥
                            if (typeof item === 'string') {
                                return item;
                            }
                            return item;
                        }).filter(item => item !== null && item !== undefined); 
                    }
                }
                
                // ç¢ºä¿ Hangman/Bingo å–®å­—éƒ½æ˜¯å­—ä¸²
                localData.g3_words = localData.g3_words.filter(w => typeof w === 'string');
                localData.g4_bingo_words = localData.g4_bingo_words.filter(w => typeof w === 'string');
                localData.g5_sentences = localData.g5_sentences.filter(w => typeof w === 'string');


            } catch (e) {
                console.error("Error loading words from local storage:", e);
                localData = DEFAULT_WORDS;
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("ç„¡æ³•ä¿å­˜å–®å­—åˆ°æ‚¨çš„ç€è¦½å™¨ã€‚", true);
            }
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æ§åˆ¶ (ä¿æŒä¸è®Š) ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.querySelector(`.tab-btn[data-game="${gameName}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); // æ¯æ¬¡æ¸²æŸ“å‰è¼‰å…¥

            switch (currentGame) {
                
                case 'game2': initGame2(); break;
                case 'game3': initGame3(); break;
                case 'game4': initGame4(); break;
                case 'game5': initGame5(); break;
                case 'game6': initGame6(); break;
                case 'game7': initGame7(); break;
                case 'game8': initGame8(); break;
                case 'admin': renderWordAdmin(); break;
                default: document.getElementById('game-content').innerHTML = `<p class="text-xl text-gray-500 text-center p-10">è«‹é¸æ“‡ä¸€å€‹éŠæˆ²</p>`;
            }
        }

        window.onload = function() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('bg-white', 'hover:bg-secondary-blue', 'py-2', 'px-3', 'md:px-4', 'rounded-full', 'text-xs', 'md:text-sm', 'font-bold', 'text-gray-700', 'transition', 'duration-300', 'shadow-md');
                
                const gameName = btn.getAttribute('data-game');
                if (gameName) {
                    btn.addEventListener('click', () => changeGame(gameName));
                }
            });

            setTabActive(currentGame);
            renderApp();
        }

        // --- Game 2: ğŸ¶ Phonics ç™¼éŸ³é…å° (Vowel Sound Match) ---
        let g2_currentSource = [];

        function initGame2() {
            const source = localData.g2_words;
            if (source.length < 4) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢è‡³å°‘ 4 çµ„ Phonics é…å°å–®å­—ï¼", true); return; }

            setupQuiz('g2');

            // éš¨æ©Ÿé¸å– 10 çµ„é…å°ä½œç‚ºé¡Œåº«ä¾†æº (å¦‚æœå°‘æ–¼ 10 çµ„ï¼Œå‰‡å…¨éƒ¨é¸å–)
            g2_currentSource = shuffleArray(source).slice(0, MAX_QUESTIONS);
            
            // é–‹å§‹ç¬¬ä¸€å€‹å›åˆ
            startNextRoundG2();
        }
        
        function startNextRoundG2() {
            if (state.g2_gameStatus === 'finished') return;

            const currentPair = g2_currentSource[state.g2_currentQuestion - 1];
            if (!currentPair) {
                 checkQuizEnd('g2', false); // ç¢ºä¿åœ¨é¡Œåº«ç”¨ç›¡æ™‚çµæŸ
                 return;
            }

            // 1. é™åˆ¶å¡ç‰‡å°æ•¸ç‚º 1 çµ„ (2 å¼µå¡ç‰‡)
            state.g2_matchCount = 0;
            state.g2_flippedCards = [];

            let cardValues = [];
            const groupId = `match-${currentPair.phonics}`;

            // Phonics å¡ç‰‡
            cardValues.push({ id: crypto.randomUUID(), type: 'PHONICS', value: currentPair.phonics, groupId, matched: false, flipped: false, hint: currentPair.hint });
            // Word å¡ç‰‡
            cardValues.push({ id: crypto.randomUUID(), type: 'WORD', value: currentPair.word, groupId, matched: false, flipped: false, hint: currentPair.hint });
            
            // åŠ å…¥ 2 çµ„å¹²æ“¾é …
            const decoys = shuffleArray(localData.g2_words.filter(w => w.phonics !== currentPair.phonics)).slice(0, 2);
            decoys.forEach(decoy => {
                cardValues.push({ id: crypto.randomUUID(), type: 'PHONICS', value: decoy.phonics, groupId: 'decoy-' + decoy.phonics, matched: false, flipped: false, hint: 'Decoy' });
            });

            state.g2_matchCards = shuffleArray(cardValues);
            renderGame2();
        }

        async function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card || card.matched || card.flipped || state.g2_flippedCards.length === 2 || state.g2_gameStatus !== 'playing') return;

            card.flipped = true;
            state.g2_flippedCards.push(card);
            
            // é»æ“Šå¡ç‰‡æ™‚ï¼Œä¸åŸ·è¡Œ callTTS

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                // æª¢æŸ¥æ˜¯å¦ç‚ºåŒä¸€çµ„ï¼Œä¸¦ä¸”æ˜¯ Phonics å’Œ Word çš„é…å°
                const isCorrectMatch = card1.groupId === card2.groupId && card1.groupId.startsWith('match-') && card1.type !== card2.type;
                
                if (isCorrectMatch) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    state.g2_flippedCards = [];
                    renderGame2();
                    
                    MessageBox.show("æ­£ç¢ºé…å°ï¼+1 åˆ†ï¼âœ…", false);

                    if (!checkQuizEnd('g2', true)) {
                        setTimeout(startNextRoundG2, 1500); // å»¶é² 1.5 ç§’é€²å…¥ä¸‹ä¸€å›åˆ
                    }

                } else {
                    // éŒ¯èª¤æˆ–å¹²æ“¾é …ç¿»é–‹
                    setTimeout(() => {
                        state.g2_matchCards.forEach(c => {
                            if (c.id === card1.id || c.id === card2.id) c.flipped = false;
                        });
                        state.g2_flippedCards = [];
                        renderGame2();
                        MessageBox.show("é…å°éŒ¯èª¤ï¼Œè«‹å†è©¦è©¦ï¼", true);
                    }, 1000);
                }
            }
            renderGame2();
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-lg md:text-2xl font-extrabold text-gray-800`;
                let openCardColorClass = card.type === 'PHONICS' ? 'card-type-phonics' : 'card-type-word';
                let hiddenCardContent = card.type === 'PHONICS' ? 'phonics' : 'word'; 


                if (card.matched || state.g2_gameStatus === 'finished') {
                    cardClasses += ` matched-success`;
                    content = `${formatDisplayWord(card.phonics)} / ${formatDisplayWord(card.word || card.value)}`; 
                } else if (card.flipped) {
                    cardClasses += ` ${openCardColorClass} border-gray-500`;
                    content = card.type === 'PHONICS' ? `[${formatDisplayWord(card.value)}]` : formatDisplayWord(card.value); 
                } else {
                    cardClasses += ` bg-primary-pink border-pink-400`; 
                    content = hiddenCardContent; 
                    innerTextClass = `text-base md:text-xl font-bold text-gray-800`; 
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" data-card-id="${card.id}">
                        <div class="${cardClasses}">
                            <div class="text-center">
                                <span class="${innerTextClass}">
                                    ${content}
                                </span>
                                ${card.flipped && card.type === 'WORD' ? `<p class="text-xs text-gray-600 mt-1">(${card.hint})</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setTimeout(() => {
                document.querySelectorAll('#match-game-grid [data-card-id]').forEach(elem => {
                    elem.addEventListener('click', () => handleCardClickG2(elem.dataset.cardId));
                });
            }, 0);
            
            const quizInfo = state.g2_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g2_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g2_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g2_score})</p>`;

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-2 text-center">ğŸ¶ phonics ç™¼éŸ³é…å° (vowel sound match)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šå¡ç‰‡ï¼Œé…å°é•·æ¯éŸ³çµ„åˆå’Œå°æ‡‰çš„å–®å­—ã€‚å–®å­—åº«ç¸½æ•¸: ${localData.g2_words.length} çµ„ã€‚</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-xl mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_gameStatus === 'finished' ? 'é‡æ–°æŒ‘æˆ°' : 'é‡è¨­éŠæˆ²'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- Game 2 End ---

        // --- Game 3: ğŸ–ï¸ Hangman çŒœå–®å­— (Hangman) ---
        // ç”±æ–¼ Hangman æ˜¯å–®ä¸€æŒ‘æˆ°ï¼Œæˆ‘å€‘å°‡å…¶è¦–ç‚º 10 å›åˆçš„é€£çºŒæŒ‘æˆ°
        let g3_wordHistory = new Set();
        
        function getHangmanSVG(wrongGuesses, status) {
            // ... (Hangman SVG ç¹ªè£½é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            const fillStyle = `fill="none" stroke="${color}" stroke-width="6"`;
            const base = 180; 

            parts.push(`<line x1="50" y1="${base}" x2="150" y2="${base}" ${fillStyle}/>`); 
            parts.push(`<line x1="100" y1="${base}" x2="100" y2="20" ${fillStyle}/>`); 
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" ${fillStyle}/>`); 
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 
            parts.push(`<line x1="100" y1="60" x2="160" y2="20" ${fillStyle} stroke-width="4"/>`); 

            if (wrongGuesses >= 1) {
                parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            }
            if (wrongGuesses >= 2) {
                parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            }
            if (wrongGuesses >= 3) {
                parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            }
            if (wrongGuesses >= 4) {
                parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            }
            if (wrongGuesses >= 5) {
                parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            }
            if (wrongGuesses >= 6) {
                parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            }
            
            return `<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">${parts.join('')}</svg>`;
        }
        
        function getEmojiHint(word) {
            // ... (Emoji æç¤ºé‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
            const upperCaseWord = word.toUpperCase();
            if (G3_EMOJI_HINTS[upperCaseWord]) {
                return G3_EMOJI_HINTS[upperCaseWord];
            }
            
            for (const key in G3_EMOJI_HINTS) {
                if (upperCaseWord.includes(key) && key.length >= 2) { 
                    return G3_EMOJI_HINTS[key];
                }
            }
            
            return 'â“';
        }

        function initGame3() {
            const source = localData.g3_words;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ hangman å–®å­—ï¼", true); return; }

            setupQuiz('g3');
            g3_wordHistory = new Set();
            
            startNextRoundG3(); 
        }
        
        function startNextRoundG3() {
            if (state.g3_gameStatus === 'finished') return;

            const availableWords = localData.g3_words.filter(w => !g3_wordHistory.has(w));
            if (availableWords.length === 0) {
                 // å¦‚æœå–®å­—ç”¨ç›¡ï¼Œé‡æ–°é–‹å§‹è¨ˆæ•¸
                 g3_wordHistory = new Set();
            }
            
            const wordsToChoose = localData.g3_words.filter(w => !g3_wordHistory.has(w));
            const randomWord = shuffleArray(wordsToChoose.length > 0 ? wordsToChoose : localData.g3_words)[0];
            
            g3_wordHistory.add(randomWord);

            state.g3_currentWord = randomWord; 
            state.g3_currentGuessWord = randomWord.toUpperCase(); 
            
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            state.g3_emojiHint = getEmojiHint(state.g3_currentGuessWord);
            
            renderGame3(); 
        }


        function guessLetterG3(letter) {
            const upperCaseLetter = letter.toUpperCase();
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(upperCaseLetter)) return;
            
            state.g3_guessedLetters.add(upperCaseLetter);
            const isCorrect = state.g3_currentGuessWord.includes(upperCaseLetter);
            
            if (!isCorrect) state.g3_wrongGuesses++;
            
            const winCondition = checkWinConditionG3();

            if (winCondition) {
                MessageBox.show(`æ­£ç¢ºï¼å–®å­—æ˜¯ ${state.g3_currentWord}ï¼+1 åˆ†ï¼âœ…`, false);
                if (!checkQuizEnd('g3', true)) {
                    setTimeout(startNextRoundG3, 1500);
                }
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`å¾ˆå¯æƒœã€‚æ­£ç¢ºå–®å­—æ˜¯ ${state.g3_currentWord}ã€‚0 åˆ†ã€‚`, true);
                if (!checkQuizEnd('g3', false)) {
                     setTimeout(startNextRoundG3, 1500);
                }
            }
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                return true;
            } 
            return false;
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;
            
            const rawWord = state.g3_currentWord;

            const displayWord = rawWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const upperCaseChar = char.toUpperCase();
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost' || state.g3_gameStatus === 'finished';
                
                if (state.g3_guessedLetters.has(upperCaseChar) || isGameOver) {
                    return formatDisplayWord(char); 
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                const upperCaseLetter = letter.toUpperCase();
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(upperCaseLetter)) {
                    btnClass = state.g3_currentGuessWord.includes(upperCaseLetter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }
                if (state.g3_gameStatus !== 'playing') { btnClass = 'bg-gray-300 cursor-not-allowed'; onClick = ''; }

                return `<button onclick="${onClick}" class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-2xl font-extrabold rounded-xl transition duration-150 text-gray-800">${letter}</button>`;
            }).join('');

            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            const quizInfo = state.g3_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g3_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g3_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g3_score})</p>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ–ï¸ hangman çŒœå–®å­— (word guess)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                </section>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">ğŸ’” éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">${hangmanDrawing}</div>
                        <p class="text-4xl mt-2 text-center">æç¤º: ${state.g3_emojiHint}</p>
                    </div>
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">çŒœæ¸¬å–®å­—:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">${displayWord}</div>
                        <div class="grid grid-cols-7 gap-1 md:gap-2">${alphabetBtns}</div>
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? 'é‡è¨­éŠæˆ²' : 'é–‹å§‹æ–°æŒ‘æˆ°'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- Game 3 End ---

        // --- Game 4: ğŸ¤ é›™äººè³“æœ (Bingo) ---
        function generateBingoCardG4() {
            const source = localData.g4_bingo_words;
            if (source.length < G4_BINGO_SIZE * G4_BINGO_SIZE) {
                // é€™è£¡ä¸æ‡‰è©²é¡¯ç¤º MessageBoxï¼Œå› ç‚ºé€™æ˜¯åœ¨ init å…§éƒ¨ï¼Œè®“ init è™•ç†
                return Array(G4_BINGO_SIZE * G4_BINGO_SIZE).fill('ERROR');
            }
            return shuffleArray(source).slice(0, G4_BINGO_SIZE * G4_BINGO_SIZE);
        }

        function checkWinG4(player) {
            // ... (è³“æœæª¢æŸ¥é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
            let lines = 0;
            const size = G4_BINGO_SIZE;
            const card = player.card;
            const marked = player.marked;

            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    if (marked.has(card[i * size + j])) rowCount++;
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }
            let diag1Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + i])) diag1Count++; }
            if (diag1Count === size) lines++;

            let diag2Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++; }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            return lines >= 2;
        }

        function initGame4() {
            const source = localData.g4_bingo_words;
            if (source.length < G4_BINGO_SIZE * G4_BINGO_SIZE) { 
                MessageBox.show(`è³“æœå–®å­—åº«ä¸è¶³ ${G4_BINGO_SIZE * G4_BINGO_SIZE} å€‹ï¼`, true); return; 
            }
            
            // ç§»é™¤: setupQuiz('g4'); // è¨­ç½®å›åˆåˆ¶

            state.g4_players = [
                { id: 1, name: 'ç©å®¶ 1', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
                { id: 2, name: 'ç©å®¶ 2', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
            ];
            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_isCalling = false;
            state.g4_gameStatus = 'ready'; // è¨­ç½®åˆå§‹ç‹€æ…‹
            
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') { initGame4(); return; }
            if (state.g4_isCalling) return;
            
            // NEW: Calculate the maximum number of words to call (half of total words)
            const MAX_WORDS_TO_CALL = Math.floor(localData.g4_bingo_words.length / 2);
            
            const availableWords = shuffleArray(localData.g4_bingo_words.filter(w => !state.g4_calledWords.has(w)));
            
            // NEW: Check if the limit is reached or if no words are available
            if (state.g4_calledWords.size >= MAX_WORDS_TO_CALL || availableWords.length === 0) { 
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`å–®å­—åº«å·²æŠ½å®Œæˆ–é”åˆ°æœ€å¤§æŠ½ç±¤æ•¸ (${MAX_WORDS_TO_CALL})ï¼ŒéŠæˆ²çµæŸï¼`, true); 
                return; 
            }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord;
            state.g4_calledWords.add(nextWord);
            
            state.g4_isCalling = true;
            state.g4_gameStatus = 'calling';
            renderGame4(); 
            
            await callTTS(nextWord); 
            
            state.g4_isCalling = false; 

            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished'; // è³“æœéŠæˆ²çµæŸ
                // ç§»é™¤: checkQuizEnd('g4', true); 
                renderGame4();
                MessageBox.show(`è³“æœï¼ç©å®¶ ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' å’Œ ')} ç²å‹ï¼ğŸ‰`, false);
            } else {
                // æ²’æœ‰ç²å‹ï¼Œç¹¼çºŒä¸‹ä¸€è¼ª
                renderGame4();
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index];

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) player.marked.delete(word);
                else player.marked.add(word);

                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished'; 
                    // ç§»é™¤: checkQuizEnd('g4', true);
                    renderGame4();
                    MessageBox.show(`è³“æœï¼ç©å®¶ ${playerId} ç²å‹ï¼ğŸ‰`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`å–®å­— ${word.toLowerCase()} å°šæœªè¢«å”¸å‡ºï¼`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            // NEW: Calculate the maximum words to call for display
            const MAX_WORDS_TO_CALL = Math.floor(localData.g4_bingo_words.length / 2);
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `<div class="bingo-cell ${isMarked ? 'marked bg-green-400' : 'hover:bg-yellow-300'}" data-player-id="${player.id}" data-index="${index}">${formatDisplayWord(word)}</div>`;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">${player.name} ${player.winner ? 'ğŸ‰ winner ğŸ‰' : ''} (ç·šæ•¸: ${player.score})</h3>
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${G4_BINGO_SIZE}, 1fr); grid-template-rows: repeat(${G4_BINGO_SIZE}, 1fr); max-w-full md:max-w-[300px];" id="bingo-grid-${player.id}">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };
            
            // REMOVED: quizInfo and replaced with Limit Info
            const limitInfo = `<p class="text-xl font-bold">æŠ½ç±¤ä¸Šé™: ${MAX_WORDS_TO_CALL} å€‹å–®å­— (ç¸½æ•¸: ${localData.g4_bingo_words.length})</p>`;


            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">${state.g4_gameStatus === 'ready' ? 'æº–å‚™é–‹å§‹' : state.g4_gameStatus === 'calling' ? 'éŠæˆ²ä¸­' : 'éŠæˆ²çµæŸ'}</h3>
                     <div class="mb-2">${limitInfo}</div>
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <p class="text-4xl font-black text-red-700 transition duration-300 item-name-display">
                            ${state.g4_lastCalledWord ? `å–®å­—: ${formatDisplayWord(state.g4_lastCalledWord)}` : state.g4_gameStatus === 'ready' ? 'é»æ“Šé–‹å§‹æŒ‰éˆ•' : (state.g4_gameStatus === 'finished' ? 'éŠæˆ²çµæŸ' : 'ç­‰å¾…ä¸‹ä¸€è¼ª...')}
                        </p>
                    </div>
                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? 'ğŸ”Š é–‹å§‹éŠæˆ² / æŠ½å–å–®å­—' : state.g4_gameStatus === 'finished' ? 'ğŸ”„ é‡æ–°é–‹å§‹' : (state.g4_isCalling ? 'ğŸ™ï¸ æ’­å ±ä¸­...' : 'ğŸ”Š æŠ½å–ä¸‹ä¸€å€‹å–®å­—')}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">å·²æŠ½å‡º ${state.g4_calledWords.size} å€‹å–®å­— / å‰©é¤˜æŠ½ç±¤æ•¸ ${MAX_WORDS_TO_CALL - state.g4_calledWords.size} å€‹</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ¤ é›™äººè‹±æ–‡è³“æœ (two-player bingo)</h2>
                    <p class="text-center text-sm text-blue-900 mb-6">ç›®æ¨™: è½å–å–®å­—ï¼Œä¸¦åœ¨æ‚¨çš„ 4x4 è³“æœå¡ä¸Šæ¨™è¨˜ã€‚æœ€å…ˆå®Œæˆå…©æ¢ç·šç²å‹ï¼</p>
                    ${controlArea}
                    <div class="flex flex-col md:flex-row gap-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                </section>
            `;
             // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
            setTimeout(() => {
                document.querySelectorAll('.bingo-cell').forEach(cell => {
                    const playerId = parseInt(cell.dataset.playerId);
                    const index = parseInt(cell.dataset.index);
                    cell.addEventListener('click', () => handleCardClickG4(playerId, index));
                });
            }, 0);
        }
        // --- Game 4 End ---

        // --- Game 5: ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (Sentence Scramble Master) ---
        let g5_currentSource = [];

        function getSentenceTokens(sentence) {
            return sentence.match(/\b\w+'?\w*\b|[.,?!]/g) || [];
        }

        function shuffleWordsG5(sentence) {
            const words = getSentenceTokens(sentence);
            
            const scrambleArray = words.map(word => ({ id: crypto.randomUUID(), value: word, isUsed: false })); 
            
            for (let i = scrambleArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [scrambleArray[i], scrambleArray[j]] = [scrambleArray[j], scrambleArray[i]];
            }
            return scrambleArray;
        }

        function initGame5() {
            const source = localData.g5_sentences;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢å•å¥ï¼", true); return; }
            
            setupQuiz('g5');
            
            // éš¨æ©Ÿé¸å– 10 çµ„å¥å­ä½œç‚ºé¡Œåº«ä¾†æº (å¦‚æœå°‘æ–¼ 10 çµ„ï¼Œå‰‡å…¨éƒ¨é¸å–)
            g5_currentSource = shuffleArray(source).slice(0, MAX_QUESTIONS);
            
            startNextRoundG5();
        }
        
        function startNextRoundG5() {
             if (state.g5_gameStatus === 'finished') return;

            const currentSentence = g5_currentSource[state.g5_currentQuestion - 1];
            if (!currentSentence) {
                 checkQuizEnd('g5', false);
                 return;
            }

            state.g5_currentSentence = currentSentence;
            state.g5_scrambleBlocks = shuffleWordsG5(state.g5_currentSentence);
            state.g5_currentSort = Array(state.g5_scrambleBlocks.length).fill(null); 
            state.g5_gameStatus = 'playing';

            renderGame5();
        }
        
        async function speakSentenceG5(sentence) { await callTTS(sentence); }

        function handleWordClickG5(id) {
            const wordBlock = state.g5_scrambleBlocks.find(l => l.id === id);
            if (!wordBlock || wordBlock.isUsed || state.g5_gameStatus !== 'playing') return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = { value: wordBlock.value, id: wordBlock.id };
                wordBlock.isUsed = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const item = state.g5_currentSort[index];
            if (!item || state.g5_gameStatus !== 'playing') return;

            const originalBlock = state.g5_scrambleBlocks.find(l => l.id === item.id);
            if (originalBlock) originalBlock.isUsed = false;
            
            for (let i = index; i < state.g5_currentSort.length - 1; i++) {
                state.g5_currentSort[i] = state.g5_currentSort[i + 1];
            }
            state.g5_currentSort[state.g5_currentSort.length - 1] = null;

            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            const targetTokens = getSentenceTokens(state.g5_currentSentence).map(t => t.toUpperCase());
            const currentTokens = state.g5_currentSort.map(item => item.value.toUpperCase());
            
            let isCorrect = targetTokens.length === currentTokens.length;
            if (isCorrect) {
                for (let i = 0; i < targetTokens.length; i++) {
                    if (targetTokens[i] !== currentTokens[i]) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            if (isCorrect) {
                MessageBox.show("å¤ªæ£’äº†ï¼å¥å­é †åºå®Œå…¨æ­£ç¢ºï¼+1 åˆ†ï¼âœ…", false);
                speakSentenceG5(state.g5_currentSentence); 
                
                if (!checkQuizEnd('g5', true)) {
                    setTimeout(startNextRoundG5, 1500); // å»¶é² 1.5 ç§’é€²å…¥ä¸‹ä¸€å›åˆ
                }
            } else {
                const slots = document.querySelectorAll('.answer-slot');
                slots.forEach(slot => {
                    slot.classList.add('incorrect');
                    setTimeout(() => slot.classList.remove('incorrect'), 500);
                });
                MessageBox.show("é †åºä¸æ­£ç¢ºï¼Œè«‹å†è©¦è©¦çœ‹ï¼", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((item, index) => {
                const isFilled = item !== null;
                let displayWord = 'ï¼ˆé»æ“Šè©å¡Šå¡«å…¥ï¼‰';
                
                if (isFilled) {
                    displayWord = formatDisplayWord(item.value, index === 0);
                }
                
                return `
                    <div class="answer-slot ${isFilled ? 'filled bg-green-200 border-green-400' : ''}"
                         data-index="${index}">
                        ${displayWord}
                    </div>
                `;
            }).join('');

            const letterBlocksHtml = state.g5_scrambleBlocks.map(wordBlock => `
                <button data-id="${wordBlock.id}"
                        class="word-block ${wordBlock.isUsed ? 'used bg-gray-300 cursor-not-allowed' : 'hover:bg-yellow-300'}"
                        ${wordBlock.isUsed || state.g5_gameStatus !== 'playing' ? 'disabled' : ''}>
                    ${formatDisplayWord(wordBlock.value)}
                </button>
            `).join('');
            
            setTimeout(() => {
                document.querySelectorAll('.word-block').forEach(btn => {
                    btn.addEventListener('click', () => handleWordClickG5(btn.dataset.id));
                });
                document.querySelectorAll('.answer-slot').forEach(slot => {
                    slot.addEventListener('click', () => handleResetTargetG5(parseInt(slot.dataset.index)));
                });
            }, 0);
            
            const quizInfo = state.g5_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g5_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g5_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g5_score})</p>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (sentence scramble master)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                    <p class="text-center text-sm text-blue-900 mb-4">ğŸ’¡ é»æ“Šè©å¡Šï¼Œé‡çµ„å¥å­çš„æ­£ç¢ºé †åºï¼</p>
                </section>
                
                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    <div class="text-center mb-6">
                        <button onclick="speakSentenceG5(state.g5_currentSentence)" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            ğŸ”Š æœ—è®€åŸå§‹å¥å­ (è½åŠ›è¼”åŠ©)
                        </button>
                    </div>

                    <div class="text-center mb-6 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300 w-full">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ç­”æ¡ˆå€ (é»æ“Šå·²å¡«å…¥è©å¡Šå¯ç§»é™¤)</h3>
                        <div class="g5-answer-display">
                            ${targetBoxesHtml}
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">è©å¡Šåº« (é»æ“Šå¡«å…¥)</h3>
                    <div class="flex flex-wrap justify-center p-2">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g5_gameStatus === 'finished' ? 'é‡æ–°æŒ‘æˆ°' : 'æ›å€‹å¥å­'}
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 5 End ---

        // --- Game 6: ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Daily Routine Image Match) ---
        let g6_currentSource = [];

        function initGame6() {
            const source = localData.g6_routines;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢æ—¥å¸¸æ´»å‹•ï¼", true); return; }

            setupQuiz('g6');
            
            // éš¨æ©Ÿé¸å– 4 çµ„é…å°
            g6_currentSource = shuffleArray(source).slice(0, 4); 
            state.g6_targets = g6_currentSource.map(p => ({ ...p, matched: false })); // åœ–ç‰‡ (Target)
            
            startNextRoundG6();
        }
        
        function startNextRoundG6() {
            if (state.g6_gameStatus === 'finished') return;

            // æ¯æ¬¡åªå‡º 4 å€‹åœ–ç‰‡å’Œ 4 å€‹å–®å­—å¡ï¼Œç›´åˆ° 10 å›åˆçµæŸ (å¦‚æœé¡Œåº«ä¸è¶³ï¼Œå‰‡é‡è¤‡å‡ºé¡Œ)
            const allWords = localData.g6_routines;
            if (allWords.length === 0) return;
            
            const wordsForRound = shuffleArray(allWords).slice(0, 4);

            state.g6_targets = wordsForRound.map(p => ({ ...p, matched: false })); 
            state.g6_sources = shuffleArray(wordsForRound.map(p => ({ id: crypto.randomUUID(), word: p.word, isMatched: false }))); 
            state.g6_matches = 0;
            state.g6_gameStatus = 'playing';

            setupDragDropG6();
            renderGame6();
        }


        function setupDragDropG6() {
            // ç¢ºä¿æ¯æ¬¡æ¸²æŸ“å¾Œé‡æ–°ç¶å®šäº‹ä»¶
            setTimeout(() => {
                let draggedItem = null;

                document.ondragstart = (e) => {
                    if (e.target.classList.contains('drag-source')) {
                        draggedItem = e.target.dataset.word;
                        e.dataTransfer.setData('text/plain', draggedItem);
                        e.target.classList.add('opacity-50');
                    }
                };

                document.ondragend = (e) => {
                    if (e.target.classList.contains('drag-source')) {
                        e.target.classList.remove('opacity-50');
                        draggedItem = null;
                    }
                };

                document.ondragover = (e) => {
                    const target = e.target.closest('.image-target');
                    if (target) e.preventDefault();
                };

                document.ondrop = (e) => {
                    const target = e.target.closest('.image-target');
                    const sourceWord = e.dataTransfer.getData('text/plain');

                    if (target && sourceWord) {
                        e.preventDefault();
                        
                        const targetWord = target.dataset.word; 

                        if (sourceWord === targetWord) {
                            handleMatchG6(sourceWord, targetWord, target);
                        } else {
                            MessageBox.show('é…å°éŒ¯èª¤ï¼Œè«‹å†è©¦è©¦ï¼', true);
                        }
                    }
                };
            }, 0); 
        }
        
        async function handleMatchG6(sourceWord, targetWord, targetElement) {
            state.g6_matches++;

            const targetIndex = state.g6_targets.findIndex(t => t.word === targetWord);
            if (targetIndex !== -1) state.g6_targets[targetIndex].matched = true;

            state.g6_sources = state.g6_sources.filter(s => s.word !== sourceWord);

            renderGame6();
            
            targetElement.classList.add('border-green-600', 'bg-green-100');
            MessageBox.show('é…å°æˆåŠŸï¼ğŸ‰', false);

            if (state.g6_matches === state.g6_targets.length) {
                // å›åˆçµæŸ
                 if (!checkQuizEnd('g6', true)) {
                    setTimeout(startNextRoundG6, 1500);
                }
            }
        }


        function renderGame6() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game6') return;

            const targetsHtml = state.g6_targets.map(t => {
                const isMatched = t.matched;
                return `
                    <div id="target-${t.word.replace(/\s/g, '_')}" 
                         data-word="${t.word}" 
                         class="image-target ${isMatched ? 'border-green-600 bg-green-100' : 'border-primary-pink'} p-2">
                        <p class="text-5xl mb-2">${t.emoji}</p>
                        ${isMatched ? `<p class="text-lg font-bold text-green-700 item-name-display">${formatDisplayWord(t.word)}</p>` : ''}
                    </div>
                `;
            }).join('');

            const sourcesHtml = state.g6_sources.map(s => `
                <button draggable="true" data-word="${s.word}" class="drag-source key-btn bg-accent-yellow hover:bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-xl text-sm md:text-base">${formatDisplayWord(s.word)}</button>
            `).join('');
            
            const quizInfo = state.g6_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g6_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g6_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g6_score})</p>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (daily routine image match)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: å°‡ä¸‹æ–¹çš„å–®å­—å¡æ‹–æ›³åˆ°ä¸Šæ–¹å°æ‡‰çš„æ—¥å¸¸æ´»å‹•åœ–ç‰‡ä¸Šã€‚</p>
                </section>
                
                <div class="p-4 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        ${targetsHtml}
                    </div>
                </div>

                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow w-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æ‹–æ›³å–®å­—åº« (${state.g6_sources.length} å‰©é¤˜)</h3>
                    <div class="flex flex-wrap justify-center gap-3 drag-area">
                        ${sourcesHtml.length > 0 ? sourcesHtml : '<p class="text-lg font-bold text-green-700">å…¨éƒ¨å®Œæˆï¼é€²å…¥ä¸‹ä¸€å›åˆ...</p>'}
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame6()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                        ${state.g6_gameStatus === 'finished' ? 'é‡æ–°æŒ‘æˆ°' : 'é‡è¨­éŠæˆ²'}
                    </button>
                </div>
            `;

            if (state.g6_sources.length > 0) setupDragDropG6();
        }
        // --- Game 6 End ---

        // --- Game 7: ğŸƒ èŠ±è²»è¨ˆç®—æ©Ÿ (Cost Calculator) ---
        
        // ------------------ è¨ˆç®—æ©Ÿæ ¸å¿ƒé‚è¼¯ (ä¿æŒä¸è®Š) -------------------
        function performCalculation(num1, num2, operator) {
            num1 = parseFloat(num1);
            num2 = parseFloat(num2);

            if (isNaN(num1) || isNaN(num2)) return 0;

            switch (operator) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case 'x': return num1 * num2;
                case '/': 
                    if (num2 === 0) {
                        MessageBox.show("é™¤æ•¸ä¸èƒ½ç‚ºé›¶ï¼", true);
                        return num1; 
                    }
                    return num1 / num2;
                default: return num2;
            }
        }

        function handleCalcKey(key) {
            let calc = state.g7_calculator;
            let current = calc.currentValue;

            if (key >= '0' && key <= '9') {
                if (calc.resetDisplay) {
                    current = key;
                    calc.resetDisplay = false;
                } else if (calc.currentValue.length < 10) { 
                    current = current === '0' ? key : current + key;
                }
                calc.currentValue = current;
                calc.calcDisplay = current;

            } else if (key === '.') {
                if (!calc.currentValue.includes('.') && !calc.resetDisplay) {
                    calc.currentValue += '.';
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'C') {
                calc.currentValue = '0';
                calc.memory = 0;
                calc.operator = null;
                calc.resetDisplay = true;
                calc.calcDisplay = '0';
            } else if (key === 'DEL') {
                 if (calc.currentValue.length > 1) {
                    calc.currentValue = calc.currentValue.slice(0, -1);
                } else {
                    calc.currentValue = '0';
                }
                calc.calcDisplay = calc.currentValue;
                calc.resetDisplay = false;

            } else if (['+', '-', 'x', '/'].includes(key)) {
                if (calc.operator !== null && !calc.resetDisplay) {
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                } else if (calc.operator === null) {
                    calc.memory = parseFloat(calc.currentValue);
                }
                calc.operator = key;
                calc.resetDisplay = true;
                calc.currentValue = calc.memory.toString(); 
                calc.calcDisplay = calc.currentValue;
            } else if (key === '=') {
                if (calc.operator !== null) {
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                    calc.currentValue = calc.memory.toString();
                    calc.operator = null; 
                    calc.resetDisplay = true;
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'R') { 
                 const numToRead = parseInt(current);
                 if (!isNaN(numToRead) && numToRead > 0) {
                    const wordResult = numberToWords(numToRead) + " dollars";
                    MessageBox.show(`æœ—è®€é‡‘é¡: ${wordResult}`, false);
                    callTTS(wordResult); 
                 } else {
                     MessageBox.show("è«‹å…ˆè¼¸å…¥é‡‘é¡ï¼", true);
                 }
                 state.g7_calculator = calc;
                 renderGame7();
                 return;
            }
            
            state.g7_calculator = calc;
            renderGame7();
        }
        
        // ------------------ éŠæˆ²åˆå§‹åŒ–èˆ‡æª¢æŸ¥ -------------------

        function initGame7() {
            setupQuiz('g7'); // è¨­ç½®å›åˆåˆ¶
            startNextRoundG7();
        }
        
        function startNextRoundG7() {
            if (state.g7_gameStatus === 'finished') return;

            // 1. éš¨æ©Ÿé¸æ“‡ 2 åˆ° 3 å€‹ç‰©å“
            const numItems = Math.floor(Math.random() * 2) + 2; 
            const shuffledItems = shuffleArray(SHOP_ITEMS).slice(0, numItems);
            
            let total = 0;
            const items = shuffledItems.map(item => {
                const price = Math.floor(Math.random() * item.maxPrice) + 1; 
                total += price;
                return { ...item, price };
            });
            
            state.g7_items = items;
            state.g7_totalCost = total;
            state.g7_displayValue = ''; 
            
            state.g7_calculator = { 
                currentValue: '0', memory: 0, operator: null, resetDisplay: true, calcDisplay: '0'
            };
            
            state.g7_gameStatus = 'entering'; 
            renderGame7();
        }


        function checkAnswerG7() {
            if (state.g7_gameStatus === 'finished') return;
            
            const enteredValue = parseInt(document.getElementById('answer-input-g7').value);
            const expectedValue = state.g7_totalCost;

            if (isNaN(enteredValue) || enteredValue < 1) {
                MessageBox.show("è«‹è¼¸å…¥æ‚¨è¨ˆç®—å‡ºçš„ç¸½é‡‘é¡ï¼", true);
                return;
            }
            
            const expectedWords = numberToWords(expectedValue) + " dollars";
            
            if (enteredValue === expectedValue) {
                MessageBox.show(`å¤ªæ£’äº†ï¼ç¸½é‡‘é¡æ˜¯ $${expectedValue}.00ï¼+1 åˆ†ï¼âœ… (It's ${expectedWords})`, false);
                state.g7_gameStatus = 'won';

                if (!checkQuizEnd('g7', true)) {
                    setTimeout(startNextRoundG7, 1500); 
                }

            } else {
                MessageBox.show(`ä¸å°å“¦ï¼Œæ‚¨è¼¸å…¥çš„é‡‘é¡æ˜¯ $${enteredValue}ã€‚æ­£ç¢ºé‡‘é¡æ˜¯ ${expectedWords}ã€‚å†è©¦ä¸€æ¬¡è¨ˆç®—å§ï¼`, true);
                document.getElementById('answer-input-g7').classList.add('border-red-500');
                setTimeout(() => document.getElementById('answer-input-g7').classList.remove('border-red-500'), 500);
            }
            renderGame7();
        }

        function renderGame7() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game7') return;

            const calc = state.g7_calculator;
            const currentInputValue = document.getElementById('answer-input-g7')?.value || '';
            
            const itemsHtml = state.g7_items.map((item) => `
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-2">
                    <span class="text-xl">${item.emoji} <span class="item-name-display">${formatDisplayWord(item.name)}</span></span>
                    <span class="text-xl font-bold text-red-600">$${item.price}</span>
                </div>
            `).join('');

            const formattedCalcDisplay = parseFloat(calc.calcDisplay).toLocaleString('en-US', {
                 maximumFractionDigits: 2
            });

            const costPrompt = state.g7_gameStatus === 'won' 
                ? formatDisplayWord(`it's ${numberToWords(state.g7_totalCost)} dollars`, true) 
                : formatDisplayWord("how much is it?", true);
            
            const calcButtons = [
                'C', 'DEL', '/', 'x',
                '7', '8', '9', '-',
                '4', '5', '6', '+',
                '1', '2', '3', '=',
                '0', '.', 'R', '=' 
            ];
            
            const quizInfo = state.g7_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g7_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g7_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g7_score})</p>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’° èŠ±è²»è¨ˆç®—æ©Ÿ (cost calculator)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: ä½¿ç”¨è¨ˆç®—æ©Ÿè¨ˆç®—ç¸½é‡‘é¡ï¼Œç„¶å¾Œå°‡æ•¸å­—ç­”æ¡ˆè¼¸å…¥åˆ°ä¸‹æ–¹æ¬„ä½ã€‚</p>
                </section>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- ç‰©å“æ¸…å–® -->
                    <div class="md:col-span-2 p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">ğŸ›’ shopping list</h3>
                        ${itemsHtml}
                        <div class="flex justify-end mt-4 pt-4 border-t-2 border-gray-300">
                            <span class="text-2xl font-extrabold text-blue-700">total: ??</span>
                        </div>
                    </div>

                    <!-- è¨ˆç®—æ©Ÿ -->
                    <div class="md:col-span-1 w-full max-w-xs mx-auto">
                        <div class="calc-display mb-4 text-4xl">
                            ${formattedCalcDisplay}
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${calcButtons.map(key => {
                                let keyClass = 'calc-key-number';
                                if (['C', 'DEL'].includes(key)) keyClass = 'calc-key-clear';
                                else if (['+', '-', 'x', '/', 'R', '='].includes(key)) {
                                    keyClass = key === '=' ? 'calc-key-equal' : 'calc-key-operator';
                                }

                                return `
                                    <button onclick="handleCalcKey('${key}')" 
                                            class="calc-key ${keyClass} rounded-xl shadow-cute ${key === '=' ? 'row-span-2' : ''}"
                                            style="${key === '=' ? 'grid-row-end: span 2;' : ''}">
                                        ${key === 'x' ? 'x' : key === '/' ? 'Ã·' : key === 'R' ? 'ğŸ”Š' : key}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <!-- ç­”æ¡ˆå’Œæœ—è®€å€ -->
                <div class="p-6 bg-white rounded-xl shadow-md border-4 border-primary-pink">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">â“ ${formatDisplayWord("how much is it?", true)}</h3>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="answer-input-g7" 
                               value="${currentInputValue}"
                               oninput="state.g7_displayValue = this.value.slice(0, 3);"
                               maxlength="3"
                               placeholder="è¼¸å…¥æ•¸å­— (0-999)" 
                               class="text-3xl p-3 border-4 border-secondary-blue rounded-lg text-center w-32 font-bold focus:border-blue-500"
                               ${state.g7_gameStatus === 'won' || state.g7_gameStatus === 'finished' ? 'disabled' : ''}>
                        
                        <button onclick="checkAnswerG7()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl"
                            ${state.g7_gameStatus === 'won' || state.g7_gameStatus === 'finished' ? 'disabled' : ''}>
                            âœ… æª¢æŸ¥ç­”æ¡ˆ
                        </button>
                        
                        <p class="text-3xl font-extrabold text-pink-600 item-name-display">${costPrompt}</p>
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame7()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                        ${state.g7_gameStatus === 'finished' ? 'é‡æ–°æŒ‘æˆ°' : 'é‡è¨­éŠæˆ²/æ›é¡Œç›®'}
                    </button>
                </div>
            `;
            
            // æ¯æ¬¡æ¸²æŸ“å¾Œç¢ºä¿è¼¸å…¥æ¡†èˆ‡ç‹€æ…‹åŒæ­¥
            const inputElement = document.getElementById('answer-input-g7');
            if (inputElement) {
                if (state.g7_gameStatus === 'won' || state.g7_gameStatus === 'finished') {
                    inputElement.disabled = true;
                } else {
                    inputElement.disabled = false;
                }
            }
            
        }
        // --- Game 7 End ---

        // --- Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph Blaster) ---
        let g8_currentSource = [];

        function initGame8() {
            const source = localData.g8_digraphs;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ digraph å–®å­—ï¼", true); return; }

            setupQuiz('g8');
            
            // éš¨æ©Ÿé¸å– 10 çµ„å–®å­—ä½œç‚ºé¡Œåº«ä¾†æº (å¦‚æœå°‘æ–¼ 10 çµ„ï¼Œå‰‡é‡è¤‡é¸å–)
            g8_currentSource = shuffleArray(source).slice(0, MAX_QUESTIONS);
            
            startNextRoundG8();
        }
        
        function startNextRoundG8() {
            if (state.g8_gameStatus === 'finished') return;

            const currentWord = g8_currentSource[state.g8_currentQuestion - 1];
            if (!currentWord) {
                 checkQuizEnd('g8', false);
                 return;
            }

            state.g8_currentWord = currentWord;
            state.g8_gameStatus = 'playing';
            
            // æ¯æ¬¡å‡ºé¡Œæ™‚è‡ªå‹•æœ—è®€ä¸€æ¬¡
            callTTS(state.g8_currentWord.full); 

            renderGame8();
        }
        
        async function handleDigraphClickG8(pattern) {
            if (state.g8_gameStatus !== 'playing') return;

            if (pattern.toUpperCase() === state.g8_currentWord.pattern.toUpperCase()) {
                MessageBox.show('æ­£ç¢ºï¼ç™¼å°„æˆåŠŸï¼+1 åˆ†ï¼ğŸ’¥', false);
                
                // å»¶é²æ›é¡Œ
                if (!checkQuizEnd('g8', true)) {
                    setTimeout(startNextRoundG8, 1500);
                }

            } else {
                MessageBox.show('éŒ¯èª¤ï¼ç™¼å°„å¤±æ•—ï¼å†è©¦è©¦å…¶ä»–çµ„åˆã€‚', true);
            }
            renderGame8();
        }

        // NEW: é‡å¯« renderGame8 ä¸­çš„ word display é‚è¼¯
        function renderWordDisplayG8(wordTemplate) {
            // å°‡æ¨¡æ¿å­—ä¸²ä¸­çš„æ¯å€‹å­—ç¬¦è½‰æ›ç‚º HTML å…ƒç´ 
            const parts = wordTemplate.split('');
            let html = '';
            
            parts.forEach(char => {
                if (char === '?') {
                    // é€™æ˜¯ç©ºç™½æ–¹å¡Šï¼Œç”¨æ–¼æ›¿æ› Digraphs æˆ– Magic E çš„å­—æ¯
                    html += `<div class="digraph-blank">?</div>`;
                } else if (char === ' ') {
                    // è™•ç†ç©ºæ ¼
                    html += `<span class="digraph-letter-part w-4"></span>`;
                } else {
                    // é€™æ˜¯æ™®é€šå­—æ¯
                    html += `<span class="digraph-letter-part">${formatDisplayWord(char)}</span>`;
                }
            });

            return html;
        }

        function renderGame8() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game8') return;

            const wordBlock = state.g8_currentWord;
            
            // ä½¿ç”¨ word_template é€²è¡Œæ¸²æŸ“
            const wordDisplayHtml = renderWordDisplayG8(wordBlock.word_template.toUpperCase());

            const allPatterns = [...new Set(localData.g8_digraphs.map(d => d.pattern))];
            const digraphButtons = shuffleArray(allPatterns).map(p => `
                <button onclick="handleDigraphClickG8('${p}')"
                        class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-xl md:text-3xl font-bold text-white rounded-xl transition duration-150">
                    ${formatDisplayWord(p)}
                </button>
            `).join('');

            const quizInfo = state.g8_gameStatus === 'finished' 
                ? `<p class="text-2xl font-black text-green-700">æœ€çµ‚å¾—åˆ†: ${state.g8_score} / ${MAX_QUESTIONS}</p>`
                : `<p class="text-xl font-bold">å›åˆ: ${state.g8_currentQuestion} / ${MAX_QUESTIONS} (å¾—åˆ†: ${state.g8_score})</p>`;


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (digraph blaster)</h2>
                    <div class="text-center mb-4">${quizInfo}</div>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: é»æ“Šæ­£ç¢ºçš„ç™¼éŸ³çµ„åˆ (${allPatterns.map(p => formatDisplayWord(p)).join(', ')}) ä¾†å®Œæˆå–®å­—ï¼</p>
                </section>
                
                ${state.g8_gameStatus !== 'finished' ? `
                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    
                    <div class="flex flex-col items-center justify-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">é»æ“Šå–‡å­è½å–å–®å­—ç™¼éŸ³:</h3>
                        
                        <div class="flex items-center justify-center space-x-4">
                            <!-- NEW: ä½¿ç”¨ wordDisplayHtml æ¸²æŸ“ -->
                            <div class="digraph-display-box flex items-center justify-center space-x-0 shadow-lg p-4">
                                ${wordDisplayHtml}
                            </div>
                            <button onclick="callTTS(state.g8_currentWord.full)" 
                                    class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-200"
                                    title="æœ—è®€å–®å­—">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2V15H6L11 19V5ZM19.5 12C19.5 14.3283 18.0792 16.3262 16 17.2025V6.7975C18.0792 7.67384 19.5 9.67174 19.5 12ZM16 13C16.8284 13 17.5 12.3284 17.5 11.5C17.5 10.6716 16.8284 10 16 10V13Z"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 w-full max-w-lg">
                        ${digraphButtons}
                    </div>
                </div>
                ` : `<p class="text-4xl font-black text-green-700 p-10">æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰æŒ‘æˆ°ï¼ç¸½åˆ† ${state.g8_score}ï¼</p>`}
                
                <div class="text-center mt-6">
                    <button onclick="initGame8()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                        ${state.g8_gameStatus === 'finished' ? 'é‡æ–°æŒ‘æˆ°' : 'é‡è¨­éŠæˆ²'}
                    </button>
                </div>
            `;
        }
        // --- Game 8 End ---

        // --- AI Image Generation Function (NOW SIMULATED EMOJI GENERATION) ---
        // ç§»é™¤æ‰€æœ‰ Imagen API å‘¼å«ï¼Œè½‰ç‚º Emoji æå–é‚è¼¯
        async function generateEmojiAndAddWord(key, wordPhrase) {
            const addButton = document.getElementById('admin-add-button');
            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> æå– Emoji ä¸­...';
            }
            
            await new Promise(resolve => setTimeout(resolve, 500)); 

            const newEmoji = generateEmojiFromWord(wordPhrase);
            const newId = crypto.randomUUID();
            let newEntry = null;

            if (key === 'g6_routines') {
                newEntry = { id: newId, word: wordPhrase, emoji: newEmoji, url: `https://placehold.co/150x120/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}` };
                localData[key].push(newEntry);
            } 

            if (newEntry) {
                saveWordsToLocal();
                MessageBox.show(`Emoji æå–ä¸¦æ–°å¢è©å½™æˆåŠŸï¼Emoji: ${newEmoji}`, false);
                
                document.getElementById('admin-input-1').value = '';
                document.getElementById('admin-input-2').value = '';
                renderWordAdmin();
            } else {
                MessageBox.show("Emoji æå–å¤±æ•—ã€‚", true);
            }
        }

        // --- Admin Panel (å¤§å¹…é‡æ§‹) ---
        const ADMIN_TABS = [
            { key: 'g2_words', name: 'ğŸ¶ Phonics é…å°', isObjectArray: true, headers: ['Phonics', 'Word', 'Hint'] },
            { key: 'g3_words', name: 'ğŸ–ï¸ Hangman', isObjectArray: false, headers: ['Word'] },
            { key: 'g4_bingo_words', name: 'ğŸ¤ è³“æœå–®å­—', isObjectArray: false, headers: ['Word'] },
            { key: 'g5_sentences', name: 'ğŸ’¬ å•å¥é‡çµ„', isObjectArray: false, headers: ['Sentence'] },
            { key: 'g6_routines', name: 'ğŸ¤¸ æ—¥å¸¸æ´»å‹•', isObjectArray: true, headers: ['Phrase', 'URL'] },
            // NEW: G8 headers now reflect pattern and template
            { key: 'g8_digraphs', name: 'ğŸ’¥ ç™¼éŸ³æ©Ÿ', isObjectArray: true, headers: ['Pattern(SH/O_E)', 'Word Template(??AT/N?SE)', 'Full Word'] },
        ];
        
        function getCurrentAdminTab() {
            return ADMIN_TABS.find(t => t.key === adminState.currentAdminKey);
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                processFileData(content);
            };
            reader.readAsText(file);
        }

        function processFileData(content) {
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length === 0) {
                MessageBox.show("æ–‡ä»¶å…§å®¹ç‚ºç©ºæˆ–ç„¡æ³•è§£æã€‚", true);
                return;
            }

            const currentTab = getCurrentAdminTab();
            let addedCount = 0;
            let currentList = localData[adminState.currentAdminKey];

            lines.forEach(line => {
                const rawValues = line.split(',').map(v => v.trim());
                let newEntry = null;
                const newId = crypto.randomUUID();

                if (!currentTab.isObjectArray) {
                    const value = rawValues[0];
                    if (value && !currentList.includes(value)) {
                         newEntry = value;
                    }
                } else {
                    if (adminState.currentAdminKey === 'g2_words' && rawValues.length >= 2) {
                        newEntry = { id: newId, phonics: rawValues[0], word: rawValues[1], hint: rawValues[2] || '' };
                    } else if (adminState.currentAdminKey === 'g8_digraphs' && rawValues.length >= 3) {
                        // NEW G8 Structure
                        newEntry = { id: newId, pattern: rawValues[0], word_template: rawValues[1], full: rawValues[2] };
                    } else if (adminState.currentAdminKey === 'g6_routines' && rawValues.length >= 1) {
                        const wordPhrase = rawValues[0];
                        const url = rawValues[1] || '';
                        
                        let finalUrl = url;
                        if (!finalUrl) {
                            const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                            finalUrl = `https://placehold.co/150x120/${randomColor}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}`;
                        }
                        const newEmoji = generateEmojiFromWord(wordPhrase.toUpperCase());
                        
                        newEntry = { id: newId, word: wordPhrase, emoji: newEmoji, url: finalUrl };
                    }
                }
                
                if (newEntry) {
                    currentList.push(newEntry);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveWordsToLocal(); 
                MessageBox.show(`æˆåŠŸå¾æ–‡ä»¶æ–°å¢ ${addedCount} å€‹è©å½™åˆ° ${currentTab.name}ï¼`, false);
                renderWordAdmin();
            } else {
                 MessageBox.show(`æ–‡ä»¶è§£æå®Œæˆï¼Œä½†æ²’æœ‰æ–°å¢ä»»ä½•æ–°çš„è©å½™ã€‚è«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ã€‚`, true);
            }
            
            document.getElementById('file-upload-input').value = null;
        }
        
        function handleBulkAdd(inputElement, isObjectArray) {
            const inputContent = inputElement.value.trim();
            if (!inputContent) return;

            const lines = inputContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let addedCount = 0;
            let currentList = localData[adminState.currentAdminKey];
            const currentTab = getCurrentAdminTab();

            lines.forEach(line => {
                let newEntry = null;

                if (!isObjectArray) {
                    const normalizedEntry = line; 
                    if (!currentList.includes(normalizedEntry)) {
                        newEntry = normalizedEntry;
                    }
                } else {
                    const values = line.split(',').map(v => v.trim()); 
                    const newId = crypto.randomUUID();

                    if (currentTab.key === 'g2_words' && values.length >= 2) {
                        newEntry = { id: newId, phonics: values[0], word: values[1], hint: values[2] || '' };
                    } else if (currentTab.key === 'g8_digraphs' && values.length >= 3) {
                         // NEW G8 Structure
                        newEntry = { id: newId, pattern: values[0], word_template: values[1], full: values[2] };
                    }
                }
                
                if (newEntry) {
                    currentList.push(newEntry);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveWordsToLocal(); 
                MessageBox.show(`æˆåŠŸæ–°å¢ ${addedCount} å€‹è©å½™ï¼`, false);
                inputElement.value = ''; 
                renderWordAdmin();
            } else if (!isObjectArray) {
                 MessageBox.show("è«‹æª¢æŸ¥è¼¸å…¥å…§å®¹æ˜¯å¦ç‚ºæ–°è©å½™æˆ–æ˜¯å¦å¡«å¯«æ­£ç¢ºã€‚", true);
            }
        }

        // --- æ–°å¢: ç·¨è¼¯/åˆªé™¤/é¸æ“‡é‚è¼¯ ---

        function handleCheckboxChange(id, event) {
            const isChecked = event.target.checked;
            if (isChecked) {
                adminState.selectedIds.add(id);
            } else {
                adminState.selectedIds.delete(id);
            }
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰éƒ½è¢«é¸ä¸­
            const list = localData[adminState.currentAdminKey];
            adminState.isAllSelected = adminState.selectedIds.size === list.length;
            renderWordAdmin();
        }
        
        function toggleSelectAll(event) {
            const isChecked = event.target.checked;
            const list = localData[adminState.currentAdminKey];
            adminState.selectedIds.clear();

            if (isChecked) {
                list.forEach(item => {
                    const id = typeof item === 'object' ? item.id : item;
                    adminState.selectedIds.add(id);
                });
            }
            adminState.isAllSelected = isChecked;
            renderWordAdmin();
        }
        
        function handleBulkDelete() {
            if (adminState.selectedIds.size === 0) {
                MessageBox.show("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è©å½™ï¼", true);
                return;
            }

            const currentKey = adminState.currentAdminKey;
            const currentTab = getCurrentAdminTab();
            let currentList = localData[currentKey];
            
            const initialCount = currentList.length;

            if (currentTab.isObjectArray) {
                // Object Array: Filter by ID
                localData[currentKey] = currentList.filter(item => !adminState.selectedIds.has(item.id));
            } else {
                // Simple String Array: éœ€è¦æ ¹æ“šå€¼ä¾†ç¯©é¸
                const itemsToDelete = Array.from(adminState.selectedIds);
                localData[currentKey] = currentList.filter(item => !itemsToDelete.includes(item));
            }
            
            const deletedCount = initialCount - localData[currentKey].length;

            adminState.selectedIds.clear();
            adminState.isAllSelected = false;
            saveWordsToLocal();
            MessageBox.show(`æˆåŠŸåˆªé™¤ ${deletedCount} å€‹é¸å®šçš„è©å½™ï¼ğŸ—‘ï¸`, false);
            renderWordAdmin();
        }

        function handleEditClick(id) {
            adminState.editId = id;
            renderWordAdmin();
        }
        
        function handleCancelEdit() {
            adminState.editId = null;
            renderWordAdmin();
        }

        function handleSaveClick(id) {
            const currentTab = getCurrentAdminTab();
            let currentList = localData[adminState.currentAdminKey];
            
            const isObject = currentTab.isObjectArray;
            const itemIndex = isObject 
                ? currentList.findIndex(item => item.id === id)
                : currentList.indexOf(id); // For string arrays

            if (itemIndex === -1) return;
            
            if (!isObject) {
                 // Simple String Array (G3, G4, G5)
                const newValue = document.getElementById(`edit-input-${id}`).value.trim();
                if (!newValue) { MessageBox.show("è©å½™ä¸èƒ½ç‚ºç©ºï¼", true); return; }
                currentList[itemIndex] = newValue;
            } else {
                // Object Array (G2, G6, G8)
                let updatedItem = { ...currentList[itemIndex] };
                let isValid = true;

                if (currentTab.key === 'g2_words') {
                    updatedItem.phonics = document.getElementById(`edit-phonics-${id}`).value.trim();
                    updatedItem.word = document.getElementById(`edit-word-${id}`).value.trim();
                    updatedItem.hint = document.getElementById(`edit-hint-${id}`).value.trim();
                    if (!updatedItem.phonics || !updatedItem.word) isValid = false;
                } else if (currentTab.key === 'g8_digraphs') {
                    // NEW G8 Structure
                    updatedItem.pattern = document.getElementById(`edit-pattern-${id}`).value.trim();
                    updatedItem.word_template = document.getElementById(`edit-template-${id}`).value.trim();
                    updatedItem.full = document.getElementById(`edit-full-${id}`).value.trim();
                    if (!updatedItem.pattern || !updatedItem.word_template || !updatedItem.full) isValid = false;
                } else if (currentTab.key === 'g6_routines') {
                    updatedItem.word = document.getElementById(`edit-phrase-${id}`).value.trim();
                    updatedItem.url = document.getElementById(`edit-url-${id}`).value.trim();
                    updatedItem.emoji = document.getElementById(`edit-emoji-${id}`).value.trim();
                    if (!updatedItem.word || !updatedItem.emoji) isValid = false;
                }

                if (!isValid) { MessageBox.show("æ‰€æœ‰æ¬„ä½çš†ä¸èƒ½ç‚ºç©ºï¼", true); return; }
                currentList[itemIndex] = updatedItem;
            }
            
            adminState.editId = null;
            saveWordsToLocal();
            MessageBox.show("è©å½™æ›´æ–°æˆåŠŸï¼âœ…", false);
            renderWordAdmin();
        }


        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const currentList = localData[adminState.currentAdminKey] || [];
            const currentTab = getCurrentAdminTab();
            
            // -------------------- è¼¸å…¥æ¬„ä½å€ --------------------
            let inputField = '';
            let addButtonText = 'â• æ–°å¢';

            if (!currentTab.isObjectArray) {
                // G3, G4, G5 çš„æ‰¹é‡æ–°å¢
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ‰¹é‡æ–°å¢ï¼šæ¯å€‹å–®å­—/å¥å­ä¸€è¡Œï¼ŒæŒ‰ Enter éµæ›è¡Œå³å¯ã€‚</p>
                    <textarea id="admin-input-1" placeholder="å–®å­—æˆ–å®Œæ•´å¥å­ (æ¯è¡Œä¸€å€‹è©å½™)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            } else if (currentTab.key === 'g6_routines') {
                // G6: æ—¥å¸¸æ´»å‹•
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ—¥å¸¸æ´»å‹•: å®Œæ•´çš„å‹•è©ç‰‡èª (WASH MY FACE)ã€‚</p>
                    <input type="text" id="admin-input-1" placeholder="è‹±æ–‡ç‰‡èª/å‹•ä½œ (å¦‚: BRUSH TEETH)" maxlength="30" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                    <input type="text" id="admin-input-2" placeholder="åœ–ç‰‡URL (ç•™ç©ºå‰‡è‡ªå‹•ç”ŸæˆEmoji)" maxlength="100" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                `;
                addButtonText = 'âœ¨ è‡ªå‹•ç”Ÿæˆ Emoji ä¸¦æ–°å¢';
            } else {
                 // G2, G8 çš„æ‰¹é‡æ–°å¢
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ‰¹é‡æ–°å¢ï¼šè«‹åœ¨ç¬¬ä¸€å€‹æ¬„ä½è¼¸å…¥ï¼Œä½¿ç”¨é€—è™Ÿåˆ†éš” (${currentTab.headers.join(', ')})ã€‚</p>
                    <textarea id="admin-input-1" placeholder="${currentTab.headers.join(', ')} (æ¯è¡Œä¸€å€‹è©å½™)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            }

            // -------------------- åˆ—è¡¨æ¸²æŸ“å€ --------------------
            const wordListHtml = currentList.map((item, index) => {
                const isObject = currentTab.isObjectArray;
                const id = isObject ? item.id : item; // String arrays use the string itself as ID/Value for selection
                const isEditing = id === adminState.editId;
                const isChecked = adminState.selectedIds.has(id);
                
                let displayHtml = '';

                if (isEditing) {
                    // å…§è¯ç·¨è¼¯æ¨¡å¼
                    if (currentTab.key === 'g2_words') {
                        displayHtml = `
                            <div class="flex flex-col w-full space-y-2">
                                <input type="text" id="edit-phonics-${id}" class="admin-input" value="${item.phonics}" placeholder="Phonics">
                                <input type="text" id="edit-word-${id}" class="admin-input" value="${item.word}" placeholder="Word">
                                <input type="text" id="edit-hint-${id}" class="admin-input" value="${item.hint}" placeholder="Hint (ä¸­æ–‡)">
                            </div>
                        `;
                    } else if (currentTab.key === 'g8_digraphs') {
                        // NEW G8 Structure for editing
                         displayHtml = `
                            <div class="flex flex-col w-full space-y-2">
                                <input type="text" id="edit-pattern-${id}" class="admin-input" value="${item.pattern}" placeholder="Pattern (SH/O_E)">
                                <input type="text" id="edit-template-${id}" class="admin-input" value="${item.word_template}" placeholder="Template (??AT/N?SE)">
                                <input type="text" id="edit-full-${id}" class="admin-input" value="${item.full}" placeholder="Full Word">
                            </div>
                        `;
                    } else if (currentTab.key === 'g6_routines') {
                        displayHtml = `
                            <div class="flex flex-col w-full space-y-2">
                                <input type="text" id="edit-phrase-${id}" class="admin-input" value="${item.word}" placeholder="Phrase">
                                <input type="text" id="edit-emoji-${id}" class="admin-input" value="${item.emoji}" placeholder="Emoji">
                                <input type="text" id="edit-url-${id}" class="admin-input" value="${item.url}" placeholder="URL">
                            </div>
                        `;
                    } else { // Simple String Array
                        displayHtml = `<input type="text" id="edit-input-${id}" class="admin-input" value="${item}" placeholder="Word/Sentence">`;
                    }
                } else {
                    // æ­£å¸¸é¡¯ç¤ºæ¨¡å¼
                    let display;
                    if (currentTab.key === 'g6_routines') {
                        display = `${item.emoji} / ${formatDisplayWord(item.word)} / URL:${item.url.substring(0, 30)}...`;
                    } else if (currentTab.key === 'g2_words') {
                        display = `Phonics: ${formatDisplayWord(item.phonics)}, Word: ${formatDisplayWord(item.word)}, Hint: ${item.hint}`;
                    } else if (currentTab.key === 'g8_digraphs') {
                        // NEW G8 Structure for display
                        display = `Pattern: ${formatDisplayWord(item.pattern)}, Template: ${formatDisplayWord(item.word_template)}, Full: ${formatDisplayWord(item.full)}`;
                    } else {
                        display = formatDisplayWord(item);
                    }
                    displayHtml = `<span class="text-sm md:text-lg font-bold text-gray-800">${index + 1}. ${display}</span>`;
                }

                return `
                    <li class="flex justify-between items-start p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                        <!-- å‹¾é¸æ¡† -->
                        <div class="flex items-center self-center mr-3">
                            <input type="checkbox" id="checkbox-${id}" 
                                   class="w-5 h-5 text-secondary-blue bg-gray-100 border-gray-300 rounded focus:ring-secondary-blue"
                                   onchange="handleCheckboxChange('${id}', event)"
                                   ${isChecked ? 'checked' : ''}>
                        </div>
                        
                        <!-- é¡¯ç¤º/ç·¨è¼¯å…§å®¹ -->
                        <div class="flex-1 min-w-0">
                            ${displayHtml}
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex space-x-2 ml-4 self-center">
                            ${isEditing ? `
                                <button onclick="handleSaveClick('${id}')" class="text-green-500 hover:text-green-700 font-bold p-1 transition duration-150">
                                    å„²å­˜ âœ…
                                </button>
                                <button onclick="handleCancelEdit()" class="text-gray-500 hover:text-gray-700 font-bold p-1 transition duration-150">
                                    å–æ¶ˆ âœ–ï¸
                                </button>
                            ` : `
                                <button onclick="handleEditClick('${id}')" class="text-blue-500 hover:text-blue-700 font-bold p-1 transition duration-150">
                                    ç·¨è¼¯ âœï¸
                                </button>
                                <button onclick="deleteWordAdmin('${id}')" class="text-red-500 hover:text-red-700 font-bold p-1 transition duration-150">
                                    åˆªé™¤ ğŸ—‘ï¸
                                </button>
                            `}
                        </div>
                    </li>
                `;
            }).join('');


            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">âš™ï¸ å–®å­—/è¨­å®šç®¡ç†å¾Œå° (local storage admin panel)</h2>
                    <p class="text-center text-sm text-pink-100">ğŸ’¡ é€™è£¡çš„å–®å­—åƒ…å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ä¸­ã€‚**è«‹ç”¨å¤§å¯«è¼¸å…¥ä¾†å¼·èª¿å–®å­—ã€‚**</p>
                </section>
                
                <div class="flex flex-wrap justify-center space-x-1 mb-4">
                    ${ADMIN_TABS.map(tab => `
                        <button onclick="setCurrentAdminKey('${tab.key}')" class="tab-btn py-2 px-3 ${adminState.currentAdminKey === tab.key ? 'bg-secondary-blue text-blue-900 shadow-lg' : 'bg-gray-100 text-gray-700'}">
                            ${tab.name}
                        </button>
                    `).join('')}
                </div>
                
                <!-- æ–‡ä»¶ä¸Šå‚³å€å¡Š -->
                <div class="p-6 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full mb-6">
                    ${currentTab.key !== 'g7_verbs' ? `
                        <h3 class="text-xl font-bold text-gray-800 mb-3">æª”æ¡ˆç®¡ç†èˆ‡æ‰¹é‡æ“ä½œ</h3>
                        <div class="file-upload-container mb-4 w-full">
                            <label for="file-upload-input" class="text-sm font-semibold text-gray-700 mr-2 whitespace-nowrap">â¬†ï¸ åŒ¯å…¥æª”æ¡ˆ (.csv/.txt):</label>
                            <input type="file" 
                                class="file-upload-input"
                                id="file-upload-input" 
                                accept=".csv,.txt"
                                onchange="handleFileUpload(event)">
                        </div>
                        <p class="text-xs text-gray-600 mb-4 w-full text-left">**CSV/TXT æ ¼å¼:** ç°¡å–®è©å½™æ¯è¡Œä¸€å€‹ï¼›ç‰©ä»¶è©å½™è«‹ç”¨é€—è™Ÿåˆ†éš” (${currentTab.headers.join(', ')}ï¼Œæ¯è¡Œä¸€å€‹)ã€‚</p>
                    ` : '<p class="text-lg text-gray-700 w-full text-center">è¨ˆç®—æ©ŸéŠæˆ²ç„¡éœ€ç®¡ç†è©å½™ã€‚</p>'}
                </div>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md w-full">
                    <label for="admin-input-1" class="block text-lg font-semibold text-gray-800 mb-2">æ–°å¢ ${currentTab.name} è©å½™</label>
                    <div class="flex space-x-2 flex-wrap">
                        ${inputField}
                        ${currentTab.key !== 'g7_verbs' ? `<button id="admin-add-button" onclick="${currentTab.key === 'g6_routines' ? 'generateEmojiAndAddWord(\'g6_routines\', document.getElementById(\'admin-input-1\').value.trim())' : 'addWordAdmin()'}" 
                                class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150">
                            ${addButtonText}
                        </button>` : ''}
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200 w-full mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${currentTab.name} åˆ—è¡¨ (${currentList.length} å€‹)</h3>
                    
                    <!-- åˆ—è¡¨é ‚éƒ¨æ“ä½œ -->
                    <div class="flex justify-between items-center mb-4 bg-gray-100 p-2 rounded-lg">
                        <label class="flex items-center space-x-2 font-bold text-sm text-gray-700">
                            <input type="checkbox" onchange="toggleSelectAll(event)" ${adminState.isAllSelected ? 'checked' : ''} class="w-4 h-4 text-primary-pink">
                            <span>å…¨é¸/å–æ¶ˆå…¨é¸</span>
                        </label>
                        <button onclick="handleBulkDelete()" 
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-150 shadow-md"
                                ${adminState.selectedIds.size === 0 ? 'disabled' : ''}>
                            åˆªé™¤é¸å®š (${adminState.selectedIds.size}) ğŸ—‘ï¸
                        </button>
                    </div>

                    <ul class="max-h-96 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰è©å½™ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                    <p class="text-xs text-gray-400 mt-4 text-center">æ‚¨çš„è¨­å®šå·²è‡ªå‹•å„²å­˜ã€‚</p>
                </div>
            `;
        }
        
        function setCurrentAdminKey(key) {
            adminState.currentAdminKey = key;
            adminState.editId = null; // é‡ç½®ç·¨è¼¯ç‹€æ…‹
            adminState.selectedIds.clear(); // æ¸…ç©ºé¸æ“‡
            adminState.isAllSelected = false; // é‡ç½®å…¨é¸ç‹€æ…‹
            
            // è·³é G7 é é¢ (å› ç‚ºä¸éœ€è¦ç®¡ç†)
            if (key !== 'g7_verbs') {
                renderWordAdmin();
            } else {
                 changeGame('game7');
            }
        }

        function addWordAdmin() {
            // ç”±æ–¼è¤‡é›œå°è±¡ï¼ˆG2, G8, G6ï¼‰çš„å–®è¡Œ/æ‰¹é‡è¼¸å…¥æœƒèª¿ç”¨å„è‡ªçš„é‚è¼¯ï¼Œé€™è£¡è™•ç† G3, G4, G5
            const currentTab = getCurrentAdminTab();

            if (!currentTab.isObjectArray) {
                const inputElement = document.getElementById('admin-input-1');
                const inputContent = inputElement ? inputElement.value.trim() : '';
                
                if (!inputContent) {
                    MessageBox.show("è«‹è¼¸å…¥è©å½™å…§å®¹ï¼", true);
                    return;
                }
                
                handleBulkAdd(inputElement, false);
                return;
            }
            
            // è™•ç† G2 å’Œ G8 çš„å–®è¡Œè¼¸å…¥ï¼ˆé G6 çš„ Emoji è‡ªå‹•ç”Ÿæˆï¼‰
            const inputElement = document.getElementById('admin-input-1');
            const inputContent = inputElement ? inputElement.value.trim() : '';
            
            if (!inputContent) { MessageBox.show("è«‹è¼¸å…¥è©å½™å…§å®¹ï¼", true); return; }

            const lines = inputContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length > 1) {
                 // æ”¯æ´ G2, G8 çš„æ‰¹é‡ CSV æ ¼å¼è¼¸å…¥
                 handleBulkAdd(inputElement, true);
                 return;
            } else if (lines.length === 1) {
                // è™•ç†å–®è¡Œè¼¸å…¥ï¼ˆG2/G8 çš„å–®æ¬¡æ·»åŠ ï¼‰
                const values = lines[0].split(',').map(v => v.trim()); 
                let newEntry = null;
                const newId = crypto.randomUUID();

                if (currentTab.key === 'g2_words' && values.length >= 2) {
                    newEntry = { id: newId, phonics: values[0], word: values[1], hint: values[2] || '' };
                } else if (currentTab.key === 'g8_digraphs' && values.length >= 3) {
                     // NEW G8 Structure
                     newEntry = { id: newId, pattern: values[0], word_template: values[1], full: values[2] };
                } else {
                     MessageBox.show(`æ ¼å¼éŒ¯èª¤ï¼šè«‹ç¢ºä¿è¼¸å…¥å…§å®¹ç¬¦åˆ ${currentTab.headers.join(', ')} çš„é †åºã€‚`, true); return;
                }
                
                if (newEntry) {
                    localData[adminState.currentAdminKey].push(newEntry);
                    saveWordsToLocal();
                    MessageBox.show(`è©å½™æ–°å¢æˆåŠŸï¼`, false);
                    inputElement.value = '';
                    renderWordAdmin();
                } else {
                    MessageBox.show(`æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼ã€‚`, true);
                }
            }
        }


        function deleteWordAdmin(id) {
            const currentTab = getCurrentAdminTab();
            const list = localData[adminState.currentAdminKey];

            if (currentTab.isObjectArray) {
                // Object Array: Filter by ID
                localData[adminState.currentAdminKey] = list.filter(item => item.id !== id);
                adminState.selectedIds.delete(id); // ç¢ºä¿å¾é¸å®šåˆ—è¡¨ä¸­ç§»é™¤
            } else {
                // Simple String Array: Filter by value (ID in this context is the value/string)
                localData[adminState.currentAdminKey] = list.filter(item => item !== id);
                adminState.selectedIds.delete(id);
            }
            
            saveWordsToLocal(); 
            MessageBox.show("è©å½™åˆªé™¤æˆåŠŸï¼", false);
            renderWordAdmin();
        }
        // --- Admin Panel End ---
    </script>
</body>
</html>
