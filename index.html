<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’-1</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* [Style definitions are preserved] */
        .game-font {
            font-family: 'Inter', sans-serif;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }
        .key-btn {
            height: 50px;
            transition: all 0.1s;
            text-transform: uppercase;
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important;
            border-color: #3CB371 !important;
            color: #1E40AF !important;
            cursor: default;
        }
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
            text-transform: uppercase;
        }
        .bingo-cell.marked {
            background-color: #90EE90;
            border-color: #3CB371;
            color: white;
            transform: scale(0.95);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }
        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        .word-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            height: 45px;
            padding: 0 10px;
            margin: 5px;
            background-color: #FFC7C7; 
            border: 3px solid #FF8FAB;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 3px 0 0 #D1A3A3;
        }
        .word-block.used {
            opacity: 0.5;
            cursor: default;
            background-color: #F8F8F8;
            border-color: #CCCCCC;
            box-shadow: none;
        }
        .answer-slot {
            min-width: 80px;
            height: 50px;
            margin: 5px;
            padding: 5px;
            border: 3px dashed #BDE0FE;
            border-radius: 10px;
            background-color: #F0F8FF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #4A5568;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .answer-slot.incorrect {
            animation: shake 0.3s 2;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .image-target {
            min-height: 120px;
            background-color: #fff;
            border: 3px solid #FF8FAB;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .drag-source {
            cursor: grab;
            user-select: none;
            box-shadow: 0 3px 0 0 #D1A3A3;
            transition: transform 0.1s;
        }
        .drag-source:active {
            cursor: grabbing;
            box-shadow: 0 1px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        .drag-area {
            border: 3px dashed #BDE0FE;
            border-radius: 12px;
            min-height: 150px;
            padding: 10px;
        }
        .digraph-display-box {
            min-width: 150px;
            min-height: 100px;
            background-color: #f0f0f0;
            border: 5px solid #FF8FAB;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .digraph-letter-part {
            font-size: 4rem;
            font-weight: 900;
            color: #1E40AF;
        }
        .digraph-blank {
            width: 80px;
            height: 80px;
            background-color: #FFEC99;
            border: 4px dashed #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #D1A3A3;
        }

    </style>

    <script>
        // [Tailwind config is preserved]
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      
                        'secondary-blue': '#BDE0FE',    
                        'accent-yellow': '#FFEC99',     
                        'background-light': '#F8F8F8',  
                        'keyboard-bg': '#FFF5D6',       
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    
                        'key-active': '0 2px 0 0 #D1A3A3', 
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <header class="w-full max-w-6xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.17157 9 9 9Z" fill="#FF8FAB"/><path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/><circle cx="11" cy="13" r="1" fill="#FF8FAB"/><circle cx="13" cy="13" r="1" fill="#FF8FAB"/></svg>
            è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’-1
        </h1>
    </header>

    <nav class="w-full max-w-6xl mb-6">
        <div class="grid grid-cols-4 gap-2 md:gap-4 justify-center">
            
            <button data-game="game2" onclick="changeGame('game2')" class="tab-btn">ğŸ¶ é…å°</button>
            <button data-game="game3" onclick="changeGame('game3')" class="tab-btn">ğŸ–ï¸ Hangman</button>
            <button data-game="game4" onclick="changeGame('game4')" class="tab-btn">ğŸ¤ è³“æœ</button>
            <button data-game="game5" onclick="changeGame('game5')" class="tab-btn">ğŸ’¬ å•å¥</button>
            
            <button data-game="game6" onclick="changeGame('game6')" class="tab-btn">ğŸ¤¸ æ—¥å¸¸</button>
            <button data-game="game7" onclick="changeGame('game7')" class="tab-btn">ğŸƒ å‹•è©</button>
            <button data-game="game8" onclick="changeGame('game8')" class="tab-btn">ğŸ’¥ ç™¼éŸ³æ©Ÿ</button>
            <button data-game="admin" onclick="changeGame('admin')" class="tab-btn">âš™ï¸ å¾Œå°</button>
        </div>
    </nav>

    <main id="game-content" class="w-full max-w-6xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[600px]">
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼...</p>
        </div>
    </main>
    
    <script>
        // --- å…¨åŸŸè¨­å®šèˆ‡å·¥å…· ---
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split('');
        const LOCAL_STORAGE_KEY = 'GAMES_CUSTOM_DATA_V2';
        const G4_BINGO_SIZE = 4;

        let currentGame = 'game2'; 
        let localData = {}; 
        let isGeneratingImage = false; 
        
        // Hangman Emoji æç¤ºåº«
        const G3_EMOJI_HINTS = {
            'PUPPET': 'ğŸ', 'SKATEBOARD': 'ğŸ›¹', 'HISTORY': 'ğŸ›ï¸', 'HARD': 'ğŸ’ª', 'EASY': 'ğŸ˜Œ', 
            'DOLLAR': 'ğŸ’µ', 'HAND': 'ğŸ–ï¸', 'FOOT': 'ğŸ¦¶', 'SCIENCE': 'ğŸ”¬', 'MATHS': 'â•'
        };


        // é è¨­å–®å­—åº« (Phonics 2, STEP 3 è©å½™)
        const DEFAULT_WORDS = {
            // Game 2: ğŸ¶ Phonics ç™¼éŸ³é…å°
            g2_words: [
                { id: crypto.randomUUID(), phonics: 'A-E', word: 'CAKE', hint: 'ç”Ÿæ—¥è›‹ç³•' },
                { id: crypto.randomUUID(), phonics: 'IE', word: 'PIE', hint: 'ç¾å‘³çš„æ´¾' },
                { id: crypto.randomUUID(), phonics: 'OO', word: 'FOOD', hint: 'å¥½åƒçš„é£Ÿç‰©' },
                { id: crypto.randomUUID(), phonics: 'EW', word: 'NEW', hint: 'æ–°çš„' },
                { id: crypto.randomUUID(), phonics: 'OA', word: 'BOAT', hint: 'ä¸€è‰˜èˆ¹' },
                { id: crypto.randomUUID(), phonics: 'EE', word: 'BEE', hint: 'å°èœœèœ‚' },
            ],
            // Game 3: ğŸ–ï¸ Hangman çŒœå–®å­—
            g3_words: ['PUPPET', 'SKATEBOARD', 'HISTORY', 'HARD', 'EASY', 'DOLLAR', 'HAND', 'FOOT'],
            // Game 4: ğŸ¤ é›™äººè³“æœ
            g4_bingo_words: ['SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY', 'HUNDRED', 'THOUSAND', 'DOLLAR', 'HOSPITAL', 'PARK', 'BANK', 'COAT', 'JEANS', 'GLOVES', 'HAT', 'SCARF', 'TIE'],
            // Game 5: ğŸ’¬ å•å¥é‡çµ„å¤§å¸«
            g5_sentences: [
                "What does he do after school?",
                "When does she have English?",
                "How much is the skateboard?",
                "How many legs does it have?",
                "Is the yellow one longer?",
                "I'm going to the airport."
            ],
            // Game 6: ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Word: Image_Concept) - ä½¿ç”¨å‰›å‰›ç”Ÿæˆçš„åœ–ç‰‡ URL
            g6_routines: [
                { id: crypto.randomUUID(), word: 'WASH HIS FACE', image: 'æ´—è‡‰', url: 'http://googleusercontent.com/image_generation_content/0' },
                { id: crypto.randomUUID(), word: 'DO HER HOMEWORK', image: 'å¯«ä½œæ¥­', url: 'https://placehold.co/150x120/ff8a65/000000?text=GIRL%20DOING%20HOMEWORK' },
                { id: crypto.randomUUID(), word: 'BRUSH HIS TEETH', image: 'åˆ·ç‰™', url: 'https://placehold.co/150x120/9ccc65/000000?text=KID%20BRUSHING%20TEETH' },
                { id: crypto.randomUUID(), word: 'PLAY ON HIS PHONE', image: 'ç©æ‰‹æ©Ÿ', url: 'https://placehold.co/150x120/ab47bc/ffffff?text=CHILD%20PLAYING%20ON%20PHONE' },
            ],
            // Game 7: ğŸƒ å‹•è©é€£é€£çœ‹ (Verb: Image_Concept for Present Continuous) - ä½¿ç”¨æ›´å…·é«”å’Œå¤šæ¨£çš„ Placeholder URL
            g7_verbs: [
                { id: crypto.randomUUID(), verb: 'IS JUMPING', image: 'è·³èº', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=JUMPING%20IN%20AIR' },
                { id: crypto.randomUUID(), verb: 'IS PAINTING', image: 'ç•«ç•«', url: 'https://placehold.co/150x120/ef5350/ffffff?text=KID%20PAINTING' },
                { id: crypto.randomUUID(), verb: 'IS SKIPPING', image: 'è·³ç¹©', url: 'https://placehold.co/150x120/64b5f6/000000?text=SKIPPING%20ROPE' },
                { id: crypto.randomUUID(), verb: 'IS JOGGING', image: 'æ…¢è·‘', url: 'https://placehold.co/150x120/4db6ac/000000?text=BOY%20JOGGING%20OUTSIDE' },
            ],
            // Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph: Word_Template)
            g8_digraphs: [
                { id: crypto.randomUUID(), digraph: 'SH', word: '_OP', full: 'SHOP' },
                { id: crypto.randomUUID(), digraph: 'CH', word: '_AT', full: 'CHAT' },
                { id: crypto.randomUUID(), digraph: 'TH', word: '_INK', full: 'THINK' },
                { id: crypto.randomUUID(), digraph: 'WH', word: '_ALE', full: 'WHALE' },
                { id: crypto.randomUUID(), digraph: 'PH', word: 'ELE_ANT', full: 'ELEPHANT' },
            ],
        };

        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        let state = {
            // G2
            g2_matchCards: [],
            g2_flippedCards: [],
            g2_matchCount: 0,
            g2_gameStatus: 'ready',
            // G3
            g3_currentGuessWord: '',
            g3_guessedLetters: new Set(),
            g3_wrongGuesses: 0,
            g3_gameStatus: 'ready',
            g3_MAX_WRONG: 6,
            g3_emojiHint: '', 
            // G4
            g4_players: [],
            g4_calledWords: new Set(),
            g4_lastCalledWord: '',
            g4_gameStatus: 'ready',
            g4_isCalling: false,
            // G5
            g5_currentSentence: '',
            g5_answerWords: [],
            g5_scrambleBlocks: [],
            g5_currentSort: [],
            g5_gameStatus: 'ready',
            // G6
            g6_targets: [],
            g6_sources: [],
            g6_matches: 0,
            // G7
            g7_targets: [], 
            g7_sources: [], 
            g7_matches: 0,
            // G8
            g8_currentWord: null,
            g8_gameStatus: 'ready',
            g8_score: 0,
        };

        // --- TTS & Utility ---

        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                console.warn("SpeechSynthesis not supported.");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => { console.error("SpeechSynthesis error:", e); resolve(); };
                window.speechSynthesis.speak(utterance);
            });
        }

        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        // --- LocalStorage å­˜å„²åŠŸèƒ½ (çµ±ä¸€ç®¡ç†æ‰€æœ‰éŠæˆ²æ•¸æ“š) ---

        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loaded = stored ? JSON.parse(stored) : {};
                
                // 1. åˆå§‹åŒ– localData ç‚º DEFAULT_WORDS çš„æ·±æ‹·è²ï¼ˆç¢ºä¿ ID ç¨ç«‹ï¼‰
                localData = JSON.parse(JSON.stringify(DEFAULT_WORDS));
                
                for (const key in loaded) {
                    if (Array.isArray(loaded[key])) {
                        localData[key] = loaded[key].map(item => {
                            // 2. ç¢ºä¿è¼‰å…¥çš„ç‰©ä»¶æœ‰ IDï¼Œå¦‚æœæ²’æœ‰ï¼Œè³¦äºˆä¸€å€‹æ–°çš„ ID
                            if (typeof item === 'object' && item !== null && !item.id) {
                                return { ...item, id: crypto.randomUUID() };
                            }
                            return item;
                        }).filter(item => item !== null && item !== undefined); 
                    }
                }
            } catch (e) {
                console.error("Error loading words from local storage:", e);
                // å¦‚æœå‡ºéŒ¯ï¼Œè‡³å°‘ä½¿ç”¨é è¨­å€¼
                localData = DEFAULT_WORDS;
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("ç„¡æ³•ä¿å­˜å–®å­—åˆ°æ‚¨çš„ç€è¦½å™¨ã€‚", true);
            }
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æ§åˆ¶ ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.querySelector(`.tab-btn[data-game="${gameName}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); // æ¯æ¬¡æ¸²æŸ“å‰è¼‰å…¥

            switch (currentGame) {
                
                case 'game2': initGame2(); break;
                case 'game3': initGame3(); break;
                case 'game4': initGame4(); break;
                case 'game5': initGame5(); break;
                case 'game6': initGame6(); break;
                case 'game7': initGame7(); break;
                case 'game8': initGame8(); break;
                case 'admin': renderWordAdmin(); break;
                default: document.getElementById('game-content').innerHTML = `<p class="text-xl text-gray-500 text-center p-10">è«‹é¸æ“‡ä¸€å€‹éŠæˆ²</p>`;
            }
        }

        window.onload = function() {
            // æ›¿æ›å°èˆªæŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('bg-white', 'hover:bg-secondary-blue', 'py-2', 'px-3', 'md:px-4', 'rounded-full', 'text-xs', 'md:text-sm', 'font-bold', 'text-gray-700', 'transition', 'duration-300', 'shadow-md');
            });
            setTabActive(currentGame);
            renderApp();
        }

        // --- Game 2: ğŸ¶ Phonics ç™¼éŸ³é…å° (Vowel Sound Match) ---
        const G2_COLORS = ['bg-red-200', 'bg-blue-200', 'bg-green-200', 'bg-yellow-200', 'bg-purple-200', 'bg-pink-200'];

        function initGame2() {
            const source = localData.g2_words;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ Phonics é…å°å–®å­—ï¼", true); return; }

            state.g2_matchCount = 0;
            state.g2_flippedCards = [];
            state.g2_gameStatus = 'playing';

            let cardValues = [];
            source.forEach((item, index) => {
                const color = G2_COLORS[index % G2_COLORS.length];
                const groupId = `match-${item.phonics}-${index}`;

                cardValues.push({ id: crypto.randomUUID(), type: 'PHONICS', value: item.phonics, groupId, color, matched: false, flipped: false, hint: item.hint });
                cardValues.push({ id: crypto.randomUUID(), type: 'WORD', value: item.word, groupId, color, matched: false, flipped: false, hint: item.hint });
            });

            state.g2_matchCards = shuffleArray(cardValues);
            renderGame2();
        }

        async function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card || card.matched || card.flipped || state.g2_flippedCards.length === 2) return;

            card.flipped = true;
            state.g2_flippedCards.push(card);
            
            // é»æ“Šå¡ç‰‡æ™‚ï¼Œä¸åŸ·è¡Œ callTTS(card.type === 'PHONICS' ? card.phonics : card.value);

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                if (card1.groupId === card2.groupId) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    state.g2_flippedCards = [];
                    renderGame2();
                    if (state.g2_matchCount === localData.g2_words.length) {
                        setTimeout(() => MessageBox.show("å¤ªæ£’äº†ï¼æ‰€æœ‰ç™¼éŸ³é…å°æˆåŠŸï¼ğŸ‰", false), 500);
                        state.g2_gameStatus = 'won';
                    }
                } else {
                    setTimeout(() => {
                        state.g2_matchCards.forEach(c => {
                            if (c.id === card1.id || c.id === card2.id) c.flipped = false;
                        });
                        state.g2_flippedCards = [];
                        renderGame2();
                    }, 1000);
                }
            }
            renderGame2();
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-lg md:text-2xl font-extrabold text-gray-800`;

                if (card.matched) {
                    cardClasses += ` matched-success`;
                    content = `${card.phonics} / ${card.value}`;
                } else if (card.flipped) {
                    cardClasses += ` ${card.color} border-gray-500`;
                    content = card.type === 'PHONICS' ? `[${card.value}]` : card.value;
                } else {
                    cardClasses += ` bg-secondary-blue border-blue-600`;
                    content = card.type === 'PHONICS' ? 'Phonics' : 'Word';
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" onclick="handleCardClickG2('${card.id}')">
                        <div class="${cardClasses}">
                            <div class="text-center">
                                <span class="${innerTextClass}">
                                    ${content}
                                </span>
                                ${card.flipped && card.type === 'WORD' ? `<p class="text-xs text-gray-600 mt-1">(${card.hint})</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">ğŸ¶ Phonics ç™¼éŸ³é…å° (Vowel Sound Match)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šå¡ç‰‡ï¼Œé…å°ç›¸åŒçš„é•·æ¯éŸ³çµ„åˆ ([A-E], [IE] ç­‰) å’Œå°æ‡‰çš„å–®å­—ã€‚å·²å®Œæˆ ${state.g2_matchCount}/${localData.g2_words.length} çµ„ã€‚</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-2xl mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_matchCount === localData.g2_words.length ? 'å†ç©ä¸€æ¬¡' : 'é‡æ–°é–‹å§‹'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- Game 2 End ---

        // --- Game 3: ğŸ–ï¸ Hangman çŒœå–®å­— (Hangman) ---
        function getHangmanSVG(wrongGuesses, status) {
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            parts.push(`<line x1="50" y1="200" x2="150" y1="200" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="200" x2="100" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 
            if (wrongGuesses >= 1) parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            if (wrongGuesses >= 2) parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            if (wrongGuesses >= 3) parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            if (wrongGuesses >= 4) parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            if (wrongGuesses >= 5) parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            if (wrongGuesses >= 6) parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            return `<svg width="200" height="220" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">${parts.join('')}</svg>`;
        }

        function getEmojiHint(word) {
            // å˜—è©¦ç²¾ç¢ºåŒ¹é…ï¼Œå¦å‰‡è¿”å›ä¸€å€‹å•è™Ÿ
            return G3_EMOJI_HINTS[word] || 'â“';
        }

        function initGame3() {
            const source = localData.g3_words;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ Hangman å–®å­—ï¼", true); return; }

            const randomWord = source[Math.floor(Math.random() * source.length)];
            state.g3_currentGuessWord = randomWord.toUpperCase(); 
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            state.g3_emojiHint = getEmojiHint(state.g3_currentGuessWord);
            renderGame3(); 
        }

        function guessLetterG3(letter) {
            const upperCaseLetter = letter.toUpperCase();
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(upperCaseLetter)) return;
            
            state.g3_guessedLetters.add(upperCaseLetter);
            if (!state.g3_currentGuessWord.includes(upperCaseLetter)) state.g3_wrongGuesses++;
            checkWinConditionG3();
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                MessageBox.show(`æ­å–œæ‚¨ï¼å–®å­—æ˜¯ ${state.g3_currentGuessWord}ï¼ğŸ‰`, false);
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`å¾ˆå¯æƒœã€‚æ­£ç¢ºå–®å­—æ˜¯ ${state.g3_currentGuessWord}ã€‚ğŸ˜­`, true);
            }
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;

            const displayWord = state.g3_currentGuessWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost';
                if (state.g3_guessedLetters.has(char) || isGameOver) {
                    return char.toLowerCase(); 
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                const upperCaseLetter = letter.toUpperCase();
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(upperCaseLetter)) {
                    btnClass = state.g3_currentGuessWord.includes(upperCaseLetter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }
                if (state.g3_gameStatus !== 'playing') { btnClass = 'bg-gray-300 cursor-not-allowed'; onClick = ''; }

                return `<button onclick="${onClick}" class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-2xl font-extrabold rounded-xl transition duration-150 text-gray-800">${letter}</button>`;
            }).join('');

            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ–ï¸ Hangman çŒœå–®å­— (Word Guess)</h2>
                </section>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">ğŸ’” éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">${hangmanDrawing}</div>
                        <p class="text-4xl mt-2 text-center">æç¤º: ${state.g3_emojiHint}</p>
                    </div>
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">çŒœæ¸¬å–®å­—:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">${displayWord}</div>
                        <div class="grid grid-cols-7 gap-1 md:gap-2">${alphabetBtns}</div>
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? 'é‡è¨­éŠæˆ²' : 'é–‹å§‹æ–°éŠæˆ²'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- Game 3 End ---

        // --- Game 4: ğŸ¤ é›™äººè³“æœ (Bingo) ---
        function generateBingoCardG4() {
            const source = localData.g4_bingo_words;
            if (source.length < G4_BINGO_SIZE * G4_BINGO_SIZE) {
                MessageBox.show(`è³“æœå–®å­—åº«ä¸è¶³ ${G4_BINGO_SIZE * G4_BINGO_SIZE} å€‹ï¼`, true);
                return Array(G4_BINGO_SIZE * G4_BINGO_SIZE).fill('ERROR');
            }
            return shuffleArray(source).slice(0, G4_BINGO_SIZE * G4_BINGO_SIZE);
        }

        function checkWinG4(player) {
            let lines = 0;
            const size = G4_BINGO_SIZE;
            const card = player.card;
            const marked = player.marked;

            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    if (marked.has(card[i * size + j])) rowCount++;
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }
            let diag1Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + i])) diag1Count++; }
            if (diag1Count === size) lines++;

            let diag2Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++; }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            return lines >= 2;
        }

        function initGame4() {
            state.g4_players = [
                { id: 1, name: 'ç©å®¶ 1', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
                { id: 2, name: 'ç©å®¶ 2', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
            ];
            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_gameStatus = 'ready';
            state.g4_isCalling = false;
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') { initGame4(); return; }
            if (state.g4_isCalling) return;
            
            const availableWords = shuffleArray(localData.g4_bingo_words.filter(w => !state.g4_calledWords.has(w)));
            if (availableWords.length === 0) { MessageBox.show("å–®å­—åº«å·²æŠ½å®Œï¼", true); return; }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord;
            state.g4_calledWords.add(nextWord);
            
            state.g4_isCalling = true;
            state.g4_gameStatus = 'calling';
            renderGame4(); 
            
            await callTTS(nextWord); 
            
            state.g4_isCalling = false; 

            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`è³“æœï¼ç©å®¶ ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' å’Œ ')} ç²å‹ï¼`, false);
            } else {
                renderGame4();
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index];

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) player.marked.delete(word);
                else player.marked.add(word);

                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished';
                    MessageBox.show(`è³“æœï¼ç©å®¶ ${playerId} ç²å‹ï¼`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`å–®å­— ${word} å°šæœªè¢«å”¸å‡ºï¼`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `<div class="bingo-cell ${isMarked ? 'marked' : 'hover:bg-yellow-300'}" onclick="handleCardClickG4(${player.id}, ${index})">${word}</div>`;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">${player.name} ${player.winner ? 'ğŸ‰ WINNER ğŸ‰' : ''} (ç·šæ•¸: ${player.score})</h3>
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${G4_BINGO_SIZE}, 1fr); grid-template-rows: repeat(${G4_BINGO_SIZE}, 1fr); max-width: 300px;">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };

            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">${state.g4_gameStatus === 'ready' ? 'æº–å‚™é–‹å§‹' : state.g4_gameStatus === 'calling' ? 'éŠæˆ²ä¸­' : 'éŠæˆ²çµæŸ'}</h3>
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <p class="text-4xl font-black text-red-700 transition duration-300">
                            ${state.g4_lastCalledWord ? `å–®å­—: ${state.g4_lastCalledWord}` : state.g4_gameStatus === 'ready' ? 'é»æ“Šé–‹å§‹æŒ‰éˆ•' : 'ç­‰å¾…ä¸‹ä¸€è¼ª...'}
                        </p>
                    </div>
                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? 'ğŸ”Š é–‹å§‹éŠæˆ² / æŠ½å–å–®å­—' : state.g4_gameStatus === 'calling' ? (state.g4_isCalling ? 'ğŸ™ï¸ æ’­å ±ä¸­...' : 'ğŸ”Š æŠ½å–ä¸‹ä¸€å€‹å–®å­—') : 'ğŸ”„ é‡æ–°é–‹å§‹'}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">å·²æŠ½å‡º ${state.g4_calledWords.size} å€‹å–®å­— / å‰©é¤˜ ${localData.g4_bingo_words.length - state.g4_calledWords.size} å€‹</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ¤ é›™äººè‹±æ–‡è³“æœ (Two-Player Bingo)</h2>
                    <p class="text-center text-sm text-blue-900 mb-6">ç›®æ¨™: è½å–å–®å­—ï¼Œä¸¦åœ¨æ‚¨çš„ 4x4 è³“æœå¡ä¸Šæ¨™è¨˜ã€‚æœ€å…ˆå®Œæˆå…©æ¢ç·šç²å‹ï¼</p>
                    ${controlArea}
                    <div class="flex flex-col md:flex-row gap-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                </section>
            `;
        }
        // --- Game 4 End ---

        // --- Game 5: ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (Sentence Scramble Master) ---
        function getSentenceTokens(sentence) {
            // é€™å€‹æ­£å‰‡è¡¨é”å¼æœƒå°‡å–®å­—ã€ç¸®å¯« (e.g., 's) å’Œæ¨™é»ç¬¦è™Ÿåˆ†é›¢ç‚ºç¨ç«‹è©å¡Š
            return sentence.match(/\b\w+'?\w*\b|[.,?!]/g) || [];
        }

        function shuffleWordsG5(sentence) {
            const words = getSentenceTokens(sentence);
            
            // è¤‡è£½ä¸€ä»½ç”¨æ–¼æ‰“äº‚ï¼Œä¸¦åŠ å…¥ ID
            const scrambleArray = words.map(word => ({ id: crypto.randomUUID(), value: word.toUpperCase(), isUsed: false }));
            
            // åƒ…æ‰“äº‚å–®å­—å’Œæ¨™é»ç¬¦è™Ÿçš„é †åº
            for (let i = scrambleArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [scrambleArray[i], scrambleArray[j]] = [scrambleArray[j], scrambleArray[i]];
            }
            return scrambleArray;
        }

        function initGame5() {
            const source = localData.g5_sentences;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢å•å¥ï¼", true); return; }

            state.g5_currentSentence = source[Math.floor(Math.random() * source.length)];
            
            // 1. ç”¢ç”Ÿäº‚åºè©å¡Š
            state.g5_scrambleBlocks = shuffleWordsG5(state.g5_currentSentence);
            
            // 2. åˆå§‹åŒ–ç­”æ¡ˆæ§½ä½ (æ•¸é‡ç­‰æ–¼è©å¡Šç¸½æ•¸)
            state.g5_currentSort = Array(state.g5_scrambleBlocks.length).fill(null); 
            state.g5_gameStatus = 'playing';

            renderGame5();
        }
        
        async function speakSentenceG5(sentence) { await callTTS(sentence); }

        function handleWordClickG5(id) {
            const wordBlock = state.g5_scrambleBlocks.find(l => l.id === id);
            if (!wordBlock || wordBlock.isUsed || state.g5_gameStatus !== 'playing') return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = { value: wordBlock.value, id: wordBlock.id };
                wordBlock.isUsed = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const item = state.g5_currentSort[index];
            if (!item || state.g5_gameStatus !== 'playing') return;

            // æ‰¾åˆ°è¢«ä½¿ç”¨çš„è©å¡Šï¼Œå°‡å…¶æ¨™è¨˜ç‚ºæœªä½¿ç”¨
            const originalBlock = state.g5_scrambleBlocks.find(l => l.id === item.id);
            if (originalBlock) originalBlock.isUsed = false;
            
            // å°‡å¾ŒçºŒçš„è©å¡Šå¾€å‰ç§»ï¼Œå¡«è£œç©ºä½
            for (let i = index; i < state.g5_currentSort.length - 1; i++) {
                state.g5_currentSort[i] = state.g5_currentSort[i + 1];
            }
            state.g5_currentSort[state.g5_currentSort.length - 1] = null;

            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            // --- åµéŒ¯ä¿®æ­£: ä½¿ç”¨è©å¡Šåºåˆ—æ¯”å° ---
            
            // 1. å–å¾—ç›®æ¨™ï¼ˆæ­£è¦ï¼‰çš„è©å¡Šåºåˆ— (Tokens)
            const targetTokens = getSentenceTokens(state.g5_currentSentence).map(t => t.toUpperCase());
            
            // 2. å–å¾—ç”¨æˆ¶æ’åˆ—çš„è©å¡Šåºåˆ—
            const currentTokens = state.g5_currentSort.map(item => item.value.toUpperCase());
            
            // 3. æ¯”è¼ƒåºåˆ—çš„é•·åº¦å’Œå…§å®¹
            let isCorrect = targetTokens.length === currentTokens.length;
            if (isCorrect) {
                for (let i = 0; i < targetTokens.length; i++) {
                    // ç¢ºä¿é€ä¸€æ¯”è¼ƒæ¯å€‹è©å¡Šï¼ˆåŒ…æ‹¬æ¨™é»ç¬¦è™Ÿï¼‰
                    if (targetTokens[i] !== currentTokens[i]) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            if (isCorrect) {
                state.g5_gameStatus = 'won';
                MessageBox.show("å¤ªæ£’äº†ï¼å¥å­é †åºå®Œå…¨æ­£ç¢ºï¼ğŸ‰", false);
                speakSentenceG5(state.g5_currentSentence); 
            } else {
                const slots = document.querySelectorAll('.answer-slot');
                slots.forEach(slot => {
                    slot.classList.add('incorrect');
                    setTimeout(() => slot.classList.remove('incorrect'), 500);
                });
                MessageBox.show("é †åºä¸æ­£ç¢ºï¼Œè«‹å†è©¦è©¦çœ‹ï¼", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((item, index) => {
                const isFilled = item !== null;
                const displayWord = isFilled ? item.value : 'ï¼ˆé»æ“Šè©å¡Šå¡«å…¥ï¼‰';
                
                return `
                    <div class="answer-slot ${isFilled ? 'filled bg-green-200 border-green-400' : ''}"
                         onclick="handleResetTargetG5(${index})">
                        ${displayWord}
                    </div>
                `;
            }).join('');

            const letterBlocksHtml = state.g5_scrambleBlocks.map(wordBlock => `
                <button onclick="handleWordClickG5('${wordBlock.id}')"
                        class="word-block ${wordBlock.isUsed ? 'used' : 'hover:bg-yellow-300'}"
                        ${wordBlock.isUsed || state.g5_gameStatus !== 'playing' ? 'disabled' : ''}>
                    ${wordBlock.value}
                </button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (Sentence Scramble Master)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ğŸ’¡ é»æ“Šè©å¡Šï¼Œé‡çµ„å¥å­çš„æ­£ç¢ºé †åºï¼</p>
                </section>
                
                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    <div class="text-center mb-6">
                        <button onclick="speakSentenceG5(state.g5_currentSentence)" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            ğŸ”Š æœ—è®€åŸå§‹å¥å­ (è½åŠ›è¼”åŠ©)
                        </button>
                    </div>

                    <div class="text-center mb-6 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300 w-full">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ç­”æ¡ˆå€ (é»æ“Šå·²å¡«å…¥è©å¡Šå¯ç§»é™¤)</h3>
                        <div class="flex flex-wrap justify-center">
                            ${targetBoxesHtml}
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">è©å¡Šåº« (é»æ“Šå¡«å…¥)</h3>
                    <div class="flex flex-wrap justify-center p-2">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g5_gameStatus === 'won' ? 'å†ç©ä¸€æ¬¡' : 'æ›å€‹å¥å­'}
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 5 End ---

        // --- Game 6: ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Daily Routine Image Match) ---
        function initGame6() {
            const source = localData.g6_routines;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢æ—¥å¸¸æ´»å‹•ï¼", true); return; }

            // éš¨æ©Ÿé¸å– 4 å€‹é…å°
            const pairs = shuffleArray(source).slice(0, 4);
            
            state.g6_targets = pairs.map(p => ({ ...p, matched: false })); // åœ–ç‰‡ (Target)
            state.g6_sources = shuffleArray(pairs.map(p => ({ id: crypto.randomUUID(), word: p.word, isMatched: false }))); // å–®å­—å¡ (Source)
            state.g6_matches = 0;
            
            // å•Ÿç”¨æ‹–æ›³åŠŸèƒ½
            setupDragDropG6();

            renderGame6();
        }

        function setupDragDropG6() {
            let draggedItem = null;

            document.ondragstart = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    draggedItem = e.target.dataset.word;
                    e.dataTransfer.setData('text/plain', draggedItem);
                    e.target.classList.add('opacity-50');
                }
            };

            document.ondragend = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    e.target.classList.remove('opacity-50');
                    draggedItem = null;
                }
            };

            document.ondragover = (e) => {
                const target = e.target.closest('.image-target');
                if (target) e.preventDefault();
            };

            document.ondrop = (e) => {
                const target = e.target.closest('.image-target');
                if (target && draggedItem) {
                    e.preventDefault();
                    
                    const targetWord = target.dataset.word; // åœ–ç‰‡çš„æ­£ç¢ºå–®å­—
                    const sourceWord = draggedItem; // æ‹–æ›³ä¾†æºçš„å–®å­—

                    if (sourceWord === targetWord) {
                        handleMatchG6(sourceWord, targetWord, target);
                    } else {
                        MessageBox.show('é…å°éŒ¯èª¤ï¼Œè«‹å†è©¦è©¦ï¼', true);
                    }
                }
            };
        }
        
        async function handleMatchG6(sourceWord, targetWord, targetElement) {
            state.g6_matches++;

            // 1. æ¨™è¨˜åœ–ç‰‡ç‚ºå·²é…å°
            const targetIndex = state.g6_targets.findIndex(t => t.word === targetWord);
            if (targetIndex !== -1) state.g6_targets[targetIndex].matched = true;

            // 2. ç§»é™¤ä¾†æºå¡ç‰‡
            state.g6_sources = state.g6_sources.filter(s => s.word !== sourceWord);

            // 3. æ›´æ–° UI
            renderGame6();
            
            // 4. çµ¦äºˆå›é¥‹ (ä¸ç™¼è²)
            targetElement.classList.add('border-green-600', 'bg-green-100');
            MessageBox.show('é…å°æˆåŠŸï¼ğŸ‰', false);

            if (state.g6_matches === state.g6_targets.length) {
                MessageBox.show('å¤ªæ£’äº†ï¼æ‰€æœ‰æ—¥å¸¸æ´»å‹•éƒ½é…å°æˆåŠŸï¼', false);
            }
        }


        function renderGame6() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game6') return;

            const targetsHtml = state.g6_targets.map(t => {
                const isMatched = t.matched;
                return `
                    <div id="target-${t.word.replace(/\s/g, '_')}" 
                         data-word="${t.word}" 
                         class="image-target ${isMatched ? 'border-green-600 bg-green-100' : 'border-primary-pink'} p-2">
                        <img src="${t.url}" alt="${t.image}" onerror="this.onerror=null; this.src='https://placehold.co/150x120/808080/ffffff?text=${t.word.replace(/\s/g, '+')}'" class="w-24 h-24 object-cover rounded-md mb-1"/>
                        <p class="text-sm font-semibold text-gray-700">(${t.image})</p>
                        ${isMatched ? `<p class="text-lg font-bold text-green-700 mt-1">${t.word}</p>` : ''}
                    </div>
                `;
            }).join('');

            const sourcesHtml = state.g6_sources.map(s => `
                <button draggable="true" data-word="${s.word}" class="drag-source key-btn bg-accent-yellow hover:bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-xl text-sm md:text-base">${s.word}</button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Daily Routine Image Match)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: å°‡ä¸‹æ–¹çš„å–®å­—å¡æ‹–æ›³åˆ°ä¸Šæ–¹å°æ‡‰çš„æ—¥å¸¸æ´»å‹•åœ–ç‰‡ä¸Šã€‚</p>
                </section>
                
                <div class="p-4 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        ${targetsHtml}
                    </div>
                </div>

                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow w-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æ‹–æ›³å–®å­—åº« (${state.g6_sources.length} å‰©é¤˜)</h3>
                    <div class="flex flex-wrap justify-center gap-3 drag-area">
                        ${sourcesHtml.length > 0 ? sourcesHtml : '<p class="text-lg font-bold text-green-700">å…¨éƒ¨å®Œæˆï¼</p>'}
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame6()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">é‡æ–°é–‹å§‹</button>
                </div>
            `;

            if (state.g6_sources.length > 0) setupDragDropG6();
        }
        // --- Game 6 End ---

        // --- Game 7: ğŸƒ å‹•è©é€£é€£çœ‹ (Action Verb Connector) ---
        function initGame7() {
            const source = localData.g7_verbs;
            if (source.length < 3) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢è‡³å°‘ 3 å€‹å‹•è©é€£é€£çœ‹è©å½™ï¼", true); return; }

            const pairs = shuffleArray(source).slice(0, 3);
            
            // å·¦å´ï¼šä¸»è© (He/She) - éš¨æ©Ÿ
            state.g7_targets = pairs.map(p => ({ 
                ...p, 
                id: crypto.randomUUID(), 
                subject: Math.random() < 0.5 ? 'HE IS' : 'SHE IS', 
                matched: false 
            })); 
            
            // å³å´ï¼šå‹•ä½œ (Verb) - æ‰“äº‚
            state.g7_sources = shuffleArray(pairs.map(p => ({ id: crypto.randomUUID(), verb: p.verb, isMatched: false }))); 
            
            state.g7_matches = 0;
            state.g7_selectedSource = null; // é»æ“Šé¸ä¸­çš„å‹•è©

            renderGame7();
        }

        async function handleSourceClickG7(verb) {
            if (state.g7_matches === state.g7_targets.length) return;
            state.g7_selectedSource = verb;
            // ç§»é™¤ callTTS(verb);
            renderGame7();
        }

        async function handleTargetClickG7(targetId) {
            if (!state.g7_selectedSource) {
                MessageBox.show('è«‹å…ˆé»æ“Šä¸€å€‹å‹•è©ï¼', true);
                return;
            }

            const targetIndex = state.g7_targets.findIndex(t => t.id === targetId);
            const target = state.g7_targets[targetIndex];

            if (target.matched) return;

            // é‚è¼¯: ä»»ä½• Subject + Verb Phrase éƒ½æ˜¯æ­£ç¢ºçš„ï¼Œåªè¦æ˜¯æœªé…å°çš„ç›®æ¨™å³å¯
            if (!target.matched) {
                state.g7_matches++;
                target.matched = true;
                target.finalVerb = state.g7_selectedSource; // æ¨™è¨˜æœ€çµ‚é…å°çš„å‹•è©
                
                // ç§»é™¤å·²ä½¿ç”¨çš„å‹•è©ä¾†æº
                state.g7_sources = state.g7_sources.filter(s => s.verb !== state.g7_selectedSource);

                const fullSentence = `${target.subject} ${target.finalVerb}.`;
                MessageBox.show('é€£ç·šæˆåŠŸï¼ğŸ‰', false);
                // ç§»é™¤ callTTS(fullSentence);
                
                state.g7_selectedSource = null;
                renderGame7();

                if (state.g7_matches === state.g7_targets.length) {
                    MessageBox.show('æ­å–œï¼æ‰€æœ‰é€£ç·šå®Œæˆï¼', false);
                }
            }
        }

        function renderGame7() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game7') return;

            const targetsHtml = state.g7_targets.map(t => {
                const isMatched = t.matched;
                const sentence = isMatched ? `${t.subject} ${t.finalVerb}.` : `${t.subject} _____ ?`;
                return `
                    <div id="target-${t.id}" 
                         onclick="handleTargetClickG7('${t.id}')"
                         class="p-3 image-target ${isMatched ? 'border-green-600 bg-green-100' : 'border-secondary-blue hover:bg-blue-100'} cursor-pointer">
                        <img src="${t.url}" alt="${t.image}" onerror="this.onerror=null; this.src='https://placehold.co/150x120/808080/ffffff?text=${t.image.replace(/\s/g, '+')}'" class="w-24 h-24 object-cover rounded-md mb-1"/>
                        <p class="text-xs font-semibold text-gray-700">(${t.image})</p>
                        <p class="text-lg font-bold text-center mt-2 ${isMatched ? 'text-green-700' : 'text-blue-800'}">${sentence}</p>
                    </div>
                `;
            }).join('');

            const sourcesHtml = state.g7_sources.map(s => {
                const isSelected = state.g7_selectedSource === s.verb;
                return `
                    <button onclick="handleSourceClickG7('${s.verb}')" 
                            class="key-btn font-bold py-2 px-4 rounded-xl text-sm md:text-base 
                                ${isSelected ? 'bg-primary-pink shadow-xl ring-4 ring-pink-500' : 'bg-accent-yellow hover:bg-yellow-400 shadow-cute'}">
                        ${s.verb}
                    </button>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸƒ å‹•è©é€£é€£çœ‹ (Action Verb Connector)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: é»æ“Šä¸‹æ–¹çš„å‹•è©å¡ (Verb)ï¼Œå†é»æ“Šä¸Šæ–¹çš„åœ–ç‰‡ (Subject)ï¼Œçµ„æˆæ­£ç¢ºçš„ç¾åœ¨é€²è¡Œå¼å¥å­ã€‚</p>
                </section>
                
                <div class="p-4 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full">
                    <div class="grid grid-cols-3 gap-4">
                        ${targetsHtml}
                    </div>
                </div>

                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow w-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">å‹•è©åº« (${state.g7_sources.length} å‰©é¤˜)</h3>
                    <div class="flex flex-wrap justify-center gap-3">
                        ${sourcesHtml}
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame7()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">é‡æ–°é–‹å§‹</button>
                </div>
            `;
        }
        // --- Game 7 End ---

        // --- Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph Blaster) ---
        function initGame8() {
            const source = localData.g8_digraphs;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ Digraph å–®å­—ï¼", true); return; }

            state.g8_currentWord = shuffleArray(source)[0];
            state.g8_gameStatus = 'playing';
            state.g8_score = 0; // é‡ç½®åˆ†æ•¸
            
            // æ¯æ¬¡å‡ºé¡Œæ™‚è‡ªå‹•æœ—è®€ä¸€æ¬¡
            callTTS(state.g8_currentWord.full);

            renderGame8();
        }
        
        async function handleDigraphClickG8(digraph) {
            if (state.g8_gameStatus !== 'playing') return;

            if (digraph === state.g8_currentWord.digraph) {
                state.g8_score++;
                MessageBox.show('æ­£ç¢ºï¼ç™¼å°„æˆåŠŸï¼ğŸ’¥', false);
                
                // å»¶é²æ›é¡Œ
                setTimeout(() => {
                    const available = localData.g8_digraphs.filter(w => w.full !== state.g8_currentWord.full);
                    if (available.length > 0) {
                        state.g8_currentWord = shuffleArray(available)[0];
                        callTTS(state.g8_currentWord.full); // æ–°é¡Œç›®æœ—è®€
                    } else {
                        state.g8_currentWord = { digraph: 'ALL', word: 'DONE', full: 'ALL DONE' };
                        state.g8_gameStatus = 'won';
                    }
                    renderGame8();
                }, 1500);

            } else {
                state.g8_score = Math.max(0, state.g8_score - 1); // æ‰£åˆ†
                MessageBox.show('éŒ¯èª¤ï¼ç™¼å°„å¤±æ•—ï¼å†è©¦è©¦å…¶ä»–çµ„åˆã€‚', true);
                
                // éŒ¯èª¤æ™‚ï¼Œä¸æœ—è®€ï¼Œä½†ä¿æŒç•¶å‰é¡Œç›®
            }
            renderGame8();
        }

        function renderGame8() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game8') return;

            const wordBlock = state.g8_currentWord;
            const blanks = wordBlock.word.includes('_') ? wordBlock.word.split('_') : ['', ''];
            
            const allDigraphs = [...new Set(localData.g8_digraphs.map(d => d.digraph))];
            const digraphButtons = shuffleArray(allDigraphs).map(d => `
                <button onclick="handleDigraphClickG8('${d}')"
                        class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-3xl font-bold text-white rounded-xl transition duration-150">
                    ${d}
                </button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph Blaster)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: é»æ“Šæ­£ç¢ºçš„è¼”éŸ³å­—æ¯çµ„åˆ (${allDigraphs.join(', ')}) ä¾†å®Œæˆå–®å­—ï¼</p>
                </section>
                
                <div class="text-center text-2xl font-bold text-gray-700 mb-4">åˆ†æ•¸: ${state.g8_score}</div>

                ${state.g8_gameStatus !== 'won' ? `
                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    
                    <div class="flex flex-col items-center justify-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">é»æ“Šå–‡å­è½å–å–®å­—ç™¼éŸ³:</h3>
                        
                        <div class="flex items-center space-x-4">
                            <div class="digraph-display-box flex items-center justify-center space-x-2 shadow-lg">
                                <span class="digraph-letter-part">${blanks[0]}</span>
                                <div class="digraph-blank">?</div>
                                <span class="digraph-letter-part">${blanks[1]}</span>
                            </div>
                            <button onclick="callTTS(state.g8_currentWord.full)" 
                                    class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-200"
                                    title="æœ—è®€å–®å­—">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2V15H6L11 19V5ZM19.5 12C19.5 14.3283 18.0792 16.3262 16 17.2025V6.7975C18.0792 7.67384 19.5 9.67174 19.5 12ZM16 13C16.8284 13 17.5 12.3284 17.5 11.5C17.5 10.6716 16.8284 10 16 10V13Z"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 w-full max-w-lg">
                        ${digraphButtons}
                    </div>
                </div>
                ` : `<p class="text-4xl font-black text-green-700 p-10">æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰æŒ‘æˆ°ï¼ç¸½åˆ† ${state.g8_score}ï¼</p>`}
                
                <div class="text-center mt-6">
                    <button onclick="initGame8()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">é‡æ–°é–‹å§‹</button>
                </div>
            `;
        }
        // --- Game 8 End ---

        // --- AI Image Generation Function ---

        async function generateImageAndAddWord(key, wordPhrase, imageConcept) {
            if (isGeneratingImage) return;

            // ğŸš¨ è©¢å•æ–°çš„ API é‡‘é‘°ï¼Œä½¿ç”¨æˆ¶ä¸å¿…ç¡¬ç·¨ç¢¼é‡‘é‘°
            const apiKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google AI API Key ä»¥ç”Ÿæˆåœ–ç‰‡ï¼š\n(æ­¤é‡‘é‘°åªæœƒåœ¨æœ¬æ¬¡æœƒè©±ä¸­ä½¿ç”¨ï¼Œä¸æœƒè¢«å„²å­˜åˆ°å…¬é–‹ç¨‹å¼ç¢¼ä¸­)");
            if (!apiKey || apiKey.trim() === "") {
                MessageBox.show("åœ–ç‰‡ç”Ÿæˆéœ€è¦æœ‰æ•ˆçš„ API Keyã€‚", true);
                return;
            }

            isGeneratingImage = true;
            
            // ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ›´æ–°
            const addButton = document.getElementById('admin-add-button');
            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> ğŸ¤– ç”Ÿæˆåœ–ç‰‡ä¸­...';
            }
            
            // å»ºç«‹é‡å°å…’ç«¥çš„å¡é€šé¢¨æ ¼æç¤º
            const promptText = `A vibrant, clean cartoon illustration of a young child performing the action: ${wordPhrase}. The scene should be bright, cheerful, with thick outlines, suitable for primary school ESL students.`;
            
            const payload = { 
                instances: { prompt: promptText }, 
                parameters: { "sampleCount": 1 } 
            };

            // ä½¿ç”¨ç”¨æˆ¶æä¾›çš„ API Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            let generatedUrl = '';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    generatedUrl = `data:image/png;base64,${base64Data}`;
                } else if (result.error) {
                    MessageBox.show(`AI éŒ¯èª¤: ${result.error.message}. è«‹æª¢æŸ¥é‡‘é‘°æ˜¯å¦æœ‰æ•ˆã€‚`, true);
                } else {
                    MessageBox.show("AI åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æç¤ºè©æˆ–é‡‘é‘°ç‹€æ…‹ã€‚", true);
                }
            } catch (error) {
                console.error("Image generation API error:", error);
                MessageBox.show("åœ–ç‰‡ç”Ÿæˆæ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚", true);
            } finally {
                isGeneratingImage = false;
            }

            if (generatedUrl) {
                // æ‰‹å‹•æ§‹å»ºä¸¦ä¿å­˜æ¢ç›®
                let newEntry = null;
                const newId = crypto.randomUUID();
                if (key === 'g6_routines') {
                    newEntry = { id: newId, word: wordPhrase, image: imageConcept, url: generatedUrl };
                    localData[key].push(newEntry);
                } else if (key === 'g7_verbs') {
                    newEntry = { id: newId, verb: wordPhrase, image: imageConcept, url: generatedUrl };
                    localData[key].push(newEntry);
                }
                
                if (newEntry) {
                    saveWordsToLocal();
                    MessageBox.show(`AI åœ–ç‰‡ç”Ÿæˆä¸¦æ–°å¢è©å½™æˆåŠŸï¼`, false);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¬„ä½ä¸¦é‡æ–°æ¸²æŸ“
                    document.getElementById('admin-input-1').value = '';
                    document.getElementById('admin-input-2').value = '';
                    document.getElementById('admin-input-3').value = '';
                    renderWordAdmin();
                    return;
                }
            }
            
            // å¦‚æœç”Ÿæˆå¤±æ•—ï¼Œç¢ºä¿æŒ‰éˆ•é‡è¨­
            renderWordAdmin();
        }

        // --- Admin Panel ---
        const ADMIN_TABS = [
            { key: 'g2_words', name: 'ğŸ¶ Phonics é…å°', isObjectArray: true },
            { key: 'g3_words', name: 'ğŸ–ï¸ Hangman', isObjectArray: false },
            { key: 'g4_bingo_words', name: 'ğŸ¤ è³“æœå–®å­—', isObjectArray: false },
            { key: 'g5_sentences', name: 'ğŸ’¬ å•å¥é‡çµ„', isObjectArray: false },
            { key: 'g6_routines', name: 'ğŸ¤¸ æ—¥å¸¸æ´»å‹•', isObjectArray: true },
            { key: 'g7_verbs', name: 'ğŸƒ å‹•è©é€£é€£çœ‹', isObjectArray: true },
            { key: 'g8_digraphs', name: 'ğŸ’¥ ç™¼éŸ³æ©Ÿ', isObjectArray: true },
        ];
        let currentAdminKey = ADMIN_TABS[0].key;

        function getCurrentAdminTab() {
            return ADMIN_TABS.find(t => t.key === currentAdminKey);
        }

        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const currentList = localData[currentAdminKey] || [];
            const currentTab = getCurrentAdminTab();
            
            // æ ¹æ“šé¡å‹èª¿æ•´è¼¸å…¥æ¬„ä½
            let inputField = '';
            let addButtonText = 'â• æ–°å¢';
            if (isGeneratingImage) addButtonText = 'ğŸ¤– ç”Ÿæˆåœ–ç‰‡ä¸­...';

            if (currentAdminKey === 'g2_words') {
                inputField = `
                    <input type="text" id="admin-input-1" placeholder="Phonics çµ„åˆ (å¦‚: IE)" maxlength="5" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase w-1/4">
                    <input type="text" id="admin-input-2" placeholder="å°æ‡‰å–®å­— (å¦‚: PIE)" maxlength="20" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                    <input type="text" id="admin-input-3" placeholder="ä¸­æ–‡æç¤º (é¸å¡«)" maxlength="20" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                `;
            } else if (currentAdminKey === 'g8_digraphs') {
                inputField = `
                    <input type="text" id="admin-input-1" placeholder="Digraphs (å¦‚: SH)" maxlength="3" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase w-1/4">
                    <input type="text" id="admin-input-2" placeholder="ä¸å®Œæ•´å–®å­— (å¦‚: _OP)" maxlength="10" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                    <input type="text" id="admin-input-3" placeholder="å®Œæ•´å–®å­— (å¦‚: SHOP)" maxlength="10" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                `;
            } else if (currentAdminKey === 'g6_routines' || currentAdminKey === 'g7_verbs') {
                inputField = `
                    <input type="text" id="admin-input-1" placeholder="è‹±æ–‡ç‰‡èª/å‹•ä½œ (å¦‚: BRUSH TEETH)" maxlength="30" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                    <input type="text" id="admin-input-2" placeholder="ä¸­æ–‡/åœ–ç‰‡æ¦‚å¿µ (å¦‚: åˆ·ç‰™)" maxlength="20" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                    <input type="text" id="admin-input-3" placeholder="åœ–ç‰‡URL (ç•™ç©ºå‰‡AIç”Ÿæˆ)" maxlength="100" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                `;
                addButtonText = isGeneratingImage ? addButtonText : 'âœ¨ AIç”Ÿæˆä¸¦æ–°å¢';
            } else {
                inputField = `<input type="text" id="admin-input-1" placeholder="å–®å­—æˆ–å®Œæ•´å¥å­" maxlength="100" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase w-full">`;
            }

            const wordListHtml = currentList.map((item, index) => {
                let display;
                let deleteId;

                if (currentTab.isObjectArray) {
                    // Object Array: Use item.id for deletion
                    display = JSON.stringify(item).replace(/"/g, '').replace(/{|}/g, '').toUpperCase();
                    deleteId = item.id;
                } else {
                    // Simple String Array: Use index for deletion
                    display = item;
                    deleteId = index;
                }

                return `
                    <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                        <span class="text-sm md:text-lg font-bold text-gray-800">${index + 1}. ${display}</span>
                        <button onclick="deleteWordAdmin('${deleteId}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </li>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">âš™ï¸ å–®å­—/è¨­å®šç®¡ç†å¾Œå° (Local Storage Admin Panel)</h2>
                    <p class="text-center text-sm text-pink-100">ğŸ’¡ é€™è£¡çš„å–®å­—åƒ…å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ä¸­ã€‚é¸æ“‡ã€Œæ—¥å¸¸æ´»å‹•/å‹•è©é€£é€£çœ‹ã€ï¼Œç•™ç©º URL å³å¯å•Ÿå‹• AI ç”Ÿæˆåœ–ç‰‡ã€‚</p>
                </section>
                
                <div class="flex flex-wrap justify-center space-x-1 mb-4">
                    ${ADMIN_TABS.map(tab => `
                        <button onclick="setCurrentAdminKey('${tab.key}')" class="tab-btn py-2 px-3 ${currentAdminKey === tab.key ? 'bg-secondary-blue text-blue-900 shadow-lg' : 'bg-gray-100 text-gray-700'}">
                            ${tab.name}
                        </button>
                    `).join('')}
                </div>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <label for="admin-input-1" class="block text-lg font-semibold text-gray-800 mb-2">æ–°å¢ ${currentTab.name} è©å½™</label>
                    <div class="flex space-x-2">
                        ${inputField}
                        <button id="admin-add-button" onclick="addWordAdmin()" 
                                class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150"
                                ${isGeneratingImage ? 'disabled' : ''}>
                            ${addButtonText}
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${currentTab.name} åˆ—è¡¨ (${currentList.length} å€‹)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰è©å½™ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                    <p class="text-xs text-gray-400 mt-4 text-center">æ‚¨çš„è¨­å®šå·²è‡ªå‹•å„²å­˜ã€‚</p>
                </div>
            `;
        }
        
        function setCurrentAdminKey(key) {
            currentAdminKey = key;
            renderWordAdmin();
        }

        function addWordAdmin() {
            if (isGeneratingImage) return;

            const input1 = document.getElementById('admin-input-1')?.value.trim().toUpperCase();
            const input2 = document.getElementById('admin-input-2')?.value.trim().toUpperCase();
            const input3 = document.getElementById('admin-input-3')?.value.trim(); // URL ä¸è½‰æ›å¤§å¯«

            const currentTab = getCurrentAdminTab();

            // --- AI åœ–ç‰‡ç”Ÿæˆé‚è¼¯ ---
            const isImageGame = currentAdminKey === 'g6_routines' || currentAdminKey === 'g7_verbs';
            if (isImageGame && input1 && input2 && !input3) {
                 // æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å¡«å¯«
                 if (!input1 || !input2) {
                     MessageBox.show("è«‹å¡«å¯«è‹±æ–‡ç‰‡èªå’Œä¸­æ–‡/åœ–ç‰‡æ¦‚å¿µæ¬„ä½ä»¥å•Ÿå‹• AI ç”Ÿæˆã€‚", true);
                     return;
                 }
                 // è§¸ç™¼ AI ç”Ÿæˆæµç¨‹
                 generateImageAndAddWord(currentAdminKey, input1, input2);
                 return;
            }
            // --- çµæŸ AI é‚è¼¯ ---

            let newEntry = null;

            // éš¨æ©Ÿç”Ÿæˆä¸€å€‹ HEX é¡è‰²ä½œç‚ºé è¨­åœ–ç‰‡èƒŒæ™¯ï¼Œä»¥å¢åŠ å¤šæ¨£æ€§ (åƒ…ç”¨æ–¼ä½”ä½åœ–)
            const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            let newPlaceholderUrl = input3;
            
            // è™•ç†éœ€è¦åœ–ç‰‡çš„éŠæˆ² (ä½¿ç”¨æ™®é€š Placeholder URL)
            if (isImageGame && !input3) {
                const textForPlaceholder = input1 ? input1.replace(/\s/g, '+') : (input2 ? input2.replace(/\s/g, '+') : 'IMAGE');
                newPlaceholderUrl = `https://placehold.co/150x120/${randomColor}/ffffff?text=${textForPlaceholder}`;
            }
            
            const newId = crypto.randomUUID();

            if (currentAdminKey === 'g2_words') {
                if (input1 && input2) newEntry = { id: newId, phonics: input1, word: input2, hint: input3 || '' };
            } else if (currentAdminKey === 'g8_digraphs') {
                if (input1 && input2 && input3) newEntry = { id: newId, digraph: input1, word: input2, full: input3 };
            } else if (currentAdminKey === 'g6_routines') {
                if (input1 && input2) newEntry = { id: newId, word: input1, image: input2, url: newPlaceholderUrl };
            } else if (currentAdminKey === 'g7_verbs') {
                if (input1 && input2) newEntry = { id: newId, verb: input1, image: input2, url: newPlaceholderUrl };
            } else if (input1) {
                // é€šç”¨å–®å­—æˆ–å¥å­ (String Arrays)
                newEntry = input1;
            }
            
            if (!newEntry) { MessageBox.show("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦çš„æ¬„ä½ï¼", true); return; }

            // æª¢æŸ¥é‡è¤‡ (ç°¡æ˜“æª¢æŸ¥)
            const list = localData[currentAdminKey];
            if (!currentTab.isObjectArray && list.includes(newEntry)) {
                MessageBox.show("è©å½™å·²å­˜åœ¨ï¼", true); return;
            } else if (currentTab.isObjectArray && list.some(item => (item.word || item.verb || item.full) === (newEntry.word || newEntry.verb || newEntry.full))) {
                 MessageBox.show("è©å½™å·²å­˜åœ¨ï¼", true); return;
            }


            localData[currentAdminKey].push(newEntry);
            saveWordsToLocal();
            MessageBox.show(`è©å½™æ–°å¢æˆåŠŸï¼`, false);
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('admin-input-1').value = '';
            if (document.getElementById('admin-input-2')) document.getElementById('admin-input-2').value = '';
            if (document.getElementById('admin-input-3')) document.getElementById('admin-input-3').value = '';
            renderWordAdmin();
        }

        function deleteWordAdmin(id) {
            if (isGeneratingImage) {
                MessageBox.show("åœ–ç‰‡ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true);
                return;
            }
            
            const currentTab = getCurrentAdminTab();
            const list = localData[currentAdminKey];

            if (currentTab.isObjectArray) {
                // Object Array: Filter by ID
                localData[currentAdminKey] = list.filter(item => item.id !== id);
            } else {
                // Simple String Array: Filter by Index
                const indexToDelete = parseInt(id);
                if (!isNaN(indexToDelete) && indexToDelete >= 0 && indexToDelete < list.length) {
                    localData[currentAdminKey].splice(indexToDelete, 1);
                }
            }
            
            saveWordsToLocal();
            MessageBox.show("è©å½™åˆªé™¤æˆåŠŸï¼", false);
            renderWordAdmin();
        }
        // --- Admin Panel End ---
    </script>
</body>
</html>
