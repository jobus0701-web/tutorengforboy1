<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’-1</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* å®šç¾©å¯æ„›çš„å¡é€šå­—é«”ï¼Œä½¿ç”¨ Inter æ­é…åœ“è§’å’Œç²—é«”ç‡Ÿé€ ç«¥è¶£æ„Ÿ */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* æ¸¸æ¨™é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .key-btn {
            height: 50px; /* Base height */
            transition: all 0.1s;
            text-transform: none; /* é è¨­ç‚ºå°å¯«/æ­£å¸¸ */
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        /* ç‰¹åˆ¥é‡å°æŒ‰éˆ•å…ƒç´ ä¸­çš„æ–‡å­—å¼·åˆ¶ä½¿ç”¨å°å¯« (é™¤éç‰¹åˆ¥é‡å¯«) */
        button.key-btn {
            text-transform: lowercase;
        }
        /* è¨ˆç®—æ©ŸæŒ‰éµç¶­æŒåŸæ¨£ */
        .calc-key {
            text-transform: none !important;
        }


        /* Game 2: è¨˜æ†¶å¡ç‰‡ */
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important;
            border-color: #3CB371 !important;
            color: #1E40AF !important;
            cursor: default;
        }
        /* Game 2 é¡è‰²è¦†è“‹ */
        .card-type-phonics {
            background-color: #FFEC99; /* Accent Yellow */
            border-color: #FFD700;
        }
        .card-type-word {
            background-color: #BDE0FE; /* Secondary Blue */
            border-color: #89CFF0;
        }


        /* Game 4: Bingo */
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
            text-transform: lowercase; /* è³“æœå¡ç‰‡é è¨­ç‚ºå°å¯« */
        }
        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        
        /* Game 5: å•å¥é‡çµ„å¤§å¸« */
        .word-block {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            height: 45px;
            padding: 0 10px;
            margin: 5px;
            background-color: #FFC7C7; 
            border: 3px solid #FF8FAB;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 3px 0 0 #D1A3A3;
            text-transform: none; /* è©å¡Šå°‡ç”± JS è™•ç†å¤§å°å¯« */
        }
        
        /* ä¿®æ­£ Game 5 ç­”æ¡ˆå€å¡Šï¼Œç¢ºä¿è©å¡Šé–“éš” (é—œéµä¿®æ­£) */
        .g5-answer-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* å¢åŠ è©å¡Šé–“çš„é–“éš” */
        }
        .answer-slot {
            min-width: 80px;
            height: 50px;
            padding: 5px;
            border: 3px dashed #BDE0FE;
            border-radius: 10px;
            background-color: #F0F8FF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #4A5568;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .answer-slot.incorrect {
            animation: shake 0.3s 2;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* Game 6, 7, 8: é…å°èˆ‡æ‹–æ›³åº•åº§ */
        .image-target {
            min-height: 120px;
            background-color: #fff;
            border: 3px solid #FF8FAB;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .drag-source {
            cursor: grab;
            user-select: none;
            box-shadow: 0 3px 0 0 #D1A3A3;
            transition: transform 0.1s;
        }
        .drag-source:active {
            cursor: grabbing;
            box-shadow: 0 1px 0 0 #D1A3A3;
            transform: translateY(2px);
        }
        .drag-area {
            border: 3px dashed #BDE0FE;
            border-radius: 12px;
            min-height: 150px;
            padding: 10px;
        }
        
        /* Game 8 å°ˆç”¨æ¨£å¼ */
        .digraph-display-box {
            min-width: 150px;
            min-height: 100px;
            background-color: #f0f0f0;
            border: 5px solid #FF8FAB;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .digraph-letter-part {
            font-size: 4rem;
            font-weight: 900;
            color: #1E40AF; /* æ·±è—è‰² */
        }
        .digraph-blank {
            width: 80px;
            height: 80px;
            background-color: #FFEC99;
            border: 4px dashed #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #D1A3A3;
        }
        /* Game 7 Calculator Styles */
        .calc-display {
            background-color: #2c3e50; /* æ·±è—ç°è‰² */
            color: #ffffff;
            text-align: right;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            font-size: 3rem;
            font-weight: 700;
            font-family: monospace;
            overflow-x: auto;
            white-space: nowrap;
        }
        .calc-key {
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            transition: all 0.1s;
        }
        .calc-key-number {
            background-color: #ecf0f1; /* æ·ºç°è‰² */
            color: #2c3e50;
        }
        .calc-key-operator {
            background-color: #f39c12; /* æ©˜è‰² */
            color: white;
        }
        .calc-key-clear {
            background-color: #e74c3c; /* ç´…è‰² */
            color: white;
        }
        .calc-key-equal {
            background-color: #2ecc71; /* ç¶ è‰² */
            color: white;
        }
        /* Game 6 ç‰©å“åç¨±å’Œ Game 7 æç¤ºæ¬„å¼·åˆ¶å°å¯« */
        .item-name-display {
            text-transform: lowercase;
        }

    </style>

    <script>
        // è¨­å®š Tailwind é…ç½®, ä½¿ç”¨æŸ”å’Œå¯æ„›çš„é¦¬å¡é¾é…è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      
                        'secondary-blue': '#BDE0FE',    
                        'accent-yellow': '#FFEC99',     
                        'background-light': '#F8F8F8',  
                        'keyboard-bg': '#FFF5D6',       
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    
                        'key-active': '0 2px 0 0 #D1A3A3', 
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡å°èˆª -->
    <header class="w-full max-w-6xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- å¯æ„›å°è±¬åœ–ç¤º (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.1716 9 9 9Z" fill="#FF8FAB"/><path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/><circle cx="11" cy="13" r="1" fill="#FF8FAB"/><circle cx="13" cy="13" r="1" fill="#FF8FAB"/></svg>
            è‹±æ–‡å­¸ç¿’éŠæˆ²æ¨‚åœ’-1
        </h1>
    </header>

    <!-- å°èˆªåˆ— -->
    <nav class="w-full max-w-6xl mb-6">
        <div class="grid grid-cols-4 gap-2 md:gap-4 justify-center" id="game-nav">
            
            <button data-game="game2" class="tab-btn">ğŸ¶ é…å°</button>
            <button data-game="game3" class="tab-btn">ğŸ–ï¸ Hangman</button>
            <button data-game="game4" class="tab-btn">ğŸ¤ è³“æœ</button>
            <button data-game="game5" class="tab-btn">ğŸ’¬ å•å¥</button>
            
            <button data-game="game6" class="tab-btn">ğŸ¤¸ æ—¥å¸¸</button>
            <button data-game="game7" class="tab-btn">ğŸ’° èŠ±è²»è¨ˆç®—æ©Ÿ</button>
            <button data-game="game8" class="tab-btn">ğŸ’¥ ç™¼éŸ³æ©Ÿ</button>
            <button data-game="admin" class="tab-btn">âš™ï¸ å¾Œå°</button>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="game-content" class="w-full max-w-6xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[600px]">
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼...</p>
        </div>
    </main>
    
    <script>
        // --- å…¨åŸŸè¨­å®šèˆ‡å·¥å…· ---
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split('');
        const LOCAL_STORAGE_KEY = 'GAMES_CUSTOM_DATA_V2';
        const G4_BINGO_SIZE = 4;

        let currentGame = 'game2'; // æ›´æ”¹é è¨­éŠæˆ²ç‚º game2
        let localData = {}; // å­˜æ”¾æ‰€æœ‰éŠæˆ²çš„è‡ªè¨‚æ•¸æ“š
        let isGeneratingImage = false; // AI åœ–ç‰‡ç”Ÿæˆç‹€æ…‹æ——æ¨™
        
        // Hangman Emoji æç¤ºåº«
        const G3_EMOJI_HINTS = {
            'PUPPET': 'ğŸ', 'SKATEBOARD': 'ğŸ›¹', 'HISTORY': 'ğŸ›ï¸', 'HARD': 'ğŸ’ª', 'EASY': 'ğŸ˜Œ', 
            'DOLLAR': 'ğŸ’µ', 'HAND': 'ğŸ–ï¸', 'FOOT': 'ğŸ¦¶', 'SCIENCE': 'ğŸ”¬', 'MATHS': 'â•'
        };

        // æ–°å¢ï¼šå¸¸ç”¨å‹•è©å’Œæ—¥å¸¸æ´»å‹•çš„ Emoji æ˜ å°„è¡¨
        const ACTION_EMOJI_MAP = {
            // åŸºç¤å‹•è© (æ–°å¢)
            'RUN': 'ğŸƒ', 'TALK': 'ğŸ—£ï¸', 'REST': 'ğŸ›Œ', 'EAT': 'ğŸ”', 'LISTEN': 'ğŸ§', 
            'PAINT': 'ğŸ¨', 'JUMP': 'ğŸ¤¸', 'WALK': 'ğŸš¶', 'JOG': 'ğŸƒ', 'SKIP': 'ç¸„',

            // ç‰‡èªé—œéµå­—
            'WASH': 'ğŸš¿', 'FACE': 'ğŸ™‚', 'TEETH': 'ğŸ¦·', 'BRUSH': 'ğŸ–Œï¸', 'HAIR': 'ğŸ’‡', 
            'DO': 'âœ…', 'HOMEWORK': 'ğŸ“š', 'PLAY': 'ğŸ®', 'PHONE': 'ğŸ“±', 'IS': 'ğŸ‘‰', 
            
            // äººç¨±ä»£è©
            'I': 'ğŸ™‹', 'YOU': 'ğŸ‘¤', 'HE': 'ğŸ‘¦', 'SHE': 'ğŸ‘§', 'IT': 'ğŸ¶', 'WE': 'ğŸ‘¥', 'THEY': 'ğŸ‘«' 
        };
        
        // Present Continuous ä¸»è©-Beå‹•è©çµ„åˆ
        const G7_SUBJECT_FORMS = [
            'I AM', 'YOU ARE', 'HE IS', 'SHE IS', 'IT IS', 'WE ARE', 'THEY ARE'
        ];


        // é è¨­å–®å­—åº« (Phonics 2, STEP 3 è©å½™)
        const DEFAULT_WORDS = {
            // Game 2: ğŸ¶ Phonics ç™¼éŸ³é…å°
            g2_words: [
                { id: crypto.randomUUID(), phonics: 'A-E', word: 'CAKE', hint: 'ç”Ÿæ—¥è›‹ç³•' },
                { id: crypto.randomUUID(), phonics: 'IE', word: 'PIE', hint: 'ç¾å‘³çš„æ´¾' },
                { id: crypto.randomUUID(), phonics: 'OO', word: 'FOOD', hint: 'å¥½åƒçš„é£Ÿç‰©' },
                { id: crypto.randomUUID(), phonics: 'EW', word: 'NEW', hint: 'æ–°çš„' },
                { id: crypto.randomUUID(), phonics: 'OA', word: 'BOAT', hint: 'ä¸€è‰˜èˆ¹' },
                { id: crypto.randomUUID(), phonics: 'EE', word: 'BEE', hint: 'å°èœœèœ‚' },
            ],
            // Game 3: ğŸ–ï¸ Hangman çŒœå–®å­—
            g3_words: ['PUPPET', 'SKATEBOARD', 'HISTORY', 'HARD', 'EASY', 'DOLLAR', 'HAND', 'FOOT'],
            // Game 4: ğŸ¤ é›™äººè³“æœ
            g4_bingo_words: ['SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY', 'HUNDRED', 'THOUSAND', 'DOLLAR', 'HOSPITAL', 'PARK', 'BANK', 'COAT', 'JEANS', 'GLOVES', 'HAT', 'SCARF', 'TIE'],
            // Game 5: ğŸ’¬ å•å¥é‡çµ„å¤§å¸«
            g5_sentences: [
                "What does he do after school?",
                "When does she have English?",
                "How much is the skateboard?",
                "How many legs does it have?",
                "Is the yellow one longer?",
                "I'm going to the airport."
            ],
            // Game 6: ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Word: Image_Concept) - ä½¿ç”¨éš¨æ©Ÿ Emoji å’Œ Placeholder URL
            g6_routines: [
                { id: crypto.randomUUID(), word: 'WASH HIS FACE', emoji: 'ğŸš¿ğŸ™‚', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=WASH%20FACE' },
                { id: crypto.randomUUID(), word: 'DO HER HOMEWORK', emoji: 'ğŸ‘§ğŸ“š', url: 'https://placehold.co/150x120/ff8a65/000000?text=DO%20HOMEWORK' },
                { id: crypto.randomUUID(), word: 'BRUSH HIS TEETH', emoji: 'ğŸ‘¦ğŸ¦·', url: 'https://placehold.co/150x120/9ccc65/000000?text=BRUSH%20TEETH' },
                { id: crypto.randomUUID(), word: 'PLAY ON HIS PHONE', emoji: 'ğŸ®ğŸ“±', url: 'https://placehold.co/150x120/ab47bc/ffffff?text=PLAY%20PHONE' },
            ],
            // Game 7: ğŸƒ å‹•è©é€£é€£çœ‹ (Verb: Full Sentence, e.g. I AM JUMPING) - æ•¸æ“šå·²ç„¡ç”¨ï¼Œä½†ä¿ç•™çµæ§‹
            g7_verbs: [
                { id: crypto.randomUUID(), fullSentence: 'I AM JUMPING', emoji: 'ğŸ™‹ğŸ¤¸', url: 'https://placehold.co/150x120/5c6bc0/ffffff?text=JUMPING' },
                { id: crypto.randomUUID(), fullSentence: 'HE IS PAINTING', emoji: 'ğŸ‘¦ğŸ¨', url: 'https://placehold.co/150x120/ef5350/ffffff?text=PAINTING' },
                { id: crypto.randomUUID(), fullSentence: 'THEY ARE TALKING', emoji: 'ğŸ‘«ğŸ—£ï¸', url: 'https://placehold.co/150x120/4db6ac/000000?text=TALKING' },
                { id: crypto.randomUUID(), fullSentence: 'WE ARE EATING', emoji: 'ğŸ‘¥ğŸ”', url: 'https://placehold.co/150x120/f9a825/000000?text=EATING' },
            ],
            // Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph: Word_Template)
            g8_digraphs: [
                { id: crypto.randomUUID(), digraph: 'SH', word: '_OP', full: 'SHOP' },
                { id: crypto.randomUUID(), digraph: 'CH', word: '_AT', full: 'CHAT' },
                { id: crypto.randomUUID(), digraph: 'TH', word: '_INK', full: 'THINK' },
                { id: crypto.randomUUID(), digraph: 'WH', word: '_ALE', full: 'WHALE' },
                { id: crypto.randomUUID(), digraph: 'PH', word: 'ELE_ANT', full: 'ELEPHANT' },
            ],
        };

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ï¼šEmoji ç”Ÿæˆé‚è¼¯ ---

        function generateEmojiFromWord(wordPhrase) {
            // é€™æ˜¯ä½¿ç”¨ç´” JavaScript æ¨¡æ“¬çš„ã€Œæ™ºæ…§ã€Emoji æå–å’Œçµ„åˆ
            const tokens = wordPhrase.split(/\s+/).map(t => t.replace(/[^A-Z]/g, ''));
            let generatedEmoji = '';

            tokens.forEach(token => {
                let found = false;
                // å„ªå…ˆåŒ¹é…å®Œæ•´çš„è©å½™
                if (ACTION_EMOJI_MAP[token]) {
                    generatedEmoji += ACTION_EMOJI_MAP[token];
                    found = true;
                }
                
                // å˜—è©¦åŒ¹é…æ ¸å¿ƒå‹•è© (ç§»é™¤ ING)
                if (!found && token.endsWith('ING')) {
                    const baseVerb = token.slice(0, -3);
                    if (ACTION_EMOJI_MAP[baseVerb]) {
                        generatedEmoji += ACTION_EMOJI_MAP[baseVerb];
                        found = true;
                    }
                }

                // å˜—è©¦åŒ¹é…è©å½™ä¸­çš„é—œéµå­— (å¦‚ FACE, HAIR)
                for (const key in ACTION_EMOJI_MAP) {
                    if (token.includes(key) && key.length > 2 && !generatedEmoji.includes(ACTION_EMOJI_MAP[key])) {
                        generatedEmoji += ACTION_EMOJI_MAP[key];
                        found = true;
                    }
                }
            });

            // å¦‚æœæ²’æ‰¾åˆ°ä»»ä½• Emojiï¼Œå‰‡ä½¿ç”¨ä¸€å€‹éš¨æ©ŸEmojiä½œç‚ºå‚™ç”¨
            if (generatedEmoji.length === 0) {
                const randomEmojis = ['ğŸŒŸ', 'ğŸ’¡', 'âœ…', 'ğŸŒˆ'];
                generatedEmoji = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            }
            
            return generatedEmoji.trim();
        }
        
        // --- å¥å¼å¤§å°å¯«æ ¼å¼åŒ–å·¥å…· (ä¿®æ­£å¾Œç‰ˆæœ¬) ---
        function formatDisplayWord(word, isSentenceStart = false) {
            if (typeof word !== 'string') return word;
            if (word.length === 0) return word;

            // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦ä¿æŒåŸæ¨£å¤§å¯« (Caps Lock å¼·èª¿)
            const hasUpperCase = /[A-Z]/.test(word);
            
            if (hasUpperCase) {
                // å¦‚æœåŸå§‹å–®è©åŒ…å«å¤§å¯«ï¼ˆç„¡è«–æ˜¯ä¸æ˜¯å…¨å¤§å¯«ï¼‰ï¼Œå‰‡ä¿æŒåŸå§‹è¼¸å…¥
                return word;
            }
            
            // 2. ç‰¹æ®Šå–®å­—æª¢æŸ¥ (I æ°¸é å¤§å¯«)
            if (word.toUpperCase() === 'I') {
                return 'I';
            }
            
            // 3. å¥é¦–æª¢æŸ¥ (åƒ…ç•¶å®ƒä¸æ˜¯å¥é¦–çš„æ¨™é»ç¬¦è™Ÿæ™‚)
            if (isSentenceStart && word.match(/^[a-z]/i)) {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }

            // 4. é è¨­è½‰æ›ç‚ºå…¨å°å¯«
            return word.toLowerCase();
        }
        
        // --- æå–å‹•è©é€²è¡Œå¼ (æ–°çš„è¼”åŠ©å‡½æ•¸) ---
        function extractVerbParticiple(fullSentence) {
            const parts = fullSentence.split(' ').map(p => p.trim());
            if (parts.length > 0 && parts[parts.length - 1].endsWith('ING')) {
                return parts[parts.length - 1]; // è¿”å›å¥å­çš„æœ€å¾Œä¸€å€‹è©ï¼Œå‡è¨­æ˜¯å‹•è© ing å½¢å¼
            }
            return null;
        }

        // --- æ•¸å­—è½‰è‹±æ–‡å–®å­—åŠŸèƒ½ (Game 7 æ ¸å¿ƒ) ---
        const ONES = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
        const TEENS = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
        const TENS = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
        
        function numberToWords(num) {
            if (num < 0 || num > 999999) return "NUMBER OUT OF RANGE";
            if (num === 0) return "ZERO";

            function convertLessThanThousand(n) {
                let s = '';
                if (n >= 100) {
                    s += ONES[Math.floor(n / 100)] + ' HUNDRED';
                    n %= 100;
                    if (n > 0) s += ' '; // ç°¡åŒ–ï¼Œç”¨ç©ºæ ¼é€£æ¥
                }
                if (n >= 10 && n <= 19) {
                    s += TEENS[n - 10];
                } else if (n >= 20) {
                    s += TENS[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) s += '-';
                }
                if (n > 0 && n < 10) {
                    s += ONES[n];
                }
                return s.trim().replace(/\s+/g, ' '); // ç§»é™¤å¤šé¤˜ç©ºæ ¼
            }

            // ç”±æ–¼ç›®æ¨™æ˜¯ç™¾ä½æ•¸ (æœ€å¤§ 999)ï¼Œæˆ‘å€‘åªç”¨é€™å€‹å‡½æ•¸å³å¯
            return convertLessThanThousand(num).replace('AND', ''); // ç§»é™¤ 'AND'
        }
        
        // éš¨æ©Ÿç‰©å“å’Œåƒ¹æ ¼åˆ—è¡¨ (åŸºæ–¼ STEP 3 æ•™æ)
        const SHOP_ITEMS = [
            { name: "SKATEBOARD", emoji: "ğŸ›¹", maxPrice: 200 }, // å–®å“é‡‘é¡ä¸è¶…é 200
            { name: "PUPPET", emoji: "ğŸ§¸", maxPrice: 200 },
            { name: "ACTION FIGURE", emoji: "ğŸ¦¸", maxPrice: 200 },
            { name: "MODEL PLANE", emoji: "âœˆï¸", maxPrice: 200 },
            { name: "BARBIE DOLL", emoji: "ğŸ‘¸", maxPrice: 200 },
            { name: "BACKPACK", emoji: "ğŸ’", maxPrice: 200 },
        ];


        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        let state = {
            // G2
            g2_matchCards: [], g2_flippedCards: [], g2_matchCount: 0, g2_gameStatus: 'ready',
            // G3
            g3_currentGuessWord: '', g3_guessedLetters: new Set(), g3_wrongGuesses: 0, g3_gameStatus: 'ready', g3_MAX_WRONG: 6, g3_emojiHint: '', 
            // G4
            g4_players: [], g4_calledWords: new Set(), g4_lastCalledWord: '', g4_gameStatus: 'ready', g4_isCalling: false,
            // G5
            g5_currentSentence: '', g5_answerWords: [], g5_scrambleBlocks: [], g5_currentSort: [], g5_gameStatus: 'ready',
            // G6
            g6_targets: [], g6_sources: [], g6_matches: 0,
            // G7 (Cost Calculator)
            g7_items: [],
            g7_totalCost: 0,
            g7_displayValue: '', // ç”¨æ–¼é¡Œç›®ç­”æ¡ˆè¼¸å…¥
            g7_calculator: { // æ¨¡æ“¬è¨ˆç®—æ©Ÿçš„å…§éƒ¨ç‹€æ…‹
                currentValue: '0',
                memory: 0,
                operator: null,
                resetDisplay: true,
                calcDisplay: '0'
            },
            g7_gameStatus: 'ready',
            // G8
            g8_currentWord: null, g8_gameStatus: 'ready', g8_score: 0,
        };

        // --- TTS & Utility ---

        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                console.warn("SpeechSynthesis not supported.");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => { console.error("SpeechSynthesis error:", e); resolve(); };
                window.speechSynthesis.speak(utterance);
            });
        }

        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        // --- LocalStorage å­˜å„²åŠŸèƒ½ (çµ±ä¸€ç®¡ç†æ‰€æœ‰éŠæˆ²æ•¸æ“š) ---

        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loaded = stored ? JSON.parse(stored) : {};
                
                // 1. åˆå§‹åŒ– localData ç‚º DEFAULT_WORDS çš„æ·±æ‹·è²ï¼ˆç¢ºä¿ ID ç¨ç«‹ï¼‰
                localData = JSON.parse(JSON.stringify(DEFAULT_WORDS));
                
                for (const key in loaded) {
                    if (Array.isArray(loaded[key])) {
                        localData[key] = loaded[key].map(item => {
                            // 2. ç¢ºä¿è¼‰å…¥çš„ç‰©ä»¶æœ‰ IDï¼Œå¦‚æœæ²’æœ‰ï¼Œè³¦äºˆä¸€å€‹æ–°çš„ ID
                            if (typeof item === 'object' && item !== null && !item.id) {
                                return { ...item, id: crypto.randomUUID() };
                            }
                            return item;
                        }).filter(item => item !== null && item !== undefined); 
                    }
                }
            } catch (e) {
                console.error("Error loading words from local storage:", e);
                // å¦‚æœå‡ºéŒ¯ï¼Œè‡³å°‘ä½¿ç”¨é è¨­å€¼
                localData = DEFAULT_WORDS;
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("ç„¡æ³•ä¿å­˜å–®å­—åˆ°æ‚¨çš„ç€è¦½å™¨ã€‚", true);
            }
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æ§åˆ¶ ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.querySelector(`.tab-btn[data-game="${gameName}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            loadWordsFromLocal(); // æ¯æ¬¡æ¸²æŸ“å‰è¼‰å…¥

            switch (currentGame) {
                
                case 'game2': initGame2(); break;
                case 'game3': initGame3(); break;
                case 'game4': initGame4(); break;
                case 'game5': initGame5(); break;
                case 'game6': initGame6(); break;
                case 'game7': initGame7(); break; // ä¿®æ”¹ç‚ºå‘¼å« initGame7
                case 'game8': initGame8(); break;
                case 'admin': renderWordAdmin(); break;
                default: document.getElementById('game-content').innerHTML = `<p class="text-xl text-gray-500 text-center p-10">è«‹é¸æ“‡ä¸€å€‹éŠæˆ²</p>`;
            }
        }

        window.onload = function() {
            // æ›¿æ›å°èˆªæŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('bg-white', 'hover:bg-secondary-blue', 'py-2', 'px-3', 'md:px-4', 'rounded-full', 'text-xs', 'md:text-sm', 'font-bold', 'text-gray-700', 'transition', 'duration-300', 'shadow-md');
                
                // ä¿®æ­£: å°‡é»æ“Šäº‹ä»¶å¾ onclick ç§»è‡³ addEventListener
                const gameName = btn.getAttribute('data-game');
                if (gameName) {
                    btn.addEventListener('click', () => changeGame(gameName));
                }
            });

            setTabActive(currentGame);
            renderApp();
        }

        // --- Game 2: ğŸ¶ Phonics ç™¼éŸ³é…å° (Vowel Sound Match) ---
        // ç§»é™¤ G2_COLORSï¼Œæ”¹ç”¨ CSS é¡åˆ¥ card-type-phonics / card-type-word

        function initGame2() {
            const source = localData.g2_words;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ Phonics é…å°å–®å­—ï¼", true); return; }

            // 1. é™åˆ¶å¡ç‰‡å°æ•¸ç‚º 4 çµ„ (8 å¼µå¡ç‰‡)
            const limitedSource = shuffleArray(source).slice(0, 4);

            state.g2_matchCount = 0;
            state.g2_flippedCards = [];
            state.g2_gameStatus = 'playing';

            let cardValues = [];
            limitedSource.forEach((item, index) => {
                const groupId = `match-${item.phonics}-${index}`;

                // Phonics å¡ç‰‡ (é»ƒ/æ©˜è‰²èª¿)
                cardValues.push({ id: crypto.randomUUID(), type: 'PHONICS', value: item.phonics, groupId, matched: false, flipped: false, hint: item.hint });
                // Word å¡ç‰‡ (è—/ç²‰è‰²èª¿)
                cardValues.push({ id: crypto.randomUUID(), type: 'WORD', value: item.word, groupId, matched: false, flipped: false, hint: item.hint });
            });

            state.g2_matchCards = shuffleArray(cardValues);
            renderGame2();
        }

        async function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card || card.matched || card.flipped || state.g2_flippedCards.length === 2) return;

            card.flipped = true;
            state.g2_flippedCards.push(card);
            
            // é»æ“Šå¡ç‰‡æ™‚ï¼Œä¸åŸ·è¡Œ callTTS(card.type === 'PHONICS' ? card.phonics : card.value);

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                if (card1.groupId === card2.groupId) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    state.g2_flippedCards = [];
                    renderGame2();
                    if (state.g2_matchCount === state.g2_matchCards.length / 2) {
                        setTimeout(() => MessageBox.show("å¤ªæ£’äº†ï¼æ‰€æœ‰ç™¼éŸ³é…å°æˆåŠŸï¼ğŸ‰", false), 500);
                        state.g2_gameStatus = 'won';
                    }
                } else {
                    setTimeout(() => {
                        state.g2_matchCards.forEach(c => {
                            if (c.id === card1.id || c.id === card2.id) c.flipped = false;
                        });
                        state.g2_flippedCards = [];
                        renderGame2();
                    }, 1000);
                }
            }
            renderGame2();
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-lg md:text-2xl font-extrabold text-gray-800`;
                let openCardColorClass = card.type === 'PHONICS' ? 'card-type-phonics' : 'card-type-word';
                let hiddenCardContent = card.type === 'PHONICS' ? 'phonics' : 'word'; // ä¿æŒå°å¯«


                if (card.matched) {
                    cardClasses += ` matched-success`;
                    content = `${formatDisplayWord(card.phonics)} / ${formatDisplayWord(card.value)}`; // è¼¸å‡ºæ ¼å¼åŒ–
                } else if (card.flipped) {
                    cardClasses += ` ${openCardColorClass} border-gray-500`;
                    content = card.type === 'PHONICS' ? `[${formatDisplayWord(card.value)}]` : formatDisplayWord(card.value); // è¼¸å‡ºæ ¼å¼åŒ–
                } else {
                    cardClasses += ` bg-primary-pink border-pink-400`; // ç‰Œé¢æœä¸‹æ™‚ä½¿ç”¨ä¸»é¡Œç²‰è‰²
                    content = hiddenCardContent; // é¡¯ç¤ºå¡ç‰‡é¡å‹
                    innerTextClass = `text-base md:text-xl font-bold text-gray-800`; // ç¸®å°æ–‡å­—ä»¥é©æ‡‰ PHONICS/WORD æ¨™ç±¤
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" data-card-id="${card.id}">
                        <div class="${cardClasses}">
                            <div class="text-center">
                                <span class="${innerTextClass}">
                                    ${content}
                                </span>
                                ${card.flipped && card.type === 'WORD' ? `<p class="text-xs text-gray-600 mt-1">(${card.hint})</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶
            setTimeout(() => {
                document.querySelectorAll('#match-game-grid [data-card-id]').forEach(elem => {
                    elem.addEventListener('click', () => handleCardClickG2(elem.dataset.cardId));
                });
            }, 0);

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">ğŸ¶ phonics ç™¼éŸ³é…å° (vowel sound match)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šå¡ç‰‡ï¼Œé…å°ç›¸åŒçš„é•·æ¯éŸ³çµ„åˆå’Œå°æ‡‰çš„å–®å­—ã€‚å·²å®Œæˆ ${state.g2_matchCount}/${state.g2_matchCards.length / 2} çµ„ã€‚</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-2xl mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_matchCount === state.g2_matchCards.length / 2 ? 'å†ç©ä¸€æ¬¡' : 'é‡æ–°é–‹å§‹'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- Game 2 End ---

        // --- Game 3: ğŸ–ï¸ Hangman çŒœå–®å­— (Hangman) ---
        function getHangmanSVG(wrongGuesses, status) {
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            const fillStyle = `fill="none" stroke="${color}" stroke-width="6"`;
            const base = 180; // èª¿æ•´åœ°åŸºé«˜åº¦

            // 1. Base (åœ°åŸº)
            parts.push(`<line x1="50" y1="${base}" x2="150" y2="${base}" ${fillStyle}/>`); 
            // 2. Upright (ç«‹æŸ±)
            parts.push(`<line x1="100" y1="${base}" x2="100" y2="20" ${fillStyle}/>`); 
            // 3. Crossbar (æ©«æ¨‘)
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" ${fillStyle}/>`); 
            // 4. Rope/Gallows (ç¹©å­/åŠç¹©)
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 

            // 5. Brace (æ”¯æ’æ–œç·š) - è®“æ¡¿å­çœ‹èµ·ä¾†æ›´ç©©å›º
            parts.push(`<line x1="100" y1="60" x2="160" y2="20" ${fillStyle} stroke-width="4"/>`); 

            // Character Drawing (6 parts for the body)
            
            // 1. Head
            if (wrongGuesses >= 1) {
                parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            }

            // 2. Body
            if (wrongGuesses >= 2) {
                parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            }

            // 3. Left Arm
            if (wrongGuesses >= 3) {
                parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            }

            // 4. Right Arm
            if (wrongGuesses >= 4) {
                parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            }

            // 5. Left Leg
            if (wrongGuesses >= 5) {
                parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            }

            // 6. Right Leg (Game Over)
            if (wrongGuesses >= 6) {
                parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            }
            
            return `<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">${parts.join('')}</svg>`;
        }

        function getEmojiHint(word) {
            // å˜—è©¦ç²¾ç¢ºåŒ¹é…ï¼Œå¦å‰‡è¿”å›ä¸€å€‹å•è™Ÿ
            return G3_EMOJI_HINTS[word] || 'â“';
        }

        function initGame3() {
            const source = localData.g3_words;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ hangman å–®å­—ï¼", true); return; }

            const randomWord = source[Math.floor(Math.random() * source.length)];
            state.g3_currentGuessWord = randomWord.toUpperCase(); 
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            state.g3_emojiHint = getEmojiHint(state.g3_currentGuessWord);
            renderGame3(); 
        }

        function guessLetterG3(letter) {
            const upperCaseLetter = letter.toUpperCase();
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(upperCaseLetter)) return;
            
            state.g3_guessedLetters.add(upperCaseLetter);
            if (!state.g3_currentGuessWord.includes(upperCaseLetter)) state.g3_wrongGuesses++;
            checkWinConditionG3();
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                MessageBox.show(`æ­å–œæ‚¨ï¼å–®å­—æ˜¯ ${state.g3_currentGuessWord.toLowerCase()}ï¼ğŸ‰`, false);
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`å¾ˆå¯æƒœã€‚æ­£ç¢ºå–®å­—æ˜¯ ${state.g3_currentGuessWord.toLowerCase()}ã€‚ğŸ˜­`, true);
            }
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;
            
            // æ‡‰ç”¨æ ¼å¼åŒ–ï¼šå–®å­—ä¿æŒå¾Œå°å„²å­˜çš„å¤§å°å¯«ï¼ˆä½†å› ç‚ºæ˜¯ Hangmanï¼Œé€šå¸¸æœƒæ˜¯å…¨å¤§å¯«ï¼‰
            const formattedWord = state.g3_currentGuessWord;

            const displayWord = formattedWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost';
                if (state.g3_guessedLetters.has(char) || isGameOver) {
                    return formatDisplayWord(char); 
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                const upperCaseLetter = letter.toUpperCase();
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(upperCaseLetter)) {
                    btnClass = state.g3_currentGuessWord.includes(upperCaseLetter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }
                if (state.g3_gameStatus !== 'playing') { btnClass = 'bg-gray-300 cursor-not-allowed'; onClick = ''; }

                return `<button onclick="${onClick}" class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-2xl font-extrabold rounded-xl transition duration-150 text-gray-800">${letter}</button>`;
            }).join('');

            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ–ï¸ hangman çŒœå–®å­— (word guess)</h2>
                </section>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">ğŸ’” éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">${hangmanDrawing}</div>
                        <p class="text-4xl mt-2 text-center">æç¤º: ${state.g3_emojiHint}</p>
                    </div>
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">çŒœæ¸¬å–®å­—:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">${displayWord}</div>
                        <div class="grid grid-cols-7 gap-1 md:gap-2">${alphabetBtns}</div>
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? 'é‡è¨­éŠæˆ²' : 'é–‹å§‹æ–°éŠæˆ²'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- Game 3 End ---

        // --- Game 4: ğŸ¤ é›™äººè³“æœ (Bingo) ---
        function generateBingoCardG4() {
            const source = localData.g4_bingo_words;
            if (source.length < G4_BINGO_SIZE * G4_BINGO_SIZE) {
                MessageBox.show(`è³“æœå–®å­—åº«ä¸è¶³ ${G4_BINGO_SIZE * G4_BINGO_SIZE} å€‹ï¼`, true);
                return Array(G4_BINGO_SIZE * G4_BINGO_SIZE).fill('ERROR');
            }
            return shuffleArray(source).slice(0, G4_BINGO_SIZE * G4_BINGO_SIZE);
        }

        function checkWinG4(player) {
            let lines = 0;
            const size = G4_BINGO_SIZE;
            const card = player.card;
            const marked = player.marked;

            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    if (marked.has(card[i * size + j])) rowCount++;
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }
            let diag1Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + i])) diag1Count++; }
            if (diag1Count === size) lines++;

            let diag2Count = 0;
            for (let i = 0; i < size; i++) { if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++; }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            return lines >= 2;
        }

        function initGame4() {
            state.g4_players = [
                { id: 1, name: 'ç©å®¶ 1', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
                { id: 2, name: 'ç©å®¶ 2', card: generateBingoCardG4(), marked: new Set(), winner: false, score: 0 },
            ];
            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_gameStatus = 'ready';
            state.g4_isCalling = false;
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') { initGame4(); return; }
            if (state.g4_isCalling) return;
            
            const availableWords = shuffleArray(localData.g4_bingo_words.filter(w => !state.g4_calledWords.has(w)));
            if (availableWords.length === 0) { MessageBox.show("å–®å­—åº«å·²æŠ½å®Œï¼", true); return; }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord;
            state.g4_calledWords.add(nextWord);
            
            state.g4_isCalling = true;
            state.g4_gameStatus = 'calling';
            renderGame4(); 
            
            await callTTS(nextWord); // æ¢å¾© Game 4 è²éŸ³
            
            state.g4_isCalling = false; 

            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`è³“æœï¼ç©å®¶ ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' å’Œ ')} ç²å‹ï¼`, false);
            } else {
                renderGame4();
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index];

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) player.marked.delete(word);
                else player.marked.add(word);

                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished';
                    MessageBox.show(`è³“æœï¼ç©å®¶ ${playerId} ç²å‹ï¼`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`å–®å­— ${word.toLowerCase()} å°šæœªè¢«å”¸å‡ºï¼`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `<div class="bingo-cell ${isMarked ? 'marked' : 'hover:bg-yellow-300'}" data-player-id="${player.id}" data-index="${index}">${formatDisplayWord(word)}</div>`;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">${player.name} ${player.winner ? 'ğŸ‰ winner ğŸ‰' : ''} (ç·šæ•¸: ${player.score})</h3>
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${G4_BINGO_SIZE}, 1fr); grid-template-rows: repeat(${G4_BINGO_SIZE}, 1fr); max-w-full md:max-w-[300px];" id="bingo-grid-${player.id}">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };
            
            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">${state.g4_gameStatus === 'ready' ? 'æº–å‚™é–‹å§‹' : state.g4_gameStatus === 'calling' ? 'éŠæˆ²ä¸­' : 'éŠæˆ²çµæŸ'}</h3>
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <p class="text-4xl font-black text-red-700 transition duration-300 item-name-display">
                            ${state.g4_lastCalledWord ? `å–®å­—: ${formatDisplayWord(state.g4_lastCalledWord)}` : state.g4_gameStatus === 'ready' ? 'é»æ“Šé–‹å§‹æŒ‰éˆ•' : 'ç­‰å¾…ä¸‹ä¸€è¼ª...'}
                        </p>
                    </div>
                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? 'ğŸ”Š é–‹å§‹éŠæˆ² / æŠ½å–å–®å­—' : state.g4_gameStatus === 'calling' ? (state.g4_isCalling ? 'ğŸ™ï¸ æ’­å ±ä¸­...' : 'ğŸ”Š æŠ½å–ä¸‹ä¸€å€‹å–®å­—') : 'ğŸ”„ é‡æ–°é–‹å§‹'}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">å·²æŠ½å‡º ${state.g4_calledWords.size} å€‹å–®å­— / å‰©é¤˜ ${localData.g4_bingo_words.length - state.g4_calledWords.size} å€‹</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ¤ é›™äººè‹±æ–‡è³“æœ (two-player bingo)</h2>
                    <p class="text-center text-sm text-blue-900 mb-6">ç›®æ¨™: è½å–å–®å­—ï¼Œä¸¦åœ¨æ‚¨çš„ 4x4 è³“æœå¡ä¸Šæ¨™è¨˜ã€‚æœ€å…ˆå®Œæˆå…©æ¢ç·šç²å‹ï¼</p>
                    ${controlArea}
                    <div class="flex flex-col md:flex-row gap-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                </section>
            `;
             // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
            setTimeout(() => {
                document.querySelectorAll('.bingo-cell').forEach(cell => {
                    const playerId = parseInt(cell.dataset.playerId);
                    const index = parseInt(cell.dataset.index);
                    cell.addEventListener('click', () => handleCardClickG4(playerId, index));
                });
            }, 0);
        }
        // --- Game 4 End ---

        // --- Game 5: ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (Sentence Scramble Master) ---
        function getSentenceTokens(sentence) {
            // é€™å€‹æ­£å‰‡è¡¨é”å¼æœƒå°‡å–®å­—ã€ç¸®å¯« (e.g., 's) å’Œæ¨™é»ç¬¦è™Ÿåˆ†é›¢ç‚ºç¨ç«‹è©å¡Š
            return sentence.match(/\b\w+'?\w*\b|[.,?!]/g) || [];
        }

        function capitalizeSentence(word) {
            if (word === 'I') return 'I';
            // å°‡ I, He, She, They, We, You, It çš„é¦–å­—æ¯å¤§å¯«
            const personalPronouns = ["I", "HE", "SHE", "YOU", "WE", "THEY", "IT"];
            
            if (personalPronouns.includes(word)) {
                 if (word === 'I') return 'I'; // ç¢ºä¿ I ä¿æŒå¤§å¯«
                 return word.charAt(0) + word.slice(1).toLowerCase();
            }

            // å¥é¦–å–®å­—ï¼šé¦–å­—æ¯å¤§å¯«ï¼Œå…¶é¤˜å°å¯«
            if (word.length > 0) {
                 return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }
            return word.toLowerCase();
        }

        function shuffleWordsG5(sentence) {
            const words = getSentenceTokens(sentence);
            
            // è¤‡è£½ä¸€ä»½ç”¨æ–¼æ‰“äº‚ï¼Œä¸¦åŠ å…¥ ID
            const scrambleArray = words.map(word => ({ id: crypto.randomUUID(), value: word, isUsed: false })); // ä¸å¼·åˆ¶å¤§å¯«
            
            // åƒ…æ‰“äº‚å–®å­—å’Œæ¨™é»ç¬¦è™Ÿçš„é †åº
            for (let i = scrambleArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [scrambleArray[i], scrambleArray[j]] = [scrambleArray[j], scrambleArray[i]];
            }
            return scrambleArray;
        }

        function initGame5() {
            const source = localData.g5_sentences;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢å•å¥ï¼", true); return; }

            state.g5_currentSentence = source[Math.floor(Math.random() * source.length)];
            
            // 1. ç”¢ç”Ÿäº‚åºè©å¡Š
            state.g5_scrambleBlocks = shuffleWordsG5(state.g5_currentSentence);
            
            // 2. åˆå§‹åŒ–ç­”æ¡ˆæ§½ä½ (æ•¸é‡ç­‰æ–¼è©å¡Šç¸½æ•¸)
            state.g5_currentSort = Array(state.g5_scrambleBlocks.length).fill(null); 
            state.g5_gameStatus = 'playing';

            renderGame5();
        }
        
        async function speakSentenceG5(sentence) { await callTTS(sentence); }

        function handleWordClickG5(id) {
            const wordBlock = state.g5_scrambleBlocks.find(l => l.id === id);
            if (!wordBlock || wordBlock.isUsed || state.g5_gameStatus !== 'playing') return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = { value: wordBlock.value, id: wordBlock.id };
                wordBlock.isUsed = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const item = state.g5_currentSort[index];
            if (!item || state.g5_gameStatus !== 'playing') return;

            // æ‰¾åˆ°è¢«ä½¿ç”¨çš„è©å¡Šï¼Œå°‡å…¶æ¨™è¨˜ç‚ºæœªä½¿ç”¨
            const originalBlock = state.g5_scrambleBlocks.find(l => l.id === item.id);
            if (originalBlock) originalBlock.isUsed = false;
            
            // å°‡å¾ŒçºŒçš„è©å¡Šå¾€å‰ç§»ï¼Œå¡«è£œç©ºä½
            for (let i = index; i < state.g5_currentSort.length - 1; i++) {
                state.g5_currentSort[i] = state.g5_currentSort[i + 1];
            }
            state.g5_currentSort[state.g5_currentSort.length - 1] = null;

            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            // --- åµéŒ¯ä¿®æ­£: ä½¿ç”¨è©å¡Šåºåˆ—æ¯”å° ---
            
            // 1. å–å¾—ç›®æ¨™ï¼ˆæ­£è¦ï¼‰çš„è©å¡Šåºåˆ— (Tokens)
            const targetTokens = getSentenceTokens(state.g5_currentSentence).map(t => t.toUpperCase());
            
            // 2. å–å¾—ç”¨æˆ¶æ’åˆ—çš„è©å¡Šåºåˆ—
            const currentTokens = state.g5_currentSort.map(item => item.value.toUpperCase());
            
            // 3. æ¯”è¼ƒåºåˆ—çš„é•·åº¦å’Œå…§å®¹
            let isCorrect = targetTokens.length === currentTokens.length;
            if (isCorrect) {
                for (let i = 0; i < targetTokens.length; i++) {
                    // ç¢ºä¿é€ä¸€æ¯”è¼ƒæ¯å€‹è©å¡Šï¼ˆåŒ…æ‹¬æ¨™é»ç¬¦è™Ÿï¼‰
                    if (targetTokens[i] !== currentTokens[i]) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            if (isCorrect) {
                state.g5_gameStatus = 'won';
                MessageBox.show("å¤ªæ£’äº†ï¼å¥å­é †åºå®Œå…¨æ­£ç¢ºï¼ğŸ‰", false);
                speakSentenceG5(state.g5_currentSentence); 
            } else {
                const slots = document.querySelectorAll('.answer-slot');
                slots.forEach(slot => {
                    slot.classList.add('incorrect');
                    setTimeout(() => slot.classList.remove('incorrect'), 500);
                });
                MessageBox.show("é †åºä¸æ­£ç¢ºï¼Œè«‹å†è©¦è©¦çœ‹ï¼", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((item, index) => {
                const isFilled = item !== null;
                let displayWord = 'ï¼ˆé»æ“Šè©å¡Šå¡«å…¥ï¼‰';
                
                if (isFilled) {
                     // æ‡‰ç”¨å¤§å°å¯«è¦å‰‡
                    displayWord = formatDisplayWord(item.value, index === 0);
                }
                
                return `
                    <div class="answer-slot ${isFilled ? 'filled bg-green-200 border-green-400' : ''}"
                         data-index="${index}">
                        ${displayWord}
                    </div>
                `;
            }).join('');

            const letterBlocksHtml = state.g5_scrambleBlocks.map(wordBlock => `
                <button data-id="${wordBlock.id}"
                        class="word-block ${wordBlock.isUsed ? 'used' : 'hover:bg-yellow-300'}"
                        ${wordBlock.isUsed || state.g5_gameStatus !== 'playing' ? 'disabled' : ''}>
                    ${formatDisplayWord(wordBlock.value)}
                </button>
            `).join('');
            
            // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
            setTimeout(() => {
                document.querySelectorAll('.word-block').forEach(btn => {
                    btn.addEventListener('click', () => handleWordClickG5(btn.dataset.id));
                });
                document.querySelectorAll('.answer-slot').forEach(slot => {
                    slot.addEventListener('click', () => handleResetTargetG5(parseInt(slot.dataset.index)));
                });
            }, 0);


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¬ å•å¥é‡çµ„å¤§å¸« (sentence scramble master)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ğŸ’¡ é»æ“Šè©å¡Šï¼Œé‡çµ„å¥å­çš„æ­£ç¢ºé †åºï¼</p>
                </section>
                
                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    <div class="text-center mb-6">
                        <button onclick="speakSentenceG5(state.g5_currentSentence)" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            ğŸ”Š æœ—è®€åŸå§‹å¥å­ (è½åŠ›è¼”åŠ©)
                        </button>
                    </div>

                    <div class="text-center mb-6 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300 w-full">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ç­”æ¡ˆå€ (é»æ“Šå·²å¡«å…¥è©å¡Šå¯ç§»é™¤)</h3>
                        <div class="g5-answer-display">
                            ${targetBoxesHtml}
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">è©å¡Šåº« (é»æ“Šå¡«å…¥)</h3>
                    <div class="flex flex-wrap justify-center p-2">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g5_gameStatus === 'won' ? 'å†ç©ä¸€æ¬¡' : 'æ›å€‹å¥å­'}
                        </button>
                    </div>
                </div>
            `;
        }
        // --- Game 5 End ---

        // --- Game 6: ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (Daily Routine Image Match) ---
        function initGame6() {
            const source = localData.g6_routines;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢æ—¥å¸¸æ´»å‹•ï¼", true); return; }

            // éš¨æ©Ÿé¸å– 4 å€‹é…å°
            const pairs = shuffleArray(source).slice(0, 4);
            
            state.g6_targets = pairs.map(p => ({ ...p, matched: false })); // åœ–ç‰‡ (Target)
            state.g6_sources = shuffleArray(pairs.map(p => ({ id: crypto.randomUUID(), word: p.word, isMatched: false }))); // å–®å­—å¡ (Source)
            state.g6_matches = 0;
            
            // å•Ÿç”¨æ‹–æ›³åŠŸèƒ½
            setupDragDropG6();

            renderGame6();
        }

        function setupDragDropG6() {
            let draggedItem = null;

            document.ondragstart = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    draggedItem = e.target.dataset.word;
                    e.dataTransfer.setData('text/plain', draggedItem);
                    e.target.classList.add('opacity-50');
                }
            };

            document.ondragend = (e) => {
                if (e.target.classList.contains('drag-source')) {
                    e.target.classList.remove('opacity-50');
                    draggedItem = null;
                }
            };

            document.ondragover = (e) => {
                const target = e.target.closest('.image-target');
                if (target) e.preventDefault();
            };

            document.ondrop = (e) => {
                const target = e.target.closest('.image-target');
                if (target && draggedItem) {
                    e.preventDefault();
                    
                    const targetWord = target.dataset.word; // åœ–ç‰‡çš„æ­£ç¢ºå–®å­—
                    const sourceWord = draggedItem; // æ‹–æ›³ä¾†æºçš„å–®å­—

                    if (sourceWord === targetWord) {
                        handleMatchG6(sourceWord, targetWord, target);
                    } else {
                        MessageBox.show('é…å°éŒ¯èª¤ï¼Œè«‹å†è©¦è©¦ï¼', true);
                    }
                }
            };
        }
        
        async function handleMatchG6(sourceWord, targetWord, targetElement) {
            state.g6_matches++;

            // 1. æ¨™è¨˜åœ–ç‰‡ç‚ºå·²é…å°
            const targetIndex = state.g6_targets.findIndex(t => t.word === targetWord);
            if (targetIndex !== -1) state.g6_targets[targetIndex].matched = true;

            // 2. ç§»é™¤ä¾†æºå¡ç‰‡
            state.g6_sources = state.g6_sources.filter(s => s.word !== sourceWord);

            // 3. æ›´æ–° UI
            renderGame6();
            
            // 4. çµ¦äºˆå›é¥‹ (ä¸ç™¼è²)
            targetElement.classList.add('border-green-600', 'bg-green-100');
            MessageBox.show('é…å°æˆåŠŸï¼ğŸ‰', false);

            if (state.g6_matches === state.g6_targets.length) {
                MessageBox.show('å¤ªæ£’äº†ï¼æ‰€æœ‰æ—¥å¸¸æ´»å‹•éƒ½é…å°æˆåŠŸï¼', false);
            }
        }


        function renderGame6() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game6') return;

            const targetsHtml = state.g6_targets.map(t => {
                const isMatched = t.matched;
                return `
                    <div id="target-${t.word.replace(/\s/g, '_')}" 
                         data-word="${t.word}" 
                         class="image-target ${isMatched ? 'border-green-600 bg-green-100' : 'border-primary-pink'} p-2">
                        <p class="text-5xl mb-2">${t.emoji}</p>
                        ${isMatched ? `<p class="text-lg font-bold text-green-700 item-name-display">${formatDisplayWord(t.word)}</p>` : ''}
                    </div>
                `;
            }).join('');

            const sourcesHtml = state.g6_sources.map(s => `
                <button draggable="true" data-word="${s.word}" class="drag-source key-btn bg-accent-yellow hover:bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-xl text-sm md:text-base">${formatDisplayWord(s.word)}</button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ¤¸ æ—¥å¸¸æ´»å‹•åœ–åƒé…å° (daily routine image match)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: å°‡ä¸‹æ–¹çš„å–®å­—å¡æ‹–æ›³åˆ°ä¸Šæ–¹å°æ‡‰çš„æ—¥å¸¸æ´»å‹•åœ–ç‰‡ä¸Šã€‚</p>
                </section>
                
                <div class="p-4 bg-white rounded-xl shadow-md border-4 border-gray-300 w-full">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        ${targetsHtml}
                    </div>
                </div>

                <div class="p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow w-full">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">æ‹–æ›³å–®å­—åº« (${state.g6_sources.length} å‰©é¤˜)</h3>
                    <div class="flex flex-wrap justify-center gap-3 drag-area">
                        ${sourcesHtml.length > 0 ? sourcesHtml : '<p class="text-lg font-bold text-green-700">å…¨éƒ¨å®Œæˆï¼</p>'}
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame6()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">é‡æ–°é–‹å§‹</button>
                </div>
            `;

            if (state.g6_sources.length > 0) setupDragDropG6();
        }
        // --- Game 6 End ---

        // --- Game 7: ğŸƒ èŠ±è²»è¨ˆç®—æ©Ÿ (Cost Calculator) ---
        
        // ------------------ è¨ˆç®—æ©Ÿæ ¸å¿ƒé‚è¼¯ -------------------
        function performCalculation(num1, num2, operator) {
            // ç¢ºä¿æ“ä½œæ•¸ç‚ºæµ®é»æ•¸ï¼Œä»¥è™•ç†é™¤æ³•å’Œå°æ•¸é»
            num1 = parseFloat(num1);
            num2 = parseFloat(num2);

            if (isNaN(num1) || isNaN(num2)) return 0;

            switch (operator) {
                case '+': return num1 + num2;
                case '-': return num1 - num2;
                case 'x': return num1 * num2;
                case '/': 
                    if (num2 === 0) {
                        MessageBox.show("é™¤æ•¸ä¸èƒ½ç‚ºé›¶ï¼", true);
                        return num1; // ä¿æŒåŸæ¨£
                    }
                    return num1 / num2;
                default: return num2;
            }
        }

        function handleCalcKey(key) {
            let calc = state.g7_calculator;
            let current = calc.currentValue;

            if (key >= '0' && key <= '9') {
                if (calc.resetDisplay) {
                    current = key;
                    calc.resetDisplay = false;
                } else if (calc.currentValue.length < 10) { // é™åˆ¶é¡¯ç¤ºé•·åº¦
                    current = current === '0' ? key : current + key;
                }
                calc.currentValue = current;
                calc.calcDisplay = current;

            } else if (key === '.') {
                if (!calc.currentValue.includes('.') && !calc.resetDisplay) {
                    calc.currentValue += '.';
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'C') {
                calc.currentValue = '0';
                calc.memory = 0;
                calc.operator = null;
                calc.resetDisplay = true;
                calc.calcDisplay = '0';
            } else if (key === 'DEL') {
                 if (calc.currentValue.length > 1) {
                    calc.currentValue = calc.currentValue.slice(0, -1);
                } else {
                    calc.currentValue = '0';
                }
                calc.calcDisplay = calc.currentValue;
                calc.resetDisplay = false;

            } else if (['+', '-', 'x', '/'].includes(key)) {
                if (calc.operator !== null && !calc.resetDisplay) {
                    // å¦‚æœé€£çºŒæŒ‰ä¸‹é‹ç®—ç¬¦ï¼Œå…ˆè¨ˆç®—å‰ä¸€å€‹
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                } else if (calc.operator === null) {
                    calc.memory = parseFloat(calc.currentValue);
                }
                calc.operator = key;
                calc.resetDisplay = true;
                calc.currentValue = calc.memory.toString(); // æ›´æ–° currentV ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                calc.calcDisplay = calc.currentValue;
            } else if (key === '=') {
                if (calc.operator !== null) {
                    calc.memory = performCalculation(calc.memory, parseFloat(calc.currentValue), calc.operator);
                    calc.currentValue = calc.memory.toString();
                    calc.operator = null; // é‡ç½®é‹ç®—ç¬¦
                    calc.resetDisplay = true;
                    calc.calcDisplay = calc.currentValue;
                }
            } else if (key === 'R') { // å”¸å‡ºé‡‘é¡æŒ‰éˆ•
                 const numToRead = parseInt(current);
                 if (!isNaN(numToRead) && numToRead > 0) {
                    const wordResult = numberToWords(numToRead) + " dollars";
                    MessageBox.show(`æœ—è®€é‡‘é¡: ${wordResult}`, false);
                    // ä¸åŸ·è¡Œ callTTS
                 } else {
                     MessageBox.show("è«‹å…ˆè¼¸å…¥é‡‘é¡ï¼", true);
                 }
                 state.g7_calculator = calc;
                 renderGame7();
                 return;
            }
            
            // æ›´æ–°ç‹€æ…‹ä¸¦æ¸²æŸ“
            state.g7_calculator = calc;
            renderGame7();
        }
        
        // ------------------ éŠæˆ²åˆå§‹åŒ–èˆ‡æª¢æŸ¥ -------------------

        function initGame7() {
            // 1. éš¨æ©Ÿé¸æ“‡ 2 åˆ° 3 å€‹ç‰©å“
            const numItems = Math.floor(Math.random() * 2) + 2; // 2 æˆ– 3
            const shuffledItems = shuffleArray(SHOP_ITEMS).slice(0, numItems);
            
            let total = 0;
            const items = shuffledItems.map(item => {
                // åƒ¹æ ¼åœ¨ $1 åˆ° $200 ä¹‹é–“ (ç¬¦åˆæ–°è¦æ±‚)
                const price = Math.floor(Math.random() * item.maxPrice) + 1; 
                total += price;
                return { ...item, price };
            });
            
            // ç¢ºä¿ç¸½é‡‘é¡ä¸è¶…é 999 (ç†è«–ä¸Šæœ€å¤§ç‚º 3 * 200 = 600)
            
            state.g7_items = items;
            state.g7_totalCost = total;
            state.g7_displayValue = ''; // ç”¨æ–¼é¡Œç›®ç­”æ¡ˆè¼¸å…¥
            
            state.g7_calculator = { // é‡ç½®è¨ˆç®—æ©Ÿ
                currentValue: '0',
                memory: 0,
                operator: null,
                resetDisplay: true,
                calcDisplay: '0'
            };
            
            state.g7_gameStatus = 'entering'; 
            renderGame7();
        }


        function checkAnswerG7() {
            if (state.g7_gameStatus !== 'entering') return;
            
            // é¡Œç›®ç­”æ¡ˆè¼¸å…¥æ¡†çš„å€¼
            const enteredValue = parseInt(state.g7_displayValue);
            const expectedValue = state.g7_totalCost;

            if (isNaN(enteredValue) || enteredValue < 1) {
                MessageBox.show("è«‹è¼¸å…¥æ‚¨è¨ˆç®—å‡ºçš„ç¸½é‡‘é¡ï¼", true);
                return;
            }
            
            // æª¢æŸ¥é‡‘é¡æ˜¯å¦åœ¨ç™¾ä½æ•¸ç¯„åœå…§
            if (expectedValue > 999) {
                 MessageBox.show("è­¦å‘Šï¼šç¸½é‡‘é¡è¶…é $999ã€‚è«‹å°ˆæ³¨æ–¼é‡‘é¡çš„è‹±æ–‡è¡¨é”ã€‚", false);
            }
            
            // æå–è‹±æ–‡å–®å­—ç­”æ¡ˆ
            const expectedWords = numberToWords(expectedValue) + " dollars";
            const enteredWords = numberToWords(enteredValue) + " dollars";
            
            // æ¯”å°æ•¸å­—
            if (enteredValue === expectedValue) {
                state.g7_gameStatus = 'won';
                MessageBox.show(`å¤ªæ£’äº†ï¼ç¸½é‡‘é¡æ˜¯ $${expectedValue}.00ï¼ğŸ‰ (It's ${expectedWords})`, false);
            } else {
                state.g7_gameStatus = 'entering'; // å…è¨±ç¹¼çºŒå˜—è©¦
                MessageBox.show(`ä¸å°å“¦ï¼Œæ‚¨è¼¸å…¥çš„é‡‘é¡æ˜¯ $${enteredValue}ã€‚æ­£ç¢ºé‡‘é¡æ˜¯ ${numberToWords(expectedValue)} dollarsã€‚å†è©¦ä¸€æ¬¡è¨ˆç®—å§ï¼`, true);
                document.getElementById('answer-input-g7').classList.add('border-red-500');
                setTimeout(() => document.getElementById('answer-input-g7').classList.remove('border-red-500'), 500);
            }
            renderGame7();
        }

        function renderGame7() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game7') return;

            const calc = state.g7_calculator;
            const currentInputValue = state.g7_displayValue;
            
            // é¡Œç›®åˆ—è¡¨
            const itemsHtml = state.g7_items.map((item) => `
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-2">
                    <span class="text-xl">${item.emoji} <span class="item-name-display">${formatDisplayWord(item.name)}</span></span>
                    <span class="text-xl font-bold text-red-600">$${item.price}</span>
                </div>
            `).join('');

            // æ ¼å¼åŒ–è¨ˆç®—æ©Ÿé¡¯ç¤º
            const formattedCalcDisplay = parseFloat(calc.calcDisplay).toLocaleString('en-US', {
                 maximumFractionDigits: 2
            });

            // æç¤ºæ¬„ (å¥é¦–å¤§å¯«)
            const costPrompt = state.g7_gameStatus === 'won' 
                ? formatDisplayWord(`it's ${numberToWords(state.g7_totalCost)} dollars`, true) 
                : formatDisplayWord("how much is it?", true);
            
            // è¨ˆç®—æ©ŸæŒ‰éˆ•
            const calcButtons = [
                'C', 'DEL', '/', 'x',
                '7', '8', '9', '-',
                '4', '5', '6', '+',
                '1', '2', '3', '=',
                '0', '.', 'R', '=' // R for Read (å”¸å‡ºè¼¸å…¥é‡‘é¡)
            ];

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’° èŠ±è²»è¨ˆç®—æ©Ÿ (cost calculator)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: ä½¿ç”¨è¨ˆç®—æ©Ÿè¨ˆç®—ç¸½é‡‘é¡ï¼Œç„¶å¾Œå°‡æ•¸å­—ç­”æ¡ˆè¼¸å…¥åˆ°ä¸‹æ–¹æ¬„ä½ã€‚</p>
                </section>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- ç‰©å“æ¸…å–® -->
                    <div class="md:col-span-2 p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow">
                        <h3 class="text-2xl font-bold text-gray-800 mb-3">ğŸ›’ shopping list</h3>
                        ${itemsHtml}
                        <div class="flex justify-end mt-4 pt-4 border-t-2 border-gray-300">
                            <span class="text-2xl font-extrabold text-blue-700">total: ??</span>
                        </div>
                    </div>

                    <!-- è¨ˆç®—æ©Ÿ -->
                    <div class="md:col-span-1 w-full max-w-xs mx-auto">
                        <div class="calc-display mb-4 text-4xl">
                            ${formattedCalcDisplay}
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${calcButtons.map(key => {
                                let keyClass = 'calc-key-number';
                                if (['C', 'DEL'].includes(key)) keyClass = 'calc-key-clear';
                                else if (['+', '-', 'x', '/', 'R', '='].includes(key)) {
                                    keyClass = key === '=' ? 'calc-key-equal' : 'calc-key-operator';
                                }

                                return `
                                    <button onclick="handleCalcKey('${key}')" 
                                            class="calc-key ${keyClass} rounded-xl shadow-cute ${key === '=' ? 'row-span-2' : ''}"
                                            style="${key === '=' ? 'grid-row-end: span 2;' : ''}">
                                        ${key === 'x' ? 'x' : key === '/' ? 'Ã·' : key === 'R' ? 'ğŸ”Š' : key}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <!-- ç­”æ¡ˆå’Œæœ—è®€å€ -->
                <div class="p-6 bg-white rounded-xl shadow-md border-4 border-primary-pink">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">â“ ${formatDisplayWord("how much is it?", true)}</h3>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="answer-input-g7" 
                               value="${currentInputValue}"
                               oninput="state.g7_displayValue = this.value.slice(0, 3);"
                               maxlength="3"
                               placeholder="è¼¸å…¥æ•¸å­— (0-999)" 
                               class="text-3xl p-3 border-4 border-secondary-blue rounded-lg text-center w-32 font-bold focus:border-blue-500">
                        
                        <button onclick="checkAnswerG7()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl">
                            âœ… æª¢æŸ¥ç­”æ¡ˆ
                        </button>
                        
                        <p class="text-3xl font-extrabold text-pink-600 item-name-display">${costPrompt}</p>
                    </div>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="initGame7()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                        ğŸ”„ é‡æ–°é–‹å§‹/æ›é¡Œç›®
                    </button>
                </div>
            `;
            
            // æ¯æ¬¡æ¸²æŸ“å¾Œç¢ºä¿è¼¸å…¥æ¡†èˆ‡ç‹€æ…‹åŒæ­¥
            const inputElement = document.getElementById('answer-input-g7');
            if (inputElement) {
                inputElement.value = currentInputValue;
                if (state.g7_gameStatus === 'won') inputElement.disabled = true;
                else inputElement.disabled = false;
            }
            
        }
        // --- Game 7 End ---

        // --- Game 8: ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (Digraph Blaster) ---
        function initGame8() {
            const source = localData.g8_digraphs;
            if (source.length === 0) { MessageBox.show("è«‹åœ¨å¾Œå°æ–°å¢ digraph å–®å­—ï¼", true); return; }

            state.g8_currentWord = shuffleArray(source)[0];
            state.g8_gameStatus = 'playing';
            state.g8_score = 0; // é‡ç½®åˆ†æ•¸
            
            // æ¯æ¬¡å‡ºé¡Œæ™‚è‡ªå‹•æœ—è®€ä¸€æ¬¡
            callTTS(state.g8_currentWord.full); // æ¢å¾© Game 8 è²éŸ³

            renderGame8();
        }
        
        async function handleDigraphClickG8(digraph) {
            if (state.g8_gameStatus !== 'playing') return;

            if (digraph === state.g8_currentWord.digraph) {
                state.g8_score++;
                MessageBox.show('æ­£ç¢ºï¼ç™¼å°„æˆåŠŸï¼ğŸ’¥', false);
                
                // å»¶é²æ›é¡Œ
                setTimeout(() => {
                    const available = localData.g8_digraphs.filter(w => w.full !== state.g8_currentWord.full);
                    if (available.length > 0) {
                        state.g8_currentWord = shuffleArray(available)[0];
                        callTTS(state.g8_currentWord.full); // æ–°é¡Œç›®æœ—è®€
                    } else {
                        state.g8_currentWord = { digraph: 'ALL', word: 'DONE', full: 'ALL DONE' };
                        state.g8_gameStatus = 'won';
                    }
                    renderGame8();
                }, 1500);

            } else {
                state.g8_score = Math.max(0, state.g8_score - 1); // æ‰£åˆ†
                MessageBox.show('éŒ¯èª¤ï¼ç™¼å°„å¤±æ•—ï¼å†è©¦è©¦å…¶ä»–çµ„åˆã€‚', true);
                
                // éŒ¯èª¤æ™‚ï¼Œä¸æœ—è®€ï¼Œä½†ä¿æŒç•¶å‰é¡Œç›®
            }
            renderGame8();
        }

        function renderGame8() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game8') return;

            const wordBlock = state.g8_currentWord;
            const blanks = wordBlock.word.includes('_') ? wordBlock.word.split('_') : ['', ''];
            
            const allDigraphs = [...new Set(localData.g8_digraphs.map(d => d.digraph))];
            const digraphButtons = shuffleArray(allDigraphs).map(d => `
                <button onclick="handleDigraphClickG8('${d}')"
                        class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-3xl font-bold text-white rounded-xl transition duration-150">
                    ${formatDisplayWord(d)}
                </button>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ’¥ ç¥å¥‡ç™¼éŸ³æ©Ÿ (digraph blaster)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: é»æ“Šæ­£ç¢ºçš„è¼”éŸ³å­—æ¯çµ„åˆ (${allDigraphs.map(d => formatDisplayWord(d)).join(', ')}) ä¾†å®Œæˆå–®å­—ï¼</p>
                </section>
                
                <div class="text-center text-2xl font-bold text-gray-700 mb-4">åˆ†æ•¸: ${state.g8_score}</div>

                ${state.g8_gameStatus !== 'won' ? `
                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow flex flex-col items-center">
                    
                    <div class="flex flex-col items-center justify-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">é»æ“Šå–‡å­è½å–å–®å­—ç™¼éŸ³:</h3>
                        
                        <div class="flex items-center justify-center space-x-4">
                            <div class="digraph-display-box flex items-center justify-center space-x-2 shadow-lg">
                                <span class="digraph-letter-part">${formatDisplayWord(blanks[0])}</span>
                                <div class="digraph-blank">?</div>
                                <span class="digraph-letter-part">${formatDisplayWord(blanks[1])}</span>
                            </div>
                            <button onclick="callTTS(state.g8_currentWord.full)" 
                                    class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-200"
                                    title="æœ—è®€å–®å­—">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2V15H6L11 19V5ZM19.5 12C19.5 14.3283 18.0792 16.3262 16 17.2025V6.7975C18.0792 7.67384 19.5 9.67174 19.5 12ZM16 13C16.8284 13 17.5 12.3284 17.5 11.5C17.5 10.6716 16.8284 10 16 10V13Z"/></svg>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 w-full max-w-lg">
                        ${digraphButtons}
                    </div>
                </div>
                ` : `<p class="text-4xl font-black text-green-700 p-10">æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰æŒ‘æˆ°ï¼ç¸½åˆ† ${state.g8_score}ï¼</p>`}
                
                <div class="text-center mt-6">
                    <button onclick="initGame8()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">é‡æ–°é–‹å§‹</button>
                </div>
            `;
        }
        // --- Game 8 End ---

        // --- AI Image Generation Function (NOW SIMULATED EMOJI GENERATION) ---
        // ç§»é™¤æ‰€æœ‰ Imagen API å‘¼å«ï¼Œè½‰ç‚º Emoji æå–é‚è¼¯
        async function generateEmojiAndAddWord(key, wordPhrase) {
            const addButton = document.getElementById('admin-add-button');
            const originalButtonText = addButton ? 'âœ¨ è‡ªå‹•ç”Ÿæˆ Emoji ä¸¦æ–°å¢' : 'æ–°å¢';

            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<span class="animate-spin mr-2">&#9696;</span> æå– Emoji ä¸­...';
            }
            
            // æ¨¡æ“¬ç”Ÿæˆ/æå–
            await new Promise(resolve => setTimeout(resolve, 500)); 

            const newEmoji = generateEmojiFromWord(wordPhrase);
            const newId = crypto.randomUUID();
            let newEntry = null;

            if (key === 'g6_routines') {
                newEntry = { id: newId, word: wordPhrase, emoji: newEmoji, url: `https://placehold.co/150x120/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}` };
                localData[key].push(newEntry);
            } else if (key === 'g7_verbs') {
                newEntry = { id: newId, fullSentence: wordPhrase, emoji: newEmoji, url: `https://placehold.co/150x120/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${wordPhrase.replace(/\s/g, '+')}` };
                localData[key].push(newEntry);
            }

            if (newEntry) {
                saveWordsToLocal();
                MessageBox.show(`Emoji æå–ä¸¦æ–°å¢è©å½™æˆåŠŸï¼Emoji: ${newEmoji}`, false);
                
                // æ¸…ç©ºè¼¸å…¥æ¬„ä½ä¸¦é‡æ–°æ¸²æŸ“
                document.getElementById('admin-input-1').value = '';
                document.getElementById('admin-input-2').value = '';
                renderWordAdmin();
            } else {
                MessageBox.show("Emoji æå–å¤±æ•—ã€‚", true);
            }
        }

        // --- Admin Panel ---
        const ADMIN_TABS = [
            { key: 'g2_words', name: 'ğŸ¶ Phonics é…å°', isObjectArray: true, hasMultiInput: true },
            { key: 'g3_words', name: 'ğŸ–ï¸ Hangman', isObjectArray: false, hasMultiInput: false },
            { key: 'g4_bingo_words', name: 'ğŸ¤ è³“æœå–®å­—', isObjectArray: false, hasMultiInput: false },
            { key: 'g5_sentences', name: 'ğŸ’¬ å•å¥é‡çµ„', isObjectArray: false, hasMultiInput: false },
            { key: 'g6_routines', name: 'ğŸ¤¸ æ—¥å¸¸æ´»å‹•', isObjectArray: true, hasMultiInput: false },
            // ç§»é™¤ g7_verbs çš„ç®¡ç†å€å¡Š
            { key: 'g8_digraphs', name: 'ğŸ’¥ ç™¼éŸ³æ©Ÿ', isObjectArray: true, hasMultiInput: true }, // Digraphs has multi input
        ];
        let currentAdminKey = ADMIN_TABS[0].key;

        function getCurrentAdminTab() {
            return ADMIN_TABS.find(t => t.key === currentAdminKey);
        }
        
        // ä¿®æ­£å¾Œçš„ handleBulkAdd å‡½æ•¸
        function handleBulkAdd(inputElement, isObjectArray) {
            const inputContent = inputElement.value.trim();
            if (!inputContent) return;

            const lines = inputContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            let addedCount = 0;
            let currentList = localData[currentAdminKey];

            lines.forEach(line => {
                let newEntry = null;

                if (!isObjectArray) {
                    // å°æ–¼ç°¡å–®å­—ä¸²é™£åˆ— (Hangman, Bingo, å•å¥é‡çµ„)
                    const normalizedEntry = line; // ä¸å†å¼·åˆ¶å¤§å¯«
                    // æª¢æŸ¥é‡è¤‡
                    if (!currentList.includes(normalizedEntry)) {
                        newEntry = normalizedEntry;
                    }
                } else {
                    // å°æ–¼ Phonics æˆ– Digraphs çš„ç°¡å–®æ‰¹é‡æ·»åŠ ï¼šå‡è¨­è¼¸å…¥æ ¼å¼ç‚ºï¼šVALUE1,VALUE2,VALUE3
                    const values = line.split(',').map(v => v.trim()); // ä¸å¼·åˆ¶å¤§å¯«ï¼Œä¿æŒåŸå§‹è¼¸å…¥
                    const newId = crypto.randomUUID();

                    if (currentAdminKey === 'g2_words' && values.length >= 2) {
                        newEntry = { id: newId, phonics: values[0], word: values[1], hint: values[2] || '' };
                    } else if (currentAdminKey === 'g8_digraphs' && values.length >= 3) {
                        newEntry = { id: newId, digraph: values[0], word: values[1], full: values[2] };
                    }
                    
                    // ç”±æ–¼æ‰¹é‡æ·»åŠ è¤‡é›œå°è±¡å®¹æ˜“å‡ºéŒ¯ï¼Œæˆ‘å€‘åªæ”¯æŒå–®è¡Œæ·»åŠ ï¼Œå› æ­¤é€™éƒ¨åˆ†ä»£ç¢¼ä¿æŒå–®æ¬¡æ·»åŠ é‚è¼¯
                    // å¦‚æœéœ€è¦è¤‡é›œæ‰¹é‡æ·»åŠ ï¼Œå»ºè­°ä½¿ç”¨å°ˆé–€çš„ CSV/JSON å°å…¥åŠŸèƒ½ï¼Œé€™è£¡ä¸å¯¦ç¾è¤‡é›œè§£æã€‚
                    
                }
                
                if (newEntry) {
                    currentList.push(newEntry);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveWordsToLocal(); 
                MessageBox.show(`æˆåŠŸæ–°å¢ ${addedCount} å€‹è©å½™ï¼`, false);
                inputElement.value = ''; // æ¸…ç©ºè¼¸å…¥
                renderWordAdmin();
            } else if (!isObjectArray) {
                 MessageBox.show("è«‹æª¢æŸ¥è¼¸å…¥å…§å®¹æ˜¯å¦ç‚ºæ–°è©å½™æˆ–æ˜¯å¦å¡«å¯«æ­£ç¢ºã€‚", true);
            }
        }


        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const currentList = localData[currentAdminKey] || [];
            const currentTab = getCurrentAdminTab();
            
            // æ ¹æ“šé¡å‹èª¿æ•´è¼¸å…¥æ¬„ä½
            let inputField = '';
            let addButtonText = 'â• æ–°å¢';

            if (currentAdminKey === 'g2_words') {
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ‰¹é‡æ–°å¢ï¼šè«‹åœ¨ç¬¬ä¸€å€‹æ¬„ä½è¼¸å…¥ï¼Œä½¿ç”¨é€—è™Ÿåˆ†éš” (Phonics,Word,Hint)ã€‚**æ³¨æ„ï¼šè«‹ç”¨å¤§å¯«è¼¸å…¥ä¾†å¼·èª¿å–®å­—ã€‚**</p>
                    <textarea id="admin-input-1" placeholder="Phonics çµ„åˆ, å°æ‡‰å–®å­—, ä¸­æ–‡æç¤º (æ¯è¡Œä¸€å€‹è©å½™)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            } else if (currentAdminKey === 'g8_digraphs') {
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ‰¹é‡æ–°å¢ï¼šè«‹åœ¨ç¬¬ä¸€å€‹æ¬„ä½è¼¸å…¥ï¼Œä½¿ç”¨é€—è™Ÿåˆ†éš” (Digraphs,Incomplete,Full Word)ã€‚**æ³¨æ„ï¼šè«‹ç”¨å¤§å¯«è¼¸å…¥ä¾†å¼·èª¿å–®å­—ã€‚**</p>
                    <textarea id="admin-input-1" placeholder="Digraphs, ä¸å®Œæ•´å–®å­—, å®Œæ•´å–®å­— (æ¯è¡Œä¸€å€‹è©å½™)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            } else if (currentAdminKey === 'g6_routines') {
                // æ—¥å¸¸æ´»å‹•
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ—¥å¸¸æ´»å‹•: å®Œæ•´çš„å‹•è©ç‰‡èª (WASH MY FACE)ã€‚**æ³¨æ„ï¼šè«‹ç”¨å¤§å¯«è¼¸å…¥ä¾†å¼·èª¿å–®å­—ã€‚**</p>
                    <input type="text" id="admin-input-1" placeholder="è‹±æ–‡ç‰‡èª/å‹•ä½œ (å¦‚: BRUSH TEETH)" maxlength="30" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase flex-1">
                    <input type="text" id="admin-input-2" placeholder="åœ–ç‰‡URL (ç•™ç©ºå‰‡è‡ªå‹•ç”ŸæˆEmoji)" maxlength="100" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue flex-1">
                `;
                addButtonText = isGeneratingImage ? addButtonText : 'âœ¨ è‡ªå‹•ç”Ÿæˆ Emoji ä¸¦æ–°å¢';
            } else if (currentAdminKey === 'g7_verbs') {
                 // å‹•è©é€£é€£çœ‹ (ç¾åœ¨æ˜¯è¨ˆç®—æ©Ÿï¼Œæ‰€ä»¥é€™å€‹é é¢ä¸æ‡‰è©²å‡ºç¾)
                 inputField = `<p class="text-lg text-gray-700 w-full text-center">éŠæˆ²å·²æ›´æ”¹ç‚º **èŠ±è²»è¨ˆç®—æ©Ÿ**ï¼Œæ­¤é é¢ä¸å†éœ€è¦ç®¡ç†è©å½™ã€‚</p>`;
                 addButtonText = 'N/A';
            } else {
                // é©ç”¨æ–¼ G3, G4, G5 çš„æ‰¹é‡æ–°å¢
                inputField = `
                    <p class="text-xs text-red-600 mb-1 w-full text-left">ğŸ’¡ æ‰¹é‡æ–°å¢ï¼šæ¯å€‹å–®å­—/å¥å­ä¸€è¡Œï¼ŒæŒ‰ Enter éµæ›è¡Œå³å¯ã€‚**æ³¨æ„ï¼šè«‹ç”¨å¤§å¯«è¼¸å…¥ä¾†å¼·èª¿å–®å­—ã€‚**</p>
                    <textarea id="admin-input-1" placeholder="å–®å­—æˆ–å®Œæ•´å¥å­ (æ¯è¡Œä¸€å€‹è©å½™)" class="p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue w-full resize-y h-24"></textarea>
                `;
            }

            const wordListHtml = currentList.map((item, index) => {
                let display;
                let deleteId;

                if (currentTab.isObjectArray) {
                    // Object Array: Use item.id for deletion
                    // ç‰¹æ®Šè™•ç† G6/G7 é¡¯ç¤º Emoji
                    if (currentAdminKey === 'g6_routines') {
                        const verb = item.word || item.verb;
                        const emoji = item.emoji || '';
                        display = `${emoji} / ${formatDisplayWord(verb)} / URL:${item.url.substring(0, 30)}...`;
                    } else if (currentAdminKey === 'g7_verbs') {
                         const sentence = item.fullSentence;
                        const verbParticiple = extractVerbParticiple(sentence);
                        const emoji = item.emoji || '';
                        // åˆªé™¤ G7 Admin çš„é¡¯ç¤ºï¼Œå› ç‚ºå®ƒç¾åœ¨æ˜¯è¨ˆç®—æ©Ÿ
                        return ''; 
                    } else {
                        // Phonics/Digraphs æ ¹æ“šåŸå§‹å„²å­˜ç‹€æ…‹é¡¯ç¤º
                        display = JSON.stringify(item);
                        if (item.phonics) display = `Phonics: ${formatDisplayWord(item.phonics)}, Word: ${formatDisplayWord(item.word)}`;
                        if (item.digraph) display = `Digraph: ${formatDisplayWord(item.digraph)}, Full: ${formatDisplayWord(item.full)}`;
                    }
                    deleteId = item.id;
                } else {
                    // Simple String Array: Filter by Index
                    display = formatDisplayWord(item);
                    deleteId = index;
                }

                return `
                    <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                        <span class="text-sm md:text-lg font-bold text-gray-800">${index + 1}. ${display}</span>
                        <button onclick="deleteWordAdmin('${deleteId}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    </li>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">âš™ï¸ å–®å­—/è¨­å®šç®¡ç†å¾Œå° (local storage admin panel)</h2>
                    <p class="text-center text-sm text-pink-100">ğŸ’¡ é€™è£¡çš„å–®å­—åƒ…å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ä¸­ã€‚</p>
                </section>
                
                <div class="flex flex-wrap justify-center space-x-1 mb-4">
                    ${ADMIN_TABS.map(tab => `
                        <button onclick="setCurrentAdminKey('${tab.key}')" class="tab-btn py-2 px-3 ${currentAdminKey === tab.key ? 'bg-secondary-blue text-blue-900 shadow-lg' : 'bg-gray-100 text-gray-700'}">
                            ${tab.name}
                        </button>
                    `).join('')}
                </div>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <label for="admin-input-1" class="block text-lg font-semibold text-gray-800 mb-2">æ–°å¢ ${currentTab.name} è©å½™</label>
                    <div class="flex space-x-2 flex-wrap">
                        ${inputField}
                        ${currentAdminKey !== 'g7_verbs' ? `<button id="admin-add-button" onclick="addWordAdmin()" 
                                class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150"
                                ${isGeneratingImage ? 'disabled' : ''}>
                            ${addButtonText}
                        </button>` : ''}
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${currentTab.name} åˆ—è¡¨ (${currentList.length} å€‹)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${currentList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰è©å½™ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                    <p class="text-xs text-gray-400 mt-4 text-center">æ‚¨çš„è¨­å®šå·²è‡ªå‹•å„²å­˜ã€‚</p>
                </div>
            `;
        }
        
        function setCurrentAdminKey(key) {
            currentAdminKey = key;
            // ä¿®æ­£ï¼šå¦‚æœåˆ‡æ›åˆ° G7 å‰‡ç›´æ¥æ¸²æŸ“ï¼Œè·³é Admin æ¸²æŸ“
            if (key === 'g7_verbs') {
                initGame7();
            } else {
                renderWordAdmin();
            }
        }

        function addWordAdmin() {
            if (isGeneratingImage) return;

            const currentTab = getCurrentAdminTab();

            // å°æ–¼éç‰©ä»¶é™£åˆ—ï¼ˆå–®ç´”çš„å–®å­—æˆ–å¥å­ï¼‰ï¼šè™•ç†æ‰¹é‡æ·»åŠ 
            if (!currentTab.isObjectArray) {
                const inputElement = document.getElementById('admin-input-1');
                const inputContent = inputElement ? inputElement.value.trim() : '';
                
                if (!inputContent) {
                    MessageBox.show("è«‹è¼¸å…¥è©å½™å…§å®¹ï¼", true);
                    return;
                }
                
                handleBulkAdd(inputElement, false);
                return;
            }
            
            // å°æ–¼ç‰©ä»¶é™£åˆ—ï¼šåªæ”¯æŒå–®ç¨æ·»åŠ æˆ–æ‰¹é‡å°è±¡ï¼ˆå·²ç°¡åŒ–ç‚ºåªè™•ç†å–®ç¨æ·»åŠ ä»¥é¿å…è¤‡é›œæ€§ï¼‰
            const input1 = document.getElementById('admin-input-1')?.value.trim(); // ä¿æŒåŸå§‹è¼¸å…¥å¤§å°å¯«
            const input2 = document.getElementById('admin-input-2')?.value.trim(); // URL/å°æ‡‰å–®å­—

            let newEntry = null;

            // --- åœ–ç‰‡éŠæˆ²çš„ Emoji æå–/Placeholder é‚è¼¯ ---
            const isImageGame = currentAdminKey === 'g6_routines' || currentAdminKey === 'g7_verbs';
            
            if (isImageGame) {
                if (!input1) { MessageBox.show("è«‹å¡«å¯«è‹±æ–‡ç‰‡èª/å‹•ä½œï¼", true); return; }
                
                // 1. è‡ªå‹•æå– Emoji (ä½¿ç”¨å®Œæ•´çš„å¥å­)
                const newEmoji = generateEmojiFromWord(input1);
                
                // 2. ç¢ºå®š URL (å¦‚æœ input2 æ˜¯ç©ºçš„ï¼Œå‰‡ç”Ÿæˆä¸€å€‹éš¨æ©Ÿé¡è‰²çš„ Placeholder)
                let finalUrl = input2;
                if (!finalUrl) {
                    const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    finalUrl = `https://placehold.co/150x120/${randomColor}/ffffff?text=${input1.replace(/\s/g, '+')}`;
                }

                const newId = crypto.randomUUID();

                if (currentAdminKey === 'g6_routines') {
                    newEntry = { id: newId, word: input1, emoji: newEmoji, url: finalUrl };
                } else if (currentAdminKey === 'g7_verbs') {
                    // G7: å„²å­˜æ•´å€‹å¥å­ï¼Œä¸¦ç”¨å®Œæ•´çš„å¥å­ä¾†ç”Ÿæˆ Emoji
                    const verbParticiple = extractVerbParticiple(input1.toUpperCase()); // å¿…é ˆç”¨å¤§å¯«æª¢æŸ¥ ing
                    if (!verbParticiple) {
                         MessageBox.show("å‹•è©é€£é€£çœ‹å¥å­æ ¼å¼éŒ¯èª¤ï¼šè«‹ç¢ºä¿å¥å­æœ€å¾Œä¸€å€‹è©æ˜¯å‹•è© ing å½¢å¼ã€‚", true); return;
                    }
                    newEntry = { id: newId, fullSentence: input1, emoji: newEmoji, url: finalUrl };
                }
                
            } else if (currentAdminKey === 'g2_words') {
                // Phonics é…å°ï¼šå–®è¡Œè¼¸å…¥ (Phonics, Word, Hint)
                const line = input1;
                const hint = input2;
                if (!line) { MessageBox.show("è«‹è¼¸å…¥ Phonics è©å½™å…§å®¹ï¼", true); return; }
                const values = line.split(',').map(v => v.trim()); // ä¸å†å¼·åˆ¶å¤§å¯«
                if (values.length >= 2) {
                    newEntry = { id: crypto.randomUUID(), phonics: values[0], word: values[1], hint: values[2] || '' };
                } else {
                     MessageBox.show("Phonics é…å°æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦ Phonics å’Œ Word (ä¾‹å¦‚: IE,PIE,ç¾å‘³çš„æ´¾)", true); return;
                }
            } else if (currentAdminKey === 'g8_digraphs') {
                // Digraphsï¼šå–®è¡Œè¼¸å…¥ (Digraphs, Incomplete, Full Word)
                 const line = input1;
                if (!line) { MessageBox.show("è«‹è¼¸å…¥ Digraphs è©å½™å…§å®¹ï¼", true); return; }
                const values = line.split(',').map(v => v.trim()); // ä¸å†å¼·åˆ¶å¤§å¯«
                if (values.length >= 3) {
                     newEntry = { id: crypto.randomUUID(), digraph: values[0], word: values[1], full: values[2] };
                } else {
                     MessageBox.show("Digraphs æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦ Digraphs, Incomplete, Full Word (ä¾‹å¦‚: SH,_OP,SHOP)", true); return;
                }
            }
            
            if (!newEntry) { 
                 // å¦‚æœæ˜¯éåœ–ç‰‡éŠæˆ²ï¼Œä½†æ ¼å¼ä¸å°ï¼Œå‰é¢å·²ç¶“å ±éŒ¯ã€‚é€™è£¡åªæ˜¯é˜²æ­¢æ„å¤–ã€‚
                 if (!isImageGame) return; 
                 MessageBox.show("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦çš„æ¬„ä½ï¼", true); return; 
            }

            // æª¢æŸ¥é‡è¤‡ (å°æ–¼ç‰©ä»¶é™£åˆ—)
            const list = localData[currentAdminKey];
            if (currentTab.isObjectArray && list.some(item => (item.word || item.fullSentence || item.full) === (newEntry.word || newEntry.fullSentence || newEntry.full))) {
                 MessageBox.show("è©å½™å·²å­˜åœ¨ï¼", true); return;
            }


            localData[currentAdminKey].push(newEntry);
            saveWordsToLocal();
            MessageBox.show(`è©å½™æ–°å¢æˆåŠŸï¼`, false);
            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            document.getElementById('admin-input-1').value = '';
            if (document.getElementById('admin-input-2')) document.getElementById('admin-input-2').value = '';
            if (document.getElementById('admin-input-3')) document.getElementById('admin-input-3').value = '';
            renderWordAdmin();
        }

        function deleteWordAdmin(id) {
            if (isGeneratingImage) {
                MessageBox.show("åœ–ç‰‡ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true);
                return;
            }
            
            const currentTab = getCurrentAdminTab();
            const list = localData[currentAdminKey];

            if (currentTab.isObjectArray) {
                // Object Array: Filter by ID
                localData[currentAdminKey] = list.filter(item => item.id !== id);
            } else {
                // Simple String Array: Filter by Index
                const indexToDelete = parseInt(id);
                if (!isNaN(indexToDelete) && indexToDelete >= 0 && indexToDelete < list.length) {
                    localData[currentAdminKey].splice(indexToDelete, 1);
                }
            }
            
            saveWordsToLocal(); // ä¿®æ­£: å‘¼å«æ­£ç¢ºçš„å„²å­˜å‡½æ•¸
            MessageBox.show("è©å½™åˆªé™¤æˆåŠŸï¼", false);
            renderWordAdmin();
        }
        // --- Admin Panel End ---
    </script>
</body>
</html>
